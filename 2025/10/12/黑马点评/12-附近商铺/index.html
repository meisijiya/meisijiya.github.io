<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="è€æ±Ÿæ¹–">


    <meta name="subtitle" content="è®°å½•è¿›å…¥æˆ¿é—´é—¨åçš„ç¾å¥½">


    <meta name="description" content="ä¸€å¹´å‰ï¼Œå­¤è‹¦ä¼¶ä»ƒçš„è€æ±Ÿæ¹–ï¼Œå¶ç„¶é—´å‘ç°ä¸€å¤„æˆ¿é—´é—¨ï¼Œæ¨é—¨è€Œå…¥ï¼Œä»æ­¤è¿›å…¥äº†å……æ»¡å¹¸ç¦çš„ä¸–ç•Œã€‚">


    <meta name="keywords" content="è€æ±Ÿæ¹–,åšå®¢,æˆ¿é—´é—¨">


<title>12-é™„è¿‘å•†é“º | æ¬¢è¿æ¥åˆ°è€æ±Ÿæ¹–çš„åšå®¢</title>



    <link rel="icon" href="/images/%E9%87%91%E6%AF%9B.png?_t=1758006391547">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    
    <link rel="stylesheet" href="/css/search.css">
    

<!-- highlight.js æ ·å¼ï¼ˆé»˜è®¤äº®è‰²ï¼‰ -->
<link id="hljs-theme" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.css">
<!-- highlight.js è‡ªåŠ¨ä¸Šè‰²åŠŸèƒ½ -->
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

<link rel="stylesheet" href="/css/custom.css">



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const pagebody = document.getElementsByTagName('body')[0]

            function setTheme(status) {

                if (status === 'dark') {
                    window.sessionStorage.theme = 'dark'
                    pagebody.classList.add('dark-theme');

                } else if (status === 'light') {
                    window.sessionStorage.theme = 'light'
                    pagebody.classList.remove('dark-theme');
                }
            };

            setTheme(window.sessionStorage.theme)
        })();
    </script>

    <div class="wrapper">
        <header>
  <nav class="navbar">
    <div class="container">
      <div class="navbar-header header-logo">
        <a href="/">è€æ±Ÿæ¹–çš„åšå®¢</a>
      </div>
      <div class="menu navbar-right">
        <!-- åœ¨ç”µè„‘ç«¯çš„å¯¼èˆªé“¾æ¥åŒºåŸŸæ·»åŠ æœç´¢åŠŸèƒ½ -->
        <div class="search-container">
          <a href="javascript:;" onclick="toggleSearchInput()">ğŸ”</a>
          <input
            type="text"
            id="nav-search-input-desktop"
            class="nav-search-input"
            placeholder="æƒ³çŸ¥é“æˆ‘ä»€ä¹ˆç§˜å¯†å‘¢ï¼Œæœæœçœ‹å§"
            oninput="navSearch(this)"
          />
          <div id="nav-search-result-desktop" class="nav-search-result"></div>
        </div>

        
        <a class="menu-item" href="/archives">å½’æ¡£</a>
        
        <a class="menu-item" href="/category">åˆ†ç±»</a>
        
        <a class="menu-item" href="/tag">æ ‡ç­¾</a>
        
        <a class="menu-item" href="/Timer">ä»»åŠ¡è®¡æ—¶å™¨</a>
        
        <a class="menu-item" href="/timeLine">æ—¶é—´çº¿</a>
        
        <a class="menu-item" href="/tongji">ç½‘ç«™ç»Ÿè®¡</a>
        
        <a class="menu-item" href="/about">å…³äº</a>
        

        <input id="switch_default" type="checkbox" class="switch_default" />
        <label for="switch_default" class="toggleBtn"></label>
      </div>
    </div>
  </nav>

  
  <nav class="navbar-mobile" id="nav-mobile">
    <div class="container">
      <div class="navbar-header">
        <div>
          <a href="/">è€æ±Ÿæ¹–çš„åšå®¢</a
          ><a id="mobile-toggle-theme">Â·&nbsp;Light</a>
        </div>

        <div class="menu-toggle" onclick="mobileBtn()">
          <svg
            class="menu-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M4.5 17.27q-.213 0-.356-.145T4 16.768t.144-.356t.356-.143h15q.213 0 .356.144q.144.144.144.357t-.144.356t-.356.143zm0-4.77q-.213 0-.356-.144T4 11.999t.144-.356t.356-.143h15q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-4.77q-.213 0-.356-.143Q4 7.443 4 7.23t.144-.356t.356-.143h15q.213 0 .356.144T20 7.23t-.144.356t-.356.144z"
            />
          </svg>
          <svg
            class="close-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <!-- Icon from Material Symbols Light by Google - https://github.com/google/material-design-icons/blob/master/LICENSE -->
            <path
              fill="currentColor"
              d="m12 12.708l-5.246 5.246q-.14.14-.344.15t-.364-.15t-.16-.354t.16-.354L11.292 12L6.046 6.754q-.14-.14-.15-.344t.15-.364t.354-.16t.354.16L12 11.292l5.246-5.246q.14-.14.345-.15q.203-.01.363.15t.16.354t-.16.354L12.708 12l5.246 5.246q.14.14.15.345q.01.203-.15.363t-.354.16t-.354-.16z"
            />
          </svg>
        </div>
      </div>

      <div class="menu" id="mobile-menu">
        
        <a class="menu-item" href="/archives">å½’æ¡£</a>
        
        <a class="menu-item" href="/category">åˆ†ç±»</a>
        
        <a class="menu-item" href="/tag">æ ‡ç­¾</a>
        
        <a class="menu-item" href="/Timer">ä»»åŠ¡è®¡æ—¶å™¨</a>
        
        <a class="menu-item" href="/timeLine">æ—¶é—´çº¿</a>
        
        <a class="menu-item" href="/tongji">ç½‘ç«™ç»Ÿè®¡</a>
        
        <a class="menu-item" href="/about">å…³äº</a>
        
        <!-- æ‰‹æœºæ¨¡å¼æœç´¢æ¡† -->
        <div class="search-container mobile-container">
          <a class="menu-item" href="javascript:;" onclick="toggleSearchInput()"
            >ğŸ”</a
          >
          <input
            type="text"
            id="nav-search-input-mobile"
            class="nav-search-input"
            placeholder="æƒ³çŸ¥é“æˆ‘ä»€ä¹ˆç§˜å¯†å‘¢ï¼Œæœæœçœ‹å§"
            oninput="navSearch(this)"
          />
          <div id="nav-search-result-mobile" class="nav-search-result"></div>
        </div>
      </div>
    </div>
  </nav>
</header>
<script>
  var mobileBtn = function f() {
    var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
    var mobileMenu = document.getElementById("mobile-menu");
    if (toggleMenu.classList.contains("active")) {
      toggleMenu.classList.remove("active");
      mobileMenu.classList.remove("active");
    } else {
      toggleMenu.classList.add("active");
      mobileMenu.classList.add("active");
    }
  };

  function toggleSearchInput() {
    const inputs = document.querySelectorAll(".nav-search-input");
    const results = document.querySelectorAll(".nav-search-result");
    inputs.forEach((input) => {
      input.classList.toggle("active");
      if (input.classList.contains("active")) input.focus();
    });
    results.forEach((r) => (r.style.display = "none"));
  }

  // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸéšè—æœç´¢æ¡†å’Œç»“æœå®¹å™¨çš„å‡½æ•°
  function handleClickOutsideSearch(event) {
    const searchContainers = document.querySelectorAll(".search-container");
    searchContainers.forEach((container) => {
      const searchInput = container.querySelector(".nav-search-input");
      const searchIcon = container.querySelector("a");

      // å¦‚æœç‚¹å‡»çš„å…ƒç´ ä¸æ˜¯æœç´¢è¾“å…¥æ¡†æˆ–æœç´¢å›¾æ ‡ï¼Œåˆ™éšè—æœç´¢æ¡†å’Œç»“æœå®¹å™¨
      if (
        !searchInput.contains(event.target) &&
        !searchIcon.contains(event.target)
      ) {
        searchInput.classList.remove("active");
        searchInput.value = ""
        // æ ¹æ®è¾“å…¥æ¡†IDç¡®å®šå¯¹åº”çš„ç»“æœå®¹å™¨
        let resultContainer;
        if (searchInput.id === "nav-search-input-mobile") {
          // ç§»åŠ¨ç«¯ç»“æœå®¹å™¨
          resultContainer = document.querySelector(
            ".navbar-mobile .nav-search-result"
          );
        } else {
          // æ¡Œé¢ç«¯ç»“æœå®¹å™¨
          resultContainer = document.getElementById(
            "nav-search-result-desktop"
          );
        }

        if (resultContainer) {
          resultContainer.style.display = "none";
          resultContainer.innerHTML = ""; // æ¸…ç©ºç»“æœå®¹å™¨å†…å®¹
        }
      }
    });
  }

  // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
  document.addEventListener("click", function (event) {
    handleClickOutsideSearch(event);
  });

  // æ–°å¢ï¼šæœç´¢åŠŸèƒ½å®ç°
  let searchData = []; // å…¨å±€å˜é‡å­˜å‚¨æœç´¢æ•°æ®

  // é¡µé¢åŠ è½½å®Œæˆåè·å–æœç´¢æ•°æ®
  document.addEventListener("DOMContentLoaded", function () {
    fetch("/search.xml")
      .then((res) => res.text())
      .then((xmlText) => {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "text/xml");
        const entries = xml.getElementsByTagName("entry");
        for (let entry of entries) {
          searchData.push({
            title: entry.getElementsByTagName("title")[0]?.textContent || "",
            content:
              entry.getElementsByTagName("content")[0]?.textContent || "",
            url: entry.getElementsByTagName("url")[0]?.textContent || "",
          });
        }
      })
      .catch((err) => {
        console.error("Failed to load search data:", err);
      });
  });

  // æ–°å¢ï¼šå¯¼èˆªæœç´¢æ–¹æ³•
  function navSearch(inputElement) {
    const keyword = inputElement.value.trim().toLowerCase();
    // æŸ¥æ‰¾å¯¹åº”çš„æœç´¢ç»“æœå®¹å™¨
    let resultContainer;

    if (inputElement.id === "nav-search-input-desktop") {
      // æ¡Œé¢ç«¯
      resultContainer = document.getElementById("nav-search-result-desktop");
    } else if (inputElement.id === "nav-search-input-mobile") {
      // ç§»åŠ¨ç«¯
      resultContainer =
        inputElement.parentNode.querySelector(".nav-search-result");
    }

    if (!resultContainer) return;

    resultContainer.innerHTML = "";

    if (!keyword) {
      resultContainer.style.display = "none";
      return;
    }

    // æ˜¾ç¤ºç»“æœå®¹å™¨
    resultContainer.style.display = "block";

    // è¿‡æ»¤æœç´¢æ•°æ®
    const results = searchData.filter(
      (data) =>
        (data.title && data.title.toLowerCase().includes(keyword)) ||
        (data.content && data.content.toLowerCase().includes(keyword))
    );

    if (results.length === 0) {
      resultContainer.innerHTML =
        '<p class="no-result">æ²¡æœ‰ç»“æœå“Ÿï¼Œæ¢ä¸ªå…³é”®è¯è¯•è¯•å§</p>';
      return;
    }

    // é™åˆ¶æ˜¾ç¤ºç»“æœæ•°é‡
    const maxResults = 10;
    const limitedResults = results.slice(0, maxResults);

    // æ„å»ºç»“æœHTML
    const html = limitedResults
      .map((item) => {
        // æå–åŒ…å«å…³é”®å­—çš„å†…å®¹ç‰‡æ®µ
        let contentSnippet = "";
        if (item.content) {
          // æ‰¾åˆ°åŒ…å«å…³é”®å­—çš„å†…å®¹ç‰‡æ®µ
          const contentLower = item.content.toLowerCase();
          const keywordIndex = contentLower.indexOf(keyword);

          // æå–å…³é”®å­—å‰åçš„å†…å®¹
          const start = Math.max(0, keywordIndex - 3 * keyword.length);
          const end = Math.min(
            item.content.length,
            keywordIndex + 3 * keyword.length
          );
          contentSnippet = item.content.substring(start, end);
        // é«˜äº®å…³é”®å­—
      const keywordRegex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      contentSnippet = contentSnippet.replace(
        keywordRegex,
        "<mark>$1</mark>"
      );
        }

        return `<div class="search-result-item">
  <a href="${item.url}">
    <div>æ ‡é¢˜ï¼š${item.title}</div>
    <div>å†…å®¹ï¼š${contentSnippet}</div>
  </a>
</div>`;
      })
      .join("");
    resultContainer.innerHTML = html;
  }
</script>
<style>
  /* æ‰‹æœºç«¯ä½¿ç”¨flexboxå¸ƒå±€æœç´¢å®¹å™¨ */
  .mobile-container {
    display: flex;
    align-items: center;
    flex-direction: row;
    margin-bottom: 10px;
    margin-left: 10px;
    flex-grow: 1;
    max-width: calc(100% - 40px);
  }


  .search-result-item {
  border: 1px solid #ddd; /* è¾¹æ¡† */
  margin: 4px 0; /* å¤–å±‚é—´è· */
  padding: 0; /* æ— å†…è¾¹è· */
  background: #fff; /* èƒŒæ™¯è‰² */
}

.search-result-item a {
  display: block;
  text-decoration: none;
  color: inherit;
}

.search-result-item div {
  padding: 3px 8px; /* ç´§å‡‘çš„å†…è¾¹è· */
  margin: 0; /* æ— å¤–è¾¹è· */
  line-height: 1.3; /* ç´§å‡‘çš„è¡Œé«˜ */
  word-wrap: break-word; /* å…è®¸é•¿å•è¯æ¢è¡Œ */
  white-space: normal; /* å…è®¸æ­£å¸¸æ¢è¡Œ */
}

.search-result-item div:first-child {
  border-bottom: 1px solid #eee; /* æ ‡é¢˜å’Œå†…å®¹ä¹‹é—´çš„åˆ†éš”çº¿ */
}


</style>

            <div class="main">
                <div class="container">
    <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">å±•å¼€æ‰€æœ‰</a>
        <a onclick="go_top()">è¿”å›é¡¶éƒ¨</a>
        <a onclick="go_bottom()">è¿”å›åº•éƒ¨</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // ä¸º 6 æ—¶å±•å¼€æ‰€æœ‰
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // è¿™ä¸ªå€¼æ˜¯ç”± tocbot æºç é‡Œå®šä¹‰çš„ scrollSmoothDuration å¾—æ¥çš„
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'å±•å¼€æ‰€æœ‰' : 'æŠ˜å æ‰€æœ‰';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>  
  <article class="post-wrap">
    <header class="post-header">
      <h1 class="post-title">12-é™„è¿‘å•†é“º</h1>
      
      <div class="post-meta">
         ä½œè€…:
        <a itemprop="author" rel="author" href="/">è€æ±Ÿæ¹–</a>
         
        <span class="post-time">
          <br />æ—¥æœŸ:
          <a href="#"
            >åæœˆ 12, 2025&nbsp;&nbsp;0:00:00</a
          >
        </span>
         
        <span class="post-category"
          ><br />
          åˆ†ç±»: 
          <a href="/categories/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/">é»‘é©¬ç‚¹è¯„</a>
          
        </span>
        
      </div>
      
    </header>

    <div class="post-content"><blockquote>
<p>streamæµçš„ä½¿ç”¨</p>
<p>dependency Analyzeræ’ä»¶</p>
</blockquote>
<h1 id="é™„è¿‘å•†æˆ·"><a href="#é™„è¿‘å•†æˆ·" class="headerlink" title="é™„è¿‘å•†æˆ·"></a>é™„è¿‘å•†æˆ·</h1><h2 id="ä¸€ã€GEO-æ•°æ®ç»“æ„ï¼šåœ°ç†åæ ‡å­˜å‚¨ä¸æŸ¥è¯¢"><a href="#ä¸€ã€GEO-æ•°æ®ç»“æ„ï¼šåœ°ç†åæ ‡å­˜å‚¨ä¸æŸ¥è¯¢" class="headerlink" title="ä¸€ã€GEO æ•°æ®ç»“æ„ï¼šåœ°ç†åæ ‡å­˜å‚¨ä¸æŸ¥è¯¢"></a>ä¸€ã€GEO æ•°æ®ç»“æ„ï¼šåœ°ç†åæ ‡å­˜å‚¨ä¸æŸ¥è¯¢</h2><p>GEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚Redisåœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ã€‚å¸¸è§çš„å‘½ä»¤æœ‰ï¼š</p>
<ul>
<li>GEOADDï¼šæ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦ï¼ˆlongitudeï¼‰ã€çº¬åº¦ï¼ˆlatitudeï¼‰ã€å€¼ï¼ˆmemberï¼‰</li>
<li>GEODISTï¼šè®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›</li>
<li>GEOHASHï¼šå°†æŒ‡å®šmemberçš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›</li>
<li>GEOPOSï¼šè¿”å›æŒ‡å®šmemberçš„åæ ‡</li>
<li>GEORADIUSï¼šæŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚6.ä»¥åå·²åºŸå¼ƒ</li>
<li>GEOSEARCHï¼šåœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢memberï¼Œå¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©å½¢ã€‚6.2.æ–°åŠŸèƒ½</li>
<li>GEOSEARCHSTOREï¼šä¸GEOSEARCHåŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyã€‚ 6.2.æ–°åŠŸèƒ½</li>
</ul>
<h2 id="äºŒã€æ•°æ®å¯¼å…¥ï¼šæŒ‰å•†æˆ·ç±»å‹åˆ†ç»„å­˜å‚¨"><a href="#äºŒã€æ•°æ®å¯¼å…¥ï¼šæŒ‰å•†æˆ·ç±»å‹åˆ†ç»„å­˜å‚¨" class="headerlink" title="äºŒã€æ•°æ®å¯¼å…¥ï¼šæŒ‰å•†æˆ·ç±»å‹åˆ†ç»„å­˜å‚¨"></a>äºŒã€æ•°æ®å¯¼å…¥ï¼šæŒ‰å•†æˆ·ç±»å‹åˆ†ç»„å­˜å‚¨</h2><p><strong>ä¸šåŠ¡éœ€æ±‚</strong>ï¼šæŸ¥è¯¢ â€œé™„è¿‘çš„å•†æˆ·â€ æ—¶ï¼Œéœ€æŒ‰ â€œå•†æˆ·ç±»å‹â€ ç­›é€‰ï¼ˆå¦‚ç¾é£Ÿã€é…’åº—ï¼‰ï¼Œå› æ­¤éœ€æŒ‰ç±»å‹åˆ†ç»„å­˜å‚¨åœ°ç†åæ ‡ã€‚</p>
<p><strong>å®ç°é€»è¾‘</strong>ï¼š</p>
<ol>
<li>ä»æ•°æ®åº“æŸ¥è¯¢æ‰€æœ‰å•†æˆ·ä¿¡æ¯ï¼›</li>
<li>æŒ‰<code>typeId</code>ï¼ˆå•†æˆ·ç±»å‹ IDï¼‰åˆ†ç»„ï¼ŒåŒç±»å‹å•†æˆ·å­˜å…¥ Redis åŒä¸€ GEO é›†åˆï¼›</li>
<li>ç”¨<code>GEOADD</code>æ‰¹é‡æ·»åŠ å•†æˆ·çš„ç»çº¬åº¦ï¼ˆ<code>x</code>ä¸ºç»åº¦ï¼Œ<code>y</code>ä¸ºçº¬åº¦ï¼‰å’Œå•†æˆ· IDï¼ˆ<code>member</code>ï¼‰ã€‚</li>
</ol>
<h3 id="ä»£ç åŠè¯¦è§£ï¼š"><a href="#ä»£ç åŠè¯¦è§£ï¼š" class="headerlink" title="ä»£ç åŠè¯¦è§£ï¼š"></a>ä»£ç åŠè¯¦è§£ï¼š</h3><p>æµ‹è¯•ç¯å¢ƒé€šè¿‡å•å…ƒæµ‹è¯•è½½å…¥æ•°æ®</p>
<p>HmDianPingApplicationTestsï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">loadShopData</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢åº—é“ºä¿¡æ¯</span></span><br><span class="line">    List&lt;Shop&gt; list = shopService.list();</span><br><span class="line">    <span class="comment">// 2.æŠŠåº—é“ºåˆ†ç»„ï¼ŒæŒ‰ç…§typeIdåˆ†ç»„ï¼ŒtypeIdä¸€è‡´çš„æ”¾åˆ°ä¸€ä¸ªé›†åˆ</span></span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="comment">// 3.åˆ†æ‰¹å®Œæˆå†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">// 3.1.è·å–ç±»å‹id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="comment">// 3.2.è·å–åŒç±»å‹çš„åº—é“ºçš„é›†åˆ</span></span><br><span class="line">        List&lt;Shop&gt; value = entry.getValue();</span><br><span class="line">        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(value.size());</span><br><span class="line">        <span class="comment">// 3.3.å†™å…¥redis GEOADD key ç»åº¦ çº¬åº¦ member</span></span><br><span class="line">        <span class="keyword">for</span> (Shop shop : value) &#123;</span><br><span class="line">            <span class="comment">// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());</span></span><br><span class="line">            locations.add(<span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(</span><br><span class="line">                    shop.getId().toString(),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(), shop.getY())</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è®¾è®¡ç†ç”±</strong>ï¼š</p>
<p>GEO æœ¬èº«ä¸æ”¯æŒæŒ‰ç±»å‹ç­›é€‰ï¼Œé€šè¿‡<code>typeId</code>ä½œä¸ºé”®å‰ç¼€åˆ†ç»„ï¼Œå¯ç›´æ¥å®šä½ â€œæŸç±»å‹å•†æˆ·çš„ GEO é›†åˆâ€ï¼Œé¿å…å…¨é‡æ‰«æã€‚</p>
<h4 id="1-Map-çš„åˆ›å»ºï¼šæŒ‰æ¡ä»¶åˆ†ç»„"><a href="#1-Map-çš„åˆ›å»ºï¼šæŒ‰æ¡ä»¶åˆ†ç»„" class="headerlink" title="1. Map çš„åˆ›å»ºï¼šæŒ‰æ¡ä»¶åˆ†ç»„"></a>1. Map çš„åˆ›å»ºï¼šæŒ‰æ¡ä»¶åˆ†ç»„</h4><p>ä»£ç é€šè¿‡<code>Collectors.groupingBy()</code>å°†åº—é“ºåˆ—è¡¨æŒ‰<code>typeId</code>åˆ†ç»„ï¼Œç”Ÿæˆäº†ä¸€ä¸ª<code>Map&lt;Long, List&lt;Shop&gt;&gt;</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream()</span><br><span class="line">    .collect(Collectors.groupingBy(Shop::getTypeId));</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>ä½œç”¨</strong>ï¼šå°†åŸæœ¬æ— åºçš„<code>List&lt;Shop&gt;</code>è½¬æ¢ä¸º<strong>æŒ‰åº—é“ºç±»å‹ï¼ˆ<code>typeId</code>ï¼‰å½’ç±»</strong>çš„ Mapã€‚</li>
<li>Map ç»“æ„ï¼š<ul>
<li><strong>é”®ï¼ˆKeyï¼‰</strong>ï¼š<code>Long</code>ç±»å‹ï¼Œå¯¹åº”åº—é“ºçš„<code>typeId</code>ï¼ˆåº—é“ºç±»å‹ IDï¼‰ã€‚</li>
<li><strong>å€¼ï¼ˆValueï¼‰</strong>ï¼š<code>List&lt;Shop&gt;</code>ç±»å‹ï¼Œå­˜å‚¨æ‰€æœ‰<code>typeId</code>ç›¸åŒçš„åº—é“ºå¯¹è±¡ã€‚</li>
</ul>
</li>
<li><strong>ä¼˜åŠ¿</strong>ï¼šé€šè¿‡ä¸€æ¬¡æµå¤„ç†å®Œæˆåˆ†ç»„ï¼Œæ›¿ä»£äº†ä¼ ç»Ÿçš„ â€œå¾ªç¯ + åˆ¤æ–­ + æ‰‹åŠ¨æ·»åŠ â€ æ–¹å¼ï¼Œä»£ç æ›´ç®€æ´é«˜æ•ˆã€‚</li>
</ul>
<h4 id="2-Map-çš„ç»“æ„ï¼šé”®å€¼å¯¹çš„ä¸šåŠ¡æ„ä¹‰"><a href="#2-Map-çš„ç»“æ„ï¼šé”®å€¼å¯¹çš„ä¸šåŠ¡æ„ä¹‰" class="headerlink" title="2. Map çš„ç»“æ„ï¼šé”®å€¼å¯¹çš„ä¸šåŠ¡æ„ä¹‰"></a>2. Map çš„ç»“æ„ï¼šé”®å€¼å¯¹çš„ä¸šåŠ¡æ„ä¹‰</h4><p>è¿™ä¸ª Map çš„ç»“æ„ç›´æ¥å¯¹åº”ä¸šåŠ¡éœ€æ±‚ï¼š<strong>åŒç±»å‹çš„åº—é“ºéœ€è¦æ‰¹é‡å†™å…¥ Redis çš„åŒä¸€ä¸ª GEO é›†åˆä¸­</strong>ï¼ˆRedis çš„ GEO é”®æ ¼å¼ä¸º<code>SHOP_GEO_KEY + typeId</code>ï¼‰ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li>è‹¥<code>typeId=1</code>çš„åº—é“ºæœ‰ 3 å®¶ï¼Œåˆ™ Map ä¸­ä¼šæœ‰ä¸€ä¸ªé”®å€¼å¯¹ï¼š<code>key=1ï¼Œvalue=[shop1, shop2, shop3]</code>ã€‚</li>
<li>åç»­å†™å…¥ Redis æ—¶ï¼Œå°±å¯ä»¥åŸºäºè¿™ä¸ªé”®å€¼å¯¹ï¼Œç›´æ¥è·å–è¯¥ç±»å‹å¯¹åº”çš„æ‰€æœ‰åº—é“ºï¼Œæ‰¹é‡å¤„ç†ã€‚</li>
</ul>
<h4 id="3-Map-çš„éå†ï¼šå¤„ç†åˆ†ç»„åçš„æ•°æ®"><a href="#3-Map-çš„éå†ï¼šå¤„ç†åˆ†ç»„åçš„æ•°æ®" class="headerlink" title="3. Map çš„éå†ï¼šå¤„ç†åˆ†ç»„åçš„æ•°æ®"></a>3. Map çš„éå†ï¼šå¤„ç†åˆ†ç»„åçš„æ•°æ®</h4><p>é€šè¿‡éå† Map çš„<code>entrySet()</code>ï¼Œé€ä¸ªå¤„ç†æ¯ä¸ªåˆ†ç»„çš„æ•°æ®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey(); <span class="comment">// è·å–åˆ†ç»„çš„typeId</span></span><br><span class="line">    List&lt;Shop&gt; shops = entry.getValue(); <span class="comment">// è·å–è¯¥ç±»å‹çš„æ‰€æœ‰åº—é“º</span></span><br><span class="line">    <span class="comment">// åŸºäºtypeIdå’Œshopsæ‰¹é‡å†™å…¥Redis</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>Map.Entry</code>çš„ä½œç”¨</strong>ï¼š<code>entrySet()</code>æ–¹æ³•è¿”å› Map ä¸­æ‰€æœ‰é”®å€¼å¯¹çš„é›†åˆï¼ˆ<code>Set&lt;Entry&gt;</code>ï¼‰ï¼Œæ¯ä¸ª<code>Entry</code>å¯¹è±¡å°è£…äº†ä¸€ä¸ª<code>key</code>å’Œå¯¹åº”çš„<code>value</code>ï¼Œæ–¹ä¾¿åŒæ—¶è·å–é”®å’Œå€¼ã€‚</li>
<li><strong>éå†ä¼˜åŠ¿</strong>ï¼šç›¸æ¯” â€œå…ˆè·å–æ‰€æœ‰ key å†é€ä¸ª get (value)â€ çš„æ–¹å¼ï¼Œç›´æ¥éå†<code>entrySet()</code>å‡å°‘äº†å¯¹ Map çš„æŸ¥è¯¢æ¬¡æ•°ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚</li>
</ul>
<h2 id="ä¸‰ã€é™„è¿‘å•†æˆ·æŸ¥è¯¢ï¼šæŒ‰è·ç¦»æ’åºä¸åˆ†é¡µ"><a href="#ä¸‰ã€é™„è¿‘å•†æˆ·æŸ¥è¯¢ï¼šæŒ‰è·ç¦»æ’åºä¸åˆ†é¡µ" class="headerlink" title="ä¸‰ã€é™„è¿‘å•†æˆ·æŸ¥è¯¢ï¼šæŒ‰è·ç¦»æ’åºä¸åˆ†é¡µ"></a>ä¸‰ã€é™„è¿‘å•†æˆ·æŸ¥è¯¢ï¼šæŒ‰è·ç¦»æ’åºä¸åˆ†é¡µ</h2><p><strong>ä¸šåŠ¡éœ€æ±‚</strong>ï¼šæ ¹æ®ç”¨æˆ·å½“å‰åæ ‡ï¼ˆ<code>x</code>ï¼Œ<code>y</code>ï¼‰ï¼ŒæŸ¥è¯¢æŒ‡å®šç±»å‹ã€æŒ‡å®šèŒƒå›´å†…çš„å•†æˆ·ï¼ŒæŒ‰è·ç¦»æ’åºå¹¶æ”¯æŒåˆ†é¡µã€‚</p>
<p><strong>å®ç°æ­¥éª¤</strong>ï¼š</p>
<ol>
<li><strong>åˆ¤æ–­æ˜¯å¦éœ€è¦åœ°ç†æŸ¥è¯¢</strong>ï¼šè‹¥æœªæä¾›åæ ‡ï¼ˆ<code>x</code>&#x2F;<code>y</code>ä¸º nullï¼‰ï¼Œç›´æ¥æŒ‰ç±»å‹ä»æ•°æ®åº“åˆ†é¡µæŸ¥è¯¢ï¼›</li>
<li><strong>åœ°ç†æŸ¥è¯¢å‚æ•°è®¡ç®—</strong>ï¼šåˆ†é¡µå‚æ•°ï¼ˆ<code>from</code>&#x3D;ï¼ˆå½“å‰é¡µ - 1ï¼‰<em>é¡µå¤§å°ï¼Œ<code>end</code>&#x3D; å½“å‰é¡µ</em>é¡µå¤§å°ï¼‰ã€æœç´¢èŒƒå›´ï¼ˆå¦‚ 5000 ç±³ï¼‰ï¼›</li>
<li><strong>GEO æœç´¢</strong>ï¼šç”¨<code>GEOSEARCH</code>æŸ¥è¯¢ â€œä»¥ç”¨æˆ·åæ ‡ä¸ºä¸­å¿ƒã€5000 ç±³èŒƒå›´å†…â€ çš„å•†æˆ·ï¼Œè¿”å›å•†æˆ· ID åŠè·ç¦»ï¼›</li>
<li><strong>ç»“æœå¤„ç†</strong>ï¼š<ul>
<li>æˆªå–åˆ†é¡µèŒƒå›´å†…çš„å•†æˆ· IDï¼ˆè·³è¿‡<code>from</code>æ¡ï¼Œå–åˆ°<code>end</code>æ¡ï¼‰ï¼›</li>
<li>æ ¹æ® ID ä»æ•°æ®åº“æŸ¥è¯¢å•†æˆ·è¯¦æƒ…ï¼Œå…³è”è·ç¦»ä¿¡æ¯ï¼›</li>
<li>æŒ‰ GEO è¿”å›çš„é¡ºåºæ’åºï¼ˆä¿è¯æŒ‰è·ç¦»æ’åºï¼‰ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ShopController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/type&quot;)</span></span><br><span class="line"><span class="comment">//å‚æ•°requiredå½“è®¾ç½®ä¸ºfalseæ—¶ï¼Œå‰ç«¯å¯ä»¥ä¸ä¼ é€’è¯¥å‚æ•°ï¼Œæ­¤æ—¶æ–¹æ³•å‚æ•°ä¼šè¢«èµ‹å€¼ä¸ºnull;è‹¥æœªè®¾ç½®æ­¤å±æ€§æˆ–è®¾ä¸ºtrueï¼Œåˆ™ç¼ºå°‘å‚æ•°ä¼šæŠ›å‡ºMissingServletRequestParameterExceptionå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> shopService.queryShopByType(typeId, current, x, y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShopServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span> || y == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸éœ€è¦åæ ‡æŸ¥è¯¢ï¼ŒæŒ‰æ•°æ®åº“æŸ¥è¯¢</span></span><br><span class="line">            Page&lt;Shop&gt; page = query()</span><br><span class="line">                    .eq(<span class="string">&quot;type_id&quot;</span>, typeId)</span><br><span class="line">                    .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));<span class="comment">//ä½¿ç”¨ MyBatis-Plus çš„åˆ†é¡µæŸ¥è¯¢ï¼ˆpage()æ–¹æ³•ï¼‰</span></span><br><span class="line">            <span class="comment">// è¿”å›æ•°æ®</span></span><br><span class="line">            <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.è®¡ç®—åˆ†é¡µå‚æ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current - <span class="number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.GEOæŸ¥è¯¢,æŸ¥è¯¢redisã€æŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µã€‚ç»“æœï¼šshopIdã€distance</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo() <span class="comment">// GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE</span></span><br><span class="line">                .search(</span><br><span class="line">                        key,<span class="comment">// Redisä¸­å­˜å‚¨è¯¥ç±»å‹åº—é“ºåœ°ç†ä¿¡æ¯çš„é”®</span></span><br><span class="line">                        GeoReference.fromCoordinate(x, y),GeoReference.fromCoordinate(x, y), <span class="comment">// å‚è€ƒåæ ‡ï¼ˆç”¨æˆ·çš„ç»çº¬åº¦ï¼‰</span></span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">5000</span>),<span class="comment">// æœç´¢èŒƒå›´ï¼š5000å•ä½ï¼ˆé»˜è®¤ç±³ï¼‰</span></span><br><span class="line"> 				 RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs()</span><br><span class="line">                    .includeDistance()<span class="comment">// åŒ…å«è·ç¦»ä¿¡æ¯</span></span><br><span class="line">                    .limit(end)<span class="comment">// æœ€å¤šè¿”å›endæ¡ç»“æœï¼ˆç”¨äºåˆ†é¡µï¼‰</span></span><br><span class="line">                );</span><br><span class="line">        <span class="comment">// 4.è§£æå‡ºid</span></span><br><span class="line">        <span class="keyword">if</span> (results == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());<span class="comment">// æ— ç»“æœï¼Œè¿”å›ç©ºåˆ—è¡¨</span></span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class="line">        <span class="comment">// è‹¥ç»“æœæ€»æ•° &lt;= fromï¼Œè¯´æ˜å½“å‰é¡µæ— æ•°æ®ï¼ˆå¦‚ç¬¬2é¡µä½†åªæœ‰10æ¡æ•°æ®ï¼Œfrom=20åˆ™æ— ç»“æœï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (list.size() &lt;= from) &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰ä¸‹ä¸€é¡µäº†ï¼Œç»“æŸ</span></span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.1.æˆªå– from ~ endçš„éƒ¨åˆ†</span></span><br><span class="line">        List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list.size());</span><br><span class="line">        Map&lt;String, Distance&gt; distanceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(list.size());</span><br><span class="line">        list.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class="line">            <span class="comment">// 4.2.è·å–åº—é“ºid</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">shopIdStr</span> <span class="operator">=</span> result.getContent().getName();</span><br><span class="line">            ids.add(Long.valueOf(shopIdStr));</span><br><span class="line">            <span class="comment">// 4.3.è·å–è·ç¦»</span></span><br><span class="line">            <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> result.getDistance();<span class="comment">// åº—é“ºåˆ°ç”¨æˆ·çš„è·ç¦»</span></span><br><span class="line">            distanceMap.put(shopIdStr, distance);<span class="comment">// å­˜å‚¨â€œåº—é“ºID-è·ç¦»â€æ˜ å°„</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 5.æ ¹æ®idæŸ¥è¯¢Shop</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">        List&lt;Shop&gt; shops = query()</span><br><span class="line">            .in(<span class="string">&quot;id&quot;</span>, ids)</span><br><span class="line">            .last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>)<span class="comment">//æŒ‰GEOè¿”å›é¡ºåºæ’åº</span></span><br><span class="line">            .list();</span><br><span class="line">        <span class="comment">// ç»™æ¯ä¸ªåº—é“ºè®¾ç½®è·ç¦»ï¼ˆå•ä½ç”±Redisçš„Distanceå†³å®šï¼Œé»˜è®¤ç±³ï¼‰</span></span><br><span class="line">        <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">     		 shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="å››ã€å…³é”®æŠ€æœ¯ç‚¹ä¸æ³¨æ„äº‹é¡¹"><a href="#å››ã€å…³é”®æŠ€æœ¯ç‚¹ä¸æ³¨æ„äº‹é¡¹" class="headerlink" title="å››ã€å…³é”®æŠ€æœ¯ç‚¹ä¸æ³¨æ„äº‹é¡¹"></a>å››ã€å…³é”®æŠ€æœ¯ç‚¹ä¸æ³¨æ„äº‹é¡¹</h2><ol>
<li><p><strong>Spring Data Redis ç‰ˆæœ¬å…¼å®¹</strong>ï¼š</p>
<p><code>GEOSEARCH</code>æ˜¯ Redis 6.2 + æ–°å¢å‘½ä»¤ï¼Œéœ€ç¡®ä¿ Spring Data Redis ç‰ˆæœ¬â‰¥2.6.2ã€Lettuceï¼ˆRedis å®¢æˆ·ç«¯ï¼‰â‰¥6.1.6ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p>
</li>
<li><p><strong>åˆ†é¡µé€»è¾‘</strong>ï¼š</p>
<p>ä¼ ç»Ÿåˆ†é¡µï¼ˆ<code>page</code>+<code>size</code>ï¼‰ä¸é€‚ç”¨åœ°ç†æŸ¥è¯¢ï¼Œæ”¹ç”¨ â€œ<code>from</code>ï¼ˆè·³è¿‡æ¡æ•°ï¼‰+<code>end</code>ï¼ˆæœ€å¤§è¿”å›æ¡æ•°ï¼‰â€ å®ç°ï¼Œé¿å…å› æ•°æ®åŠ¨æ€å˜åŒ–å¯¼è‡´é‡å¤ &#x2F; ç¼ºå¤±ã€‚</p>
</li>
<li><p><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼š</p>
<ul>
<li>GEO ä»…å­˜å‚¨å•†æˆ· IDï¼Œè¯¦ç»†ä¿¡æ¯ä»æ•°æ®åº“æŸ¥è¯¢ï¼ˆå‡å°‘ Redis å†…å­˜å ç”¨ï¼‰ï¼›</li>
<li>æŒ‰ç±»å‹åˆ†ç»„å­˜å‚¨ï¼Œç¼©å°æŸ¥è¯¢èŒƒå›´ï¼Œæå‡<code>GEOSEARCH</code>æ•ˆç‡ã€‚</li>
</ul>
</li>
<li><p><strong>è·ç¦»å•ä½</strong>ï¼š</p>
<p><code>Distance</code>é»˜è®¤å•ä½ä¸ºç±³ï¼Œå¯é€šè¿‡æ„é€ å‡½æ•°æŒ‡å®šï¼ˆå¦‚<code>new Distance(5, Metrics.KILOMETERS)</code>è¡¨ç¤º 5 å…¬é‡Œï¼‰ã€‚</p>
</li>
</ol>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é™„è¿‘å•†æˆ·åŠŸèƒ½é€šè¿‡<strong>Redis GEO</strong>å®ç°åœ°ç†åæ ‡çš„é«˜æ•ˆå­˜å‚¨ä¸èŒƒå›´æŸ¥è¯¢ï¼Œç»“åˆ â€œæŒ‰ç±»å‹åˆ†ç»„â€ å’Œ â€œæ»šåŠ¨åˆ†é¡µâ€ï¼Œæ—¢æ»¡è¶³äº† â€œæŒ‰è·ç¦»æ’åºâ€ çš„ä¸šåŠ¡éœ€æ±‚ï¼Œåˆä¿è¯äº†æŸ¥è¯¢æ€§èƒ½ã€‚æ ¸å¿ƒæ˜¯åˆ©ç”¨ GEO çš„<code>GEOADD</code>å’Œ<code>GEOSEARCH</code>å‘½ä»¤ï¼Œå®ç° â€œæ·»åŠ åæ ‡ - èŒƒå›´æœç´¢ - è·ç¦»è®¡ç®—â€ çš„å®Œæ•´æµç¨‹ï¼Œæ˜¯åœ°ç†ä½ç½®æœåŠ¡çš„å…¸å‹å®è·µã€‚</p>
</div>

    
    <section class="post-copyright">
      
      <p class="copyright-item">
        <span>ä½œè€…:</span>
        <span>è€æ±Ÿæ¹–</span>
      </p>
        
      <p class="copyright-item">
        <span>è®¸å¯è¯:</span>
        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
      </p>
       
      <p class="copyright-item">
        <span>å£å·:</span>
        <span><strong>ä»£ç æ˜¯å¼€æºçš„,æˆ‘ä»¬åªæ˜¯å®ƒçš„æ¬è¿å·¥ã€‚</strong></span>
      </p>
       
        <p class="copyright-item">
        <span>å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œè¯·éšæ„è½¬è½½ï¼Œæ„Ÿè°¢æ”¯æŒï¼</span>
      </p>
      
             
        <p class="copyright-item">
        <span>å¦‚æœ‰ä¾µæƒè¯·å‘ŠçŸ¥åˆ é™¤ğŸ™</span>
      </p>
             
        <p class="copyright-item">
        <span>å¦‚æœä½ æœ‰å¾ˆå¥½çš„æƒ³æ³•ğŸ’¡ï¼Œè¯·åŠ¡å¿…è”ç³»æˆ‘ã€‚ </span>
        <br>
         <span>2292360909@qq.com</span>
      </p>
    </section>
    
    <section class="post-tags">
      <div>
        <span>æ ‡ç­¾:</span>
        <span class="tag">
          
        </span>
      </div>
      <div>
        <a href="javascript:window.history.back();">è¿”å›</a>
        <span>Â· </span>
        <a href="/">é¦–é¡µ</a>
      </div>
    </section>
    <section class="post-nav">
      
      <a class="prev" rel="prev" href="/2025/10/12/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/13-%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0/"
        >13-ç”¨æˆ·ç­¾åˆ°</a
      >
       
      <a class="next" rel="next" href="/2025/10/12/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/14-UV%E7%BB%9F%E8%AE%A1/"
        >14-UVç»Ÿè®¡</a
      >
      
    </section>

    <!-- Giscus è¯„è®ºåŒºæŒ‚è½½ç‚¹ -->
<div id="giscus-container" style="margin-top: 2.5rem;"></div>

<!-- Giscus åŠ¨æ€åŠ è½½è„šæœ¬ï¼šåˆå§‹åŠ è½½ + æ˜æš—ä¸»é¢˜åˆ‡æ¢ -->
<script>
  function createGiscus(theme) {
    const giscusContainer = document.getElementById('giscus-container');
    if (!giscusContainer) return;

    // æ¸…é™¤æ—§çš„è¯„è®º iframe
    giscusContainer.innerHTML = '';

    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';

    // æ›¿æ¢ä¸ºä½ çš„ GitHub ä»“åº“ä¿¡æ¯ï¼ˆæ ¼å¼ï¼šusername/repoï¼‰
    script.setAttribute('data-repo', 'meisijiya/meisijiya.github.io');

   // æ›¿æ¢ä¸ºä½ çš„ repo-id å’Œ category-idï¼ˆåœ¨ giscus.app é…ç½®é¡µé¢ç”Ÿæˆï¼‰
    script.setAttribute('data-repo-id', 'R_kgDOPwTrpQ');
    script.setAttribute('data-category', 'Announcements');
    script.setAttribute('data-category-id', 'DIC_kwDOPwTrpc4CviGR');

    // å…¶ä»–å¸¸è§„æ¨èè®¾ç½®
    script.setAttribute('data-mapping', 'pathname');           // ç”¨é¡µé¢è·¯å¾„åŒ¹é…è¯„è®ºå¸–
    script.setAttribute('data-strict', '0');                   // è‹¥æ— åŒ¹é…å¸–åˆ™åˆ›å»ºæ–°å¸–
    script.setAttribute('data-reactions-enabled', '1');        // å¯ç”¨è¡¨æƒ…ååº”
    script.setAttribute('data-emit-metadata', '0');            // ä¸è¾“å‡ºå…ƒæ•°æ®
    script.setAttribute('data-input-position', 'top');         // è¾“å…¥æ¡†åœ¨è¯„è®ºä¸Šæ–¹
    script.setAttribute('data-theme', theme);                
    script.setAttribute('data-lang', 'zh-CN');                 // ä¸­æ–‡ç•Œé¢
    script.setAttribute('crossorigin', 'anonymous');           // è·¨åŸŸèµ„æºå®‰å…¨
    script.async = true;                                       
     
    giscusContainer.appendChild(script);
  }

  function getCurrentTheme() {
    return document.body.classList.contains('dark-theme') ? 'dark' : 'light';
  }

  document.addEventListener('DOMContentLoaded', () => {
    // é¡µé¢é¦–æ¬¡åŠ è½½ï¼Œæ ¹æ®å½“å‰ä¸»é¢˜æŒ‚è½½è¯„è®º
    createGiscus(getCurrentTheme());

    // ç›‘å¬æŒ‰é’®ç‚¹å‡»åˆ‡æ¢ä¸»é¢˜ â†’ é‡è½½è¯„è®ºåŒº
    const buttons = [
      document.querySelector('.toggleBtn'),
      document.getElementById('mobile-toggle-theme')
    ];
    buttons.forEach(btn => {
      if (!btn) return;
      btn.addEventListener('click', () => {
        setTimeout(() => {
          createGiscus(getCurrentTheme());
        }, 400); // ç¨ä½œå»¶è¿Ÿï¼Œç¡®ä¿ class åˆ‡æ¢å®Œæ¯•
      });
    });

    // ç›‘å¬ body class æ”¹å˜ï¼ˆä¿é™©æ–¹æ¡ˆï¼‰
    const observer = new MutationObserver(() => {
      createGiscus(getCurrentTheme());
    });
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  });
</script>

  </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Â© è€æ±Ÿæ¹– | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>
<script src="/js/code-copy.js"></script>


    </div>
</body>
<!-- umami -->
<script defer src="https://cloud.umami.is/script.js" data-website-id="91b923f2-ff2d-43d0-ba5f-bc348d82426a"></script>
</html>