<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="è€æ±Ÿæ¹–">


    <meta name="subtitle" content="è®°å½•è¿›å…¥æˆ¿é—´é—¨åçš„ç¾å¥½">


    <meta name="description" content="ä¸€å¹´å‰ï¼Œå­¤è‹¦ä¼¶ä»ƒçš„è€æ±Ÿæ¹–ï¼Œå¶ç„¶é—´å‘ç°ä¸€å¤„æˆ¿é—´é—¨ï¼Œæ¨é—¨è€Œå…¥ï¼Œä»æ­¤è¿›å…¥äº†å……æ»¡å¹¸ç¦çš„ä¸–ç•Œã€‚">


    <meta name="keywords" content="è€æ±Ÿæ¹–,åšå®¢,æˆ¿é—´é—¨">


<title>07-åˆ†å¸ƒå¼é”-redission | æ¬¢è¿æ¥åˆ°è€æ±Ÿæ¹–çš„åšå®¢</title>



    <link rel="icon" href="/images/%E9%87%91%E6%AF%9B.png?_t=1758006391547">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    
    <link rel="stylesheet" href="/css/search.css">
    

<!-- highlight.js æ ·å¼ï¼ˆé»˜è®¤äº®è‰²ï¼‰ -->
<link id="hljs-theme" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.css">
<!-- highlight.js è‡ªåŠ¨ä¸Šè‰²åŠŸèƒ½ -->
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

<link rel="stylesheet" href="/css/custom.css">



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const pagebody = document.getElementsByTagName('body')[0]

            function setTheme(status) {

                if (status === 'dark') {
                    window.sessionStorage.theme = 'dark'
                    pagebody.classList.add('dark-theme');

                } else if (status === 'light') {
                    window.sessionStorage.theme = 'light'
                    pagebody.classList.remove('dark-theme');
                }
            };

            setTheme(window.sessionStorage.theme)
        })();
    </script>

    <div class="wrapper">
        <header>
  <nav class="navbar">
    <div class="container">
      <div class="navbar-header header-logo">
        <a href="/">è€æ±Ÿæ¹–çš„åšå®¢</a>
      </div>
      <div class="menu navbar-right">
        <!-- åœ¨ç”µè„‘ç«¯çš„å¯¼èˆªé“¾æ¥åŒºåŸŸæ·»åŠ æœç´¢åŠŸèƒ½ -->
        <div class="search-container">
          <a href="javascript:;" onclick="toggleSearchInput()">ğŸ”</a>
          <input
            type="text"
            id="nav-search-input-desktop"
            class="nav-search-input"
            placeholder="æƒ³çŸ¥é“æˆ‘ä»€ä¹ˆç§˜å¯†å‘¢ï¼Œæœæœçœ‹å§"
            oninput="navSearch(this)"
          />
          <div id="nav-search-result-desktop" class="nav-search-result"></div>
        </div>

        
        <a class="menu-item" href="/archives">å½’æ¡£</a>
        
        <a class="menu-item" href="/category">åˆ†ç±»</a>
        
        <a class="menu-item" href="/tag">æ ‡ç­¾</a>
        
        <a class="menu-item" href="/Timer">ä»»åŠ¡è®¡æ—¶å™¨</a>
        
        <a class="menu-item" href="/timeLine">æ—¶é—´çº¿</a>
        
        <a class="menu-item" href="/tongji">ç½‘ç«™ç»Ÿè®¡</a>
        
        <a class="menu-item" href="/about">å…³äº</a>
        

        <input id="switch_default" type="checkbox" class="switch_default" />
        <label for="switch_default" class="toggleBtn"></label>
      </div>
    </div>
  </nav>

  
  <nav class="navbar-mobile" id="nav-mobile">
    <div class="container">
      <div class="navbar-header">
        <div>
          <a href="/">è€æ±Ÿæ¹–çš„åšå®¢</a
          ><a id="mobile-toggle-theme">Â·&nbsp;Light</a>
        </div>

        <div class="menu-toggle" onclick="mobileBtn()">
          <svg
            class="menu-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M4.5 17.27q-.213 0-.356-.145T4 16.768t.144-.356t.356-.143h15q.213 0 .356.144q.144.144.144.357t-.144.356t-.356.143zm0-4.77q-.213 0-.356-.144T4 11.999t.144-.356t.356-.143h15q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-4.77q-.213 0-.356-.143Q4 7.443 4 7.23t.144-.356t.356-.143h15q.213 0 .356.144T20 7.23t-.144.356t-.356.144z"
            />
          </svg>
          <svg
            class="close-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <!-- Icon from Material Symbols Light by Google - https://github.com/google/material-design-icons/blob/master/LICENSE -->
            <path
              fill="currentColor"
              d="m12 12.708l-5.246 5.246q-.14.14-.344.15t-.364-.15t-.16-.354t.16-.354L11.292 12L6.046 6.754q-.14-.14-.15-.344t.15-.364t.354-.16t.354.16L12 11.292l5.246-5.246q.14-.14.345-.15q.203-.01.363.15t.16.354t-.16.354L12.708 12l5.246 5.246q.14.14.15.345q.01.203-.15.363t-.354.16t-.354-.16z"
            />
          </svg>
        </div>
      </div>

      <div class="menu" id="mobile-menu">
        
        <a class="menu-item" href="/archives">å½’æ¡£</a>
        
        <a class="menu-item" href="/category">åˆ†ç±»</a>
        
        <a class="menu-item" href="/tag">æ ‡ç­¾</a>
        
        <a class="menu-item" href="/Timer">ä»»åŠ¡è®¡æ—¶å™¨</a>
        
        <a class="menu-item" href="/timeLine">æ—¶é—´çº¿</a>
        
        <a class="menu-item" href="/tongji">ç½‘ç«™ç»Ÿè®¡</a>
        
        <a class="menu-item" href="/about">å…³äº</a>
        
        <!-- æ‰‹æœºæ¨¡å¼æœç´¢æ¡† -->
        <div class="search-container mobile-container">
          <a class="menu-item" href="javascript:;" onclick="toggleSearchInput()"
            >ğŸ”</a
          >
          <input
            type="text"
            id="nav-search-input-mobile"
            class="nav-search-input"
            placeholder="æƒ³çŸ¥é“æˆ‘ä»€ä¹ˆç§˜å¯†å‘¢ï¼Œæœæœçœ‹å§"
            oninput="navSearch(this)"
          />
          <div id="nav-search-result-mobile" class="nav-search-result"></div>
        </div>
      </div>
    </div>
  </nav>
</header>
<script>
  var mobileBtn = function f() {
    var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
    var mobileMenu = document.getElementById("mobile-menu");
    if (toggleMenu.classList.contains("active")) {
      toggleMenu.classList.remove("active");
      mobileMenu.classList.remove("active");
    } else {
      toggleMenu.classList.add("active");
      mobileMenu.classList.add("active");
    }
  };

  function toggleSearchInput() {
    const inputs = document.querySelectorAll(".nav-search-input");
    const results = document.querySelectorAll(".nav-search-result");
    inputs.forEach((input) => {
      input.classList.toggle("active");
      if (input.classList.contains("active")) input.focus();
    });
    results.forEach((r) => (r.style.display = "none"));
  }

  // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸéšè—æœç´¢æ¡†å’Œç»“æœå®¹å™¨çš„å‡½æ•°
  function handleClickOutsideSearch(event) {
    const searchContainers = document.querySelectorAll(".search-container");
    searchContainers.forEach((container) => {
      const searchInput = container.querySelector(".nav-search-input");
      const searchIcon = container.querySelector("a");

      // å¦‚æœç‚¹å‡»çš„å…ƒç´ ä¸æ˜¯æœç´¢è¾“å…¥æ¡†æˆ–æœç´¢å›¾æ ‡ï¼Œåˆ™éšè—æœç´¢æ¡†å’Œç»“æœå®¹å™¨
      if (
        !searchInput.contains(event.target) &&
        !searchIcon.contains(event.target)
      ) {
        searchInput.classList.remove("active");
        searchInput.value = ""
        // æ ¹æ®è¾“å…¥æ¡†IDç¡®å®šå¯¹åº”çš„ç»“æœå®¹å™¨
        let resultContainer;
        if (searchInput.id === "nav-search-input-mobile") {
          // ç§»åŠ¨ç«¯ç»“æœå®¹å™¨
          resultContainer = document.querySelector(
            ".navbar-mobile .nav-search-result"
          );
        } else {
          // æ¡Œé¢ç«¯ç»“æœå®¹å™¨
          resultContainer = document.getElementById(
            "nav-search-result-desktop"
          );
        }

        if (resultContainer) {
          resultContainer.style.display = "none";
          resultContainer.innerHTML = ""; // æ¸…ç©ºç»“æœå®¹å™¨å†…å®¹
        }
      }
    });
  }

  // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
  document.addEventListener("click", function (event) {
    handleClickOutsideSearch(event);
  });

  // æ–°å¢ï¼šæœç´¢åŠŸèƒ½å®ç°
  let searchData = []; // å…¨å±€å˜é‡å­˜å‚¨æœç´¢æ•°æ®

  // é¡µé¢åŠ è½½å®Œæˆåè·å–æœç´¢æ•°æ®
  document.addEventListener("DOMContentLoaded", function () {
    fetch("/search.xml")
      .then((res) => res.text())
      .then((xmlText) => {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "text/xml");
        const entries = xml.getElementsByTagName("entry");
        for (let entry of entries) {
          searchData.push({
            title: entry.getElementsByTagName("title")[0]?.textContent || "",
            content:
              entry.getElementsByTagName("content")[0]?.textContent || "",
            url: entry.getElementsByTagName("url")[0]?.textContent || "",
          });
        }
      })
      .catch((err) => {
        console.error("Failed to load search data:", err);
      });
  });

  // æ–°å¢ï¼šå¯¼èˆªæœç´¢æ–¹æ³•
  function navSearch(inputElement) {
    const keyword = inputElement.value.trim().toLowerCase();
    // æŸ¥æ‰¾å¯¹åº”çš„æœç´¢ç»“æœå®¹å™¨
    let resultContainer;

    if (inputElement.id === "nav-search-input-desktop") {
      // æ¡Œé¢ç«¯
      resultContainer = document.getElementById("nav-search-result-desktop");
    } else if (inputElement.id === "nav-search-input-mobile") {
      // ç§»åŠ¨ç«¯
      resultContainer =
        inputElement.parentNode.querySelector(".nav-search-result");
    }

    if (!resultContainer) return;

    resultContainer.innerHTML = "";

    if (!keyword) {
      resultContainer.style.display = "none";
      return;
    }

    // æ˜¾ç¤ºç»“æœå®¹å™¨
    resultContainer.style.display = "block";

    // è¿‡æ»¤æœç´¢æ•°æ®
    const results = searchData.filter(
      (data) =>
        (data.title && data.title.toLowerCase().includes(keyword)) ||
        (data.content && data.content.toLowerCase().includes(keyword))
    );

    if (results.length === 0) {
      resultContainer.innerHTML =
        '<p class="no-result">æ²¡æœ‰ç»“æœå“Ÿï¼Œæ¢ä¸ªå…³é”®è¯è¯•è¯•å§</p>';
      return;
    }

    // é™åˆ¶æ˜¾ç¤ºç»“æœæ•°é‡
    const maxResults = 10;
    const limitedResults = results.slice(0, maxResults);

    // æ„å»ºç»“æœHTML
    const html = limitedResults
      .map((item) => {
        // æå–åŒ…å«å…³é”®å­—çš„å†…å®¹ç‰‡æ®µ
        let contentSnippet = "";
        if (item.content) {
          // æ‰¾åˆ°åŒ…å«å…³é”®å­—çš„å†…å®¹ç‰‡æ®µ
          const contentLower = item.content.toLowerCase();
          const keywordIndex = contentLower.indexOf(keyword);

          // æå–å…³é”®å­—å‰åçš„å†…å®¹
          const start = Math.max(0, keywordIndex - 3 * keyword.length);
          const end = Math.min(
            item.content.length,
            keywordIndex + 3 * keyword.length
          );
          contentSnippet = item.content.substring(start, end);
        // é«˜äº®å…³é”®å­—
      const keywordRegex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      contentSnippet = contentSnippet.replace(
        keywordRegex,
        "<mark>$1</mark>"
      );
        }

        return `<div class="search-result-item">
  <a href="${item.url}">
    <div>æ ‡é¢˜ï¼š${item.title}</div>
    <div>å†…å®¹ï¼š${contentSnippet}</div>
  </a>
</div>`;
      })
      .join("");
    resultContainer.innerHTML = html;
  }
</script>
<style>
  /* æ‰‹æœºç«¯ä½¿ç”¨flexboxå¸ƒå±€æœç´¢å®¹å™¨ */
  .mobile-container {
    display: flex;
    align-items: center;
    flex-direction: row;
    margin-bottom: 10px;
    margin-left: 10px;
    flex-grow: 1;
    max-width: calc(100% - 40px);
  }


  .search-result-item {
  border: 1px solid #ddd; /* è¾¹æ¡† */
  margin: 4px 0; /* å¤–å±‚é—´è· */
  padding: 0; /* æ— å†…è¾¹è· */
  background: #fff; /* èƒŒæ™¯è‰² */
}

.search-result-item a {
  display: block;
  text-decoration: none;
  color: inherit;
}

.search-result-item div {
  padding: 3px 8px; /* ç´§å‡‘çš„å†…è¾¹è· */
  margin: 0; /* æ— å¤–è¾¹è· */
  line-height: 1.3; /* ç´§å‡‘çš„è¡Œé«˜ */
  word-wrap: break-word; /* å…è®¸é•¿å•è¯æ¢è¡Œ */
  white-space: normal; /* å…è®¸æ­£å¸¸æ¢è¡Œ */
}

.search-result-item div:first-child {
  border-bottom: 1px solid #eee; /* æ ‡é¢˜å’Œå†…å®¹ä¹‹é—´çš„åˆ†éš”çº¿ */
}


</style>

            <div class="main">
                <div class="container">
    <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">å±•å¼€æ‰€æœ‰</a>
        <a onclick="go_top()">è¿”å›é¡¶éƒ¨</a>
        <a onclick="go_bottom()">è¿”å›åº•éƒ¨</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // ä¸º 6 æ—¶å±•å¼€æ‰€æœ‰
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // è¿™ä¸ªå€¼æ˜¯ç”± tocbot æºç é‡Œå®šä¹‰çš„ scrollSmoothDuration å¾—æ¥çš„
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'å±•å¼€æ‰€æœ‰' : 'æŠ˜å æ‰€æœ‰';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>  
  <article class="post-wrap">
    <header class="post-header">
      <h1 class="post-title">07-åˆ†å¸ƒå¼é”-redission</h1>
      
      <div class="post-meta">
         ä½œè€…:
        <a itemprop="author" rel="author" href="/">è€æ±Ÿæ¹–</a>
         
        <span class="post-time">
          <br />æ—¥æœŸ:
          <a href="#"
            >åæœˆ 12, 2025&nbsp;&nbsp;0:00:00</a
          >
        </span>
         
        <span class="post-category"
          ><br />
          åˆ†ç±»: 
          <a href="/categories/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/">é»‘é©¬ç‚¹è¯„</a>
          
        </span>
        
      </div>
      
    </header>

    <div class="post-content"><h1 id="åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»å’Œå¿«é€Ÿå…¥é—¨"><a href="#åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»å’Œå¿«é€Ÿå…¥é—¨" class="headerlink" title="åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»å’Œå¿«é€Ÿå…¥é—¨"></a>åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»å’Œå¿«é€Ÿå…¥é—¨</h1><h4 id="ä¸€ã€å¼•å…¥èƒŒæ™¯ï¼šæ‰‹åŠ¨-Redis-é”çš„å±€é™æ€§"><a href="#ä¸€ã€å¼•å…¥èƒŒæ™¯ï¼šæ‰‹åŠ¨-Redis-é”çš„å±€é™æ€§" class="headerlink" title="ä¸€ã€å¼•å…¥èƒŒæ™¯ï¼šæ‰‹åŠ¨ Redis é”çš„å±€é™æ€§"></a>ä¸€ã€å¼•å…¥èƒŒæ™¯ï¼šæ‰‹åŠ¨ Redis é”çš„å±€é™æ€§</h4><p>åŸºäº Redis <code>SETNX</code>æ‰‹åŠ¨å®ç°çš„åˆ†å¸ƒå¼é”ï¼Œå­˜åœ¨ä»¥ä¸‹æ ¸å¿ƒç¼ºé™·ï¼š</p>
<ul>
<li><strong>ä¸å¯é‡å…¥</strong>ï¼šåŒä¸€çº¿ç¨‹æ— æ³•å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼ˆå¦‚æ–¹æ³•åµŒå¥—è°ƒç”¨æ—¶ï¼Œæ˜“å¯¼è‡´æ­»é”ï¼‰ã€‚</li>
<li><strong>ä¸å¯é‡è¯•</strong>ï¼šè·å–é”å¤±è´¥åç›´æ¥è¿”å›ï¼Œæ— é‡è¯•æœºåˆ¶ï¼Œé«˜å¹¶å‘ä¸‹æˆåŠŸç‡ä½ã€‚</li>
<li><strong>è¶…æ—¶é‡Šæ”¾éšæ‚£</strong>ï¼šé”è¶…æ—¶æ—¶é—´å›ºå®šï¼Œè‹¥ä¸šåŠ¡æ‰§è¡Œè¶…æ—¶æ—¶é•¿ï¼Œé”ä¼šæå‰é‡Šæ”¾ï¼Œå¼•å‘å¹¶å‘å®‰å…¨é—®é¢˜ã€‚</li>
<li><strong>ä¸»ä»ä¸€è‡´æ€§é—®é¢˜</strong>ï¼šRedis ä¸»ä»åŒæ­¥æœ‰å»¶è¿Ÿï¼Œä¸»æœºå®•æœºåä»æœºå‡ä¸»ï¼Œé”æ•°æ®å¯èƒ½ä¸¢å¤±ï¼Œå¯¼è‡´é”å¤±æ•ˆã€‚</li>
</ul>
<h4 id="äºŒã€Redisson-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#äºŒã€Redisson-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="äºŒã€Redisson æ˜¯ä»€ä¹ˆï¼Ÿ"></a>äºŒã€Redisson æ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>Redisson æ˜¯<strong>åŸºäº Redis çš„ Java é©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰</strong>ï¼Œä¸ä»…å°è£…äº† Redis çš„åŸºç¡€æ“ä½œï¼Œè¿˜æä¾›ä¸°å¯Œçš„<strong>åˆ†å¸ƒå¼æœåŠ¡</strong>ï¼ˆå¦‚åˆ†å¸ƒå¼é”ã€é›†åˆã€å¯¹è±¡ç­‰ï¼‰ã€‚å…¶ä¸­ï¼Œ<strong>åˆ†å¸ƒå¼é”çš„å¢å¼ºå®ç°</strong>è§£å†³äº†æ‰‹åŠ¨é”çš„ç¼ºé™·ï¼Œæ”¯æŒå¯é‡å…¥ã€å¯é‡è¯•ã€è‡ªåŠ¨ç»­æœŸç­‰ä¼ä¸šçº§ç‰¹æ€§ã€‚</p>
<h4 id="ä¸‰ã€Redisson-å¿«é€Ÿä½¿ç”¨ï¼ˆä»¥-â€œç§’æ€ä¸€äººä¸€å•â€-ä¸ºä¾‹ï¼‰"><a href="#ä¸‰ã€Redisson-å¿«é€Ÿä½¿ç”¨ï¼ˆä»¥-â€œç§’æ€ä¸€äººä¸€å•â€-ä¸ºä¾‹ï¼‰" class="headerlink" title="ä¸‰ã€Redisson å¿«é€Ÿä½¿ç”¨ï¼ˆä»¥ â€œç§’æ€ä¸€äººä¸€å•â€ ä¸ºä¾‹ï¼‰"></a>ä¸‰ã€Redisson å¿«é€Ÿä½¿ç”¨ï¼ˆä»¥ â€œç§’æ€ä¸€äººä¸€å•â€ ä¸ºä¾‹ï¼‰</h4><h5 id="1-å¼•å…¥ä¾èµ–"><a href="#1-å¼•å…¥ä¾èµ–" class="headerlink" title="1. å¼•å…¥ä¾èµ–"></a>1. å¼•å…¥ä¾èµ–</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span> <span class="comment">&lt;!-- ç‰ˆæœ¬æŒ‰éœ€é€‰æ‹© --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-é…ç½®-Redisson-å®¢æˆ·ç«¯"><a href="#2-é…ç½®-Redisson-å®¢æˆ·ç«¯" class="headerlink" title="2. é…ç½® Redisson å®¢æˆ·ç«¯"></a>2. é…ç½® Redisson å®¢æˆ·ç«¯</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">         <span class="comment">// å•èŠ‚ç‚¹é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒå¯æ›¿æ¢ä¸ºé›†ç¾¤/å“¨å…µé…ç½®ï¼‰</span></span><br><span class="line">        config.useSingleServer()</span><br><span class="line">              .setAddress(<span class="string">&quot;redis://127.0.0.1:6379&quot;</span>) <span class="comment">// Redisåœ°å€</span></span><br><span class="line">              .setPassword(<span class="string">&quot;your-redis-password&quot;</span>) <span class="comment">// è‹¥æœ‰å¯†ç </span></span><br><span class="line">              .setDatabase(<span class="number">0</span>); <span class="comment">// æ•°æ®åº“ç´¢å¼•</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-ä¸šåŠ¡ä¸­é›†æˆåˆ†å¸ƒå¼é”"><a href="#3-ä¸šåŠ¡ä¸­é›†æˆåˆ†å¸ƒå¼é”" class="headerlink" title="3. ä¸šåŠ¡ä¸­é›†æˆåˆ†å¸ƒå¼é”"></a>3. ä¸šåŠ¡ä¸­é›†æˆåˆ†å¸ƒå¼é”</h5><p>ä»¥ â€œç§’æ€ä¸‹å•ï¼Œé™åˆ¶ä¸€äººä¸€å•â€ ä¸ºä¾‹ï¼Œç”¨ Redisson é”æ›¿æ¢æ‰‹åŠ¨é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//åˆ›å»ºé”å¯¹è±¡ è¿™ä¸ªä»£ç ä¸ç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨è¦ä½¿ç”¨åˆ†å¸ƒå¼é”</span></span><br><span class="line">        <span class="comment">//SimpleRedisLock lock = new SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–â€œç”¨æˆ·ç»´åº¦â€çš„åˆ†å¸ƒå¼é”ï¼ˆé”Keyï¼šlock:order:ç”¨æˆ·IDï¼‰</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°è¯•åŠ é”ï¼šæœ€å¤šç­‰å¾…1ç§’ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´10ç§’</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡AOPä»£ç†æ‰§è¡Œäº‹åŠ¡æ–¹æ³•ï¼ˆä¿è¯äº‹åŠ¡åœ¨é”çš„èŒƒå›´å†…ï¼‰</span></span><br><span class="line">            <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// æœ€ç»ˆé‡Šæ”¾é”ï¼ˆæ— è®ºä¸šåŠ¡æˆåŠŸ/å¤±è´¥ï¼Œé¿å…é”æ³„æ¼ï¼‰</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹åŠ¡æ–¹æ³•ï¼šåˆ›å»ºè®¢å•ï¼ˆçœç•¥å…·ä½“é€»è¾‘ï¼‰</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">// ...æŸ¥è¯¢è®¢å•ã€æ‰£å‡åº“å­˜ã€åˆ›å»ºè®¢å•ç­‰é€»è¾‘...</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">	<span class="keyword">synchronized</span>(userId.toString().intern())&#123;</span><br><span class="line">         <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 7.2.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å››ã€Redisson-é”çš„æ ¸å¿ƒä¼˜åŠ¿"><a href="#å››ã€Redisson-é”çš„æ ¸å¿ƒä¼˜åŠ¿" class="headerlink" title="å››ã€Redisson é”çš„æ ¸å¿ƒä¼˜åŠ¿"></a>å››ã€Redisson é”çš„æ ¸å¿ƒä¼˜åŠ¿</h4><ol>
<li><strong>å¯é‡å…¥</strong>ï¼šæ”¯æŒåŒä¸€çº¿ç¨‹å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼ˆå†…éƒ¨é€šè¿‡ â€œçº¿ç¨‹ ID + é‡å…¥æ¬¡æ•°â€ è®°å½•ï¼Œé¿å…æ–¹æ³•åµŒå¥—å¯¼è‡´çš„æ­»é”ï¼‰ã€‚</li>
<li><strong>å¯é‡è¯•</strong>ï¼š<code>tryLock</code>æ”¯æŒ â€œç­‰å¾…æ—¶é—´â€ï¼ŒæœŸé—´è‡ªåŠ¨é‡è¯•è·å–é”ï¼Œæå‡é«˜å¹¶å‘ä¸‹çš„æˆåŠŸç‡ã€‚</li>
<li><strong>è‡ªåŠ¨ç»­æœŸï¼ˆçœ‹é—¨ç‹—æœºåˆ¶ï¼‰</strong>ï¼šè‹¥ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é”çš„è¶…æ—¶æ—¶é—´ï¼ŒRedisson ä¼š<strong>è‡ªåŠ¨å»¶é•¿é”çš„è¿‡æœŸæ—¶é—´</strong>ï¼ˆé»˜è®¤æ¯éš” 30 ç§’ç»­æœŸä¸€æ¬¡ï¼Œç»­æœŸè‡³ 30 ç§’ï¼‰ï¼Œä¿è¯ä¸šåŠ¡æ‰§è¡ŒæœŸé—´é”ä¸æå‰é‡Šæ”¾ã€‚</li>
<li><strong>ä¸»ä»ä¸€è‡´æ€§ä¼˜åŒ–</strong>ï¼šé€šè¿‡ â€œçº¢é”ï¼ˆRedLockï¼‰â€ æœºåˆ¶ï¼Œåº”å¯¹ Redis ä¸»ä»åŒæ­¥å»¶è¿Ÿé—®é¢˜ï¼ˆå¤šèŠ‚ç‚¹åŠ é”ï¼Œå¤šæ•°èŠ‚ç‚¹æˆåŠŸæ‰ç®—åŠ é”æˆåŠŸï¼‰ã€‚</li>
<li><strong>ä¸°å¯Œçš„é”ç±»å‹</strong>ï¼šé™¤åŸºç¡€å¯é‡å…¥é”ï¼Œè¿˜æ”¯æŒå…¬å¹³é”ã€è”é”ã€çº¢é”ã€è¯»å†™é”ç­‰ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚ï¼ˆå¦‚è¯»å¤šå†™å°‘åœºæ™¯ç”¨<code>ReadWriteLock</code>æå‡å¹¶å‘ï¼‰ã€‚</li>
</ol>
<h4 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h4><p>Redisson æ˜¯ä¼ä¸šçº§åˆ†å¸ƒå¼é”çš„ä¼˜é€‰æ–¹æ¡ˆï¼Œè§£å†³äº†æ‰‹åŠ¨åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”çš„è¯¸å¤šç¼ºé™·ã€‚é€šè¿‡å°è£… â€œå¯é‡å…¥ã€å¯é‡è¯•ã€è‡ªåŠ¨ç»­æœŸâ€ ç­‰å®Œå–„çš„é”æœºåˆ¶ï¼Œä¸ºç§’æ€ã€è®¢å•ç­‰é«˜å¹¶å‘åœºæ™¯æä¾›äº†å®‰å…¨ã€é«˜æ•ˆçš„å¹¶å‘æ§åˆ¶èƒ½åŠ›ã€‚</p>
<h1 id="å¯é‡å…¥é”ã€é”é‡è¯•ã€çœ‹é—¨ç‹—æœºåˆ¶ã€MutiLock"><a href="#å¯é‡å…¥é”ã€é”é‡è¯•ã€çœ‹é—¨ç‹—æœºåˆ¶ã€MutiLock" class="headerlink" title="å¯é‡å…¥é”ã€é”é‡è¯•ã€çœ‹é—¨ç‹—æœºåˆ¶ã€MutiLock"></a>å¯é‡å…¥é”ã€é”é‡è¯•ã€çœ‹é—¨ç‹—æœºåˆ¶ã€MutiLock</h1><h4 id="ä¸€ã€å¯é‡å…¥é”åŸç†"><a href="#ä¸€ã€å¯é‡å…¥é”åŸç†" class="headerlink" title="ä¸€ã€å¯é‡å…¥é”åŸç†"></a>ä¸€ã€å¯é‡å…¥é”åŸç†</h4><p>Redisson é€šè¿‡ <strong>Redis Hash ç»“æ„</strong> å®ç°åˆ†å¸ƒå¼å¯é‡å…¥é”ï¼š</p>
<ul>
<li><p><strong>å­˜å‚¨ç»“æ„</strong>ï¼šä»¥ â€œé”åç§°â€ ä¸ºå¤§ Keyï¼Œâ€œ<code>çº¿ç¨‹ID + æ ‡è¯†</code>â€ ä¸ºå° Keyï¼Œ<code>Value</code>ä¸º<strong>é‡å…¥æ¬¡æ•°</strong>ã€‚</p>
<ul>
<li><table>
<thead>
<tr>
<th align="center">KEY</th>
<th align="center">VALUE</th>
</tr>
</thead>
<tbody><tr>
<td align="center">KEY(å¤§key)</td>
<td align="center">field (å°key)                    |                       value(é‡å…¥æ¬¡æ•°)</td>
</tr>
<tr>
<td align="center">lock</td>
<td align="center">thread1                                                             1</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
<li><p>åŠ é”é€»è¾‘ï¼ˆLua è„šæœ¬åŸå­æ‰§è¡Œï¼‰ï¼š</p>
<ol>
<li>è‹¥é”ä¸å­˜åœ¨ï¼ˆå¤§ Key ä¸å­˜åœ¨ï¼‰ï¼Œåˆ™åˆ›å»º Hash å¹¶è®¾ç½®<code>é‡å…¥æ¬¡æ•°=1</code>ï¼ŒåŒæ—¶è®¾ç½®é”è¶…æ—¶æ—¶é—´ï¼›</li>
<li>è‹¥é”å·²å­˜åœ¨ä¸”å° Key åŒ¹é…ï¼ˆå½“å‰çº¿ç¨‹æŒæœ‰ï¼‰ï¼Œåˆ™<code>é‡å…¥æ¬¡æ•°+1</code>ï¼Œå¹¶é‡ç½®é”è¶…æ—¶æ—¶é—´ï¼›</li>
<li>è‹¥é”å·²å­˜åœ¨ä½†å° Key ä¸åŒ¹é…ï¼ˆå…¶ä»–çº¿ç¨‹æŒæœ‰ï¼‰ï¼Œåˆ™è¿”å›é”çš„å‰©ä½™è¶…æ—¶æ—¶é—´ï¼Œè§¦å‘é‡è¯•é€»è¾‘ã€‚</li>
</ol>
</li>
<li><p><strong>ä½œç”¨</strong>ï¼šæ”¯æŒçº¿ç¨‹åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ â€œåµŒå¥—è·å–åŒä¸€æŠŠé”â€ï¼Œé¿å…åµŒå¥—è°ƒç”¨å¯¼è‡´çš„æ­»é”ï¼Œä¸<code>ReentrantLock</code>çš„å¯é‡å…¥ç‰¹æ€§ä¸€è‡´ã€‚</p>
</li>
</ul>
<h5 id="å¯é‡å…¥é”ç¤ºä¾‹ï¼ˆè§£å†³åµŒå¥—åŠ é”é—®é¢˜ï¼‰"><a href="#å¯é‡å…¥é”ç¤ºä¾‹ï¼ˆè§£å†³åµŒå¥—åŠ é”é—®é¢˜ï¼‰" class="headerlink" title="å¯é‡å…¥é”ç¤ºä¾‹ï¼ˆè§£å†³åµŒå¥—åŠ é”é—®é¢˜ï¼‰"></a>å¯é‡å…¥é”ç¤ºä¾‹ï¼ˆè§£å†³åµŒå¥—åŠ é”é—®é¢˜ï¼‰</h5><p><strong>åœºæ™¯</strong>ï¼šåŒä¸€çº¿ç¨‹åœ¨åµŒå¥—æ–¹æ³•ä¸­å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼Œä¸ä¼šæ­»é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantLockDemo</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤–å±‚æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">outerMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–é”ï¼ˆé”åç§°ï¼š&quot;reentrant:lock&quot;ï¼‰</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;reentrant:lock&quot;</span>);</span><br><span class="line">        lock.lock(); <span class="comment">// åŠ é”ï¼ˆé»˜è®¤å¯ç”¨çœ‹é—¨ç‹—æœºåˆ¶ï¼Œè¶…æ—¶30ç§’è‡ªåŠ¨ç»­æœŸï¼‰</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¤–å±‚æ–¹æ³•è·å–é”æˆåŠŸ&quot;</span>);</span><br><span class="line">            innerMethod(); <span class="comment">// è°ƒç”¨å†…å±‚æ–¹æ³•ï¼ˆä¼šå†æ¬¡è·å–åŒä¸€æŠŠé”ï¼‰</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock(); <span class="comment">// é‡Šæ”¾é”ï¼ˆé‡å…¥æ¬¡æ•°-1ï¼Œæœ€ç»ˆå‡ä¸º0æ—¶çœŸæ­£é‡Šæ”¾ï¼‰</span></span><br><span class="line">            System.out.println(<span class="string">&quot;å¤–å±‚æ–¹æ³•é‡Šæ”¾é”&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…å±‚æ–¹æ³•ï¼ˆåµŒå¥—åŠ é”ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">innerMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;reentrant:lock&quot;</span>);</span><br><span class="line">        lock.lock(); <span class="comment">// å†æ¬¡è·å–åŒä¸€æŠŠé”ï¼ˆé‡å…¥æ¬¡æ•°+1ï¼‰</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å†…å±‚æ–¹æ³•è·å–é”æˆåŠŸï¼ˆå¯é‡å…¥ç‰¹æ€§ï¼‰&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock(); <span class="comment">// é‡Šæ”¾é”ï¼ˆé‡å…¥æ¬¡æ•°-1ï¼‰</span></span><br><span class="line">            System.out.println(<span class="string">&quot;å†…å±‚æ–¹æ³•é‡Šæ”¾é”&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ¸å¿ƒç‚¹</strong>ï¼šRedisson é€šè¿‡ Hash ç»“æ„è®°å½• â€œçº¿ç¨‹æ ‡è¯†â€ å’Œ â€œé‡å…¥æ¬¡æ•°â€ï¼Œæ”¯æŒåŒä¸€çº¿ç¨‹å¤šæ¬¡åŠ é”ï¼Œé¿å…æ­»é”ã€‚</p>
<h4 id="äºŒã€é‡è¯•ã€çœ‹é—¨ç‹—ï¼ˆWatchDogï¼‰æœºåˆ¶"><a href="#äºŒã€é‡è¯•ã€çœ‹é—¨ç‹—ï¼ˆWatchDogï¼‰æœºåˆ¶" class="headerlink" title="äºŒã€é‡è¯•ã€çœ‹é—¨ç‹—ï¼ˆWatchDogï¼‰æœºåˆ¶"></a>äºŒã€é‡è¯•ã€çœ‹é—¨ç‹—ï¼ˆWatchDogï¼‰æœºåˆ¶</h4><h5 id="ä¸€ã€æºç è§£æ-æŠ¢é”ä¸é‡è¯•æœºåˆ¶"><a href="#ä¸€ã€æºç è§£æ-æŠ¢é”ä¸é‡è¯•æœºåˆ¶" class="headerlink" title="ä¸€ã€æºç è§£æ æŠ¢é”ä¸é‡è¯•æœºåˆ¶"></a>ä¸€ã€<u>æºç </u>è§£æ æŠ¢é”ä¸é‡è¯•æœºåˆ¶</h5><p><code>lock()</code>æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘æ˜¯<strong>ä¸æ–­å°è¯•è·å–é”ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢</strong>ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><p><strong>åˆå§‹æŠ¢é”åˆ¤æ–­</strong></p>
<p>é¦–å…ˆé€šè¿‡<code>tryAcquire()</code>æ–¹æ³•å°è¯•è·å–é”ï¼Œå†…éƒ¨é€šè¿‡ Redis å‘½ä»¤åˆ¤æ–­é”çš„çŠ¶æ€ï¼š</p>
<ul>
<li>è‹¥é”ä¸å­˜åœ¨ï¼šç›´æ¥åˆ›å»ºé”ï¼ˆè®°å½•å½“å‰çº¿ç¨‹ ID å’Œé‡å…¥æ¬¡æ•°ï¼‰ï¼Œè¿”å›<code>null</code>è¡¨ç¤ºæŠ¢é”æˆåŠŸã€‚</li>
<li>è‹¥é”å·²å­˜åœ¨ä¸”å±äºå½“å‰çº¿ç¨‹ï¼šæ‰§è¡Œé‡å…¥é€»è¾‘ï¼ˆå¢åŠ é‡å…¥æ¬¡æ•°ï¼‰ï¼Œè¿”å›<code>null</code>è¡¨ç¤ºé‡å…¥æˆåŠŸã€‚</li>
<li>è‹¥é”å·²å­˜åœ¨ä¸”å±äºå…¶ä»–çº¿ç¨‹ï¼šè¿”å›é”çš„å‰©ä½™è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰ï¼Œè¡¨ç¤ºæŠ¢é”å¤±è´¥ã€‚</li>
</ul>
</li>
<li><p><strong>å¾ªç¯é‡è¯•æœºåˆ¶</strong></p>
<p>å½“<code>tryAcquire()</code>è¿”å› TTLï¼ˆæŠ¢é”å¤±è´¥ï¼‰æ—¶ï¼Œ<code>lock()</code>æ–¹æ³•ä¼šè¿›å…¥<code>while(true)</code>å¾ªç¯ï¼Œä¸æ–­é‡å¤è°ƒç”¨<code>tryAcquire()</code>é‡è¯•æŠ¢é”ã€‚</p>
<ul>
<li>é‡è¯•é—´éš”ä¼šæ ¹æ®é”çš„å‰©ä½™ TTL åŠ¨æ€è°ƒæ•´ï¼ˆé¿å…æ— æ•ˆè‡ªæ—‹æµªè´¹èµ„æºï¼‰ã€‚</li>
<li>ç›´åˆ°æˆåŠŸè·å–é”ï¼ˆè¿”å›<code>null</code>ï¼‰æ‰ä¼šé€€å‡ºå¾ªç¯ï¼Œä¿è¯æœ€ç»ˆä¸€å®šèƒ½æ‹¿åˆ°é”ï¼ˆåªè¦æŒæœ‰é”çš„çº¿ç¨‹æœ€ç»ˆä¼šé‡Šæ”¾ï¼‰ã€‚</li>
</ul>
</li>
</ol>
<h5 id="äºŒã€æºç è§£æ-WatchDogï¼ˆçœ‹é—¨ç‹—ï¼‰æœºåˆ¶"><a href="#äºŒã€æºç è§£æ-WatchDogï¼ˆçœ‹é—¨ç‹—ï¼‰æœºåˆ¶" class="headerlink" title="äºŒã€æºç è§£æ WatchDogï¼ˆçœ‹é—¨ç‹—ï¼‰æœºåˆ¶"></a>äºŒã€<u>æºç </u>è§£æ WatchDogï¼ˆçœ‹é—¨ç‹—ï¼‰æœºåˆ¶</h5><p>WatchDogè§£å†³ â€œ<strong>ä¸šåŠ¡æ‰§è¡Œæ—¶é—´ &gt; é”è¶…æ—¶æ—¶é—´</strong>â€ å¯¼è‡´çš„é”æå‰é‡Šæ”¾é—®é¢˜ï¼ŒRedisson æä¾›è‡ªåŠ¨ç»­æœŸæœºåˆ¶ï¼š</p>
<ul>
<li><p><strong>è§¦å‘æ¡ä»¶</strong></p>
<p>ä»…å½“ä½¿ç”¨<strong>æ— å‚<code>lock()</code>æ–¹æ³•</strong>æ—¶å¯ç”¨ï¼ˆæ­¤æ—¶<code>leaseTime = -1</code>ï¼‰ã€‚è‹¥è°ƒç”¨å¸¦å‚<code>lock(leaseTime)</code>ï¼ˆæŒ‡å®šè¿‡æœŸæ—¶é—´ï¼‰ï¼Œåˆ™ä¸å¯ç”¨ WatchDogï¼Œé”ä¼šåœ¨<code>leaseTime</code>åè‡ªåŠ¨é‡Šæ”¾ã€‚</p>
</li>
<li><p><strong>é»˜è®¤é…ç½®</strong></p>
<p>çœ‹é—¨ç‹—çš„é»˜è®¤è¶…æ—¶æ—¶é—´ä¸º 30 ç§’ï¼ˆå¯é€šè¿‡<code>lockWatchdogTimeout</code>é…ç½®ï¼‰ï¼Œå³åˆå§‹é”çš„è¿‡æœŸæ—¶é—´ä¸º 30 ç§’ã€‚</p>
</li>
<li><p><strong>ç»­çº¦é€»è¾‘</strong></p>
<p>å½“æŠ¢é”æˆåŠŸåï¼Œé€šè¿‡<code>scheduleExpirationRenewal()</code>å¼€å¯ç»­çº¦ä»»åŠ¡ï¼Œæ ¸å¿ƒæ˜¯<code>renewExpiration()</code>æ–¹æ³•ï¼š</p>
<ul>
<li>å¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”<code>internalLockLeaseTime / 3</code>ï¼ˆå³ 10 ç§’ï¼‰æ‰§è¡Œä¸€æ¬¡ã€‚</li>
<li>ä»»åŠ¡é€»è¾‘ï¼šè°ƒç”¨<code>renewExpirationAsync()</code>é€šè¿‡ Redis å‘½ä»¤å°†é”çš„è¿‡æœŸæ—¶é—´é‡æ–°è®¾ç½®ä¸º 30 ç§’ã€‚</li>
<li>è‹¥ç»­çº¦æˆåŠŸï¼Œé€’å½’è°ƒç”¨<code>renewExpiration()</code>ï¼Œç»§ç»­è®¾ç½®ä¸‹ä¸€ä¸ª 10 ç§’åçš„å®šæ—¶ä»»åŠ¡ï¼Œå½¢æˆ â€œæ— é™ç»­çº¦â€ã€‚</li>
</ul>
</li>
<li><p><strong>è‡ªåŠ¨ç»ˆæ­¢æ¡ä»¶</strong></p>
<ul>
<li>å½“çº¿ç¨‹é‡Šæ”¾é”ï¼ˆè°ƒç”¨<code>unlock()</code>ï¼‰æ—¶ï¼Œä¼šä»<code>EXPIRATION_RENEWAL_MAP</code>ä¸­ç§»é™¤å¯¹åº”çš„ç»­çº¦ä»»åŠ¡ï¼Œåœæ­¢ç»­çº¦ã€‚</li>
<li>è‹¥æŒæœ‰é”çš„çº¿ç¨‹å®•æœºï¼Œå®šæ—¶ä»»åŠ¡æ— æ³•ç»§ç»­æ‰§è¡Œï¼Œç»­çº¦ç»ˆæ­¢ï¼Œé”ä¼šåœ¨ 30 ç§’åè‡ªåŠ¨è¿‡æœŸé‡Šæ”¾ï¼Œé¿å…æ­»é”</li>
</ul>
</li>
</ul>
<h5 id="ä¸‰ã€æ ¸å¿ƒé€»è¾‘æ€»ç»“"><a href="#ä¸‰ã€æ ¸å¿ƒé€»è¾‘æ€»ç»“" class="headerlink" title="ä¸‰ã€æ ¸å¿ƒé€»è¾‘æ€»ç»“"></a>ä¸‰ã€æ ¸å¿ƒé€»è¾‘æ€»ç»“</h5><ol>
<li><strong>æŠ¢é”ä¸é‡è¯•</strong>ï¼šé€šè¿‡<code>while(true)</code>å¾ªç¯ä¸æ–­è°ƒç”¨<code>tryAcquire()</code>ï¼Œç›´åˆ°æˆåŠŸè·å–é”ï¼Œç¡®ä¿æœ€ç»ˆèƒ½æ‹¿åˆ°é”ã€‚</li>
<li><strong>WatchDog ç»­çº¦</strong>ï¼šæ— å‚<code>lock()</code>æ—¶ï¼Œé»˜è®¤ 30 ç§’è¿‡æœŸï¼Œæ¯ 10 ç§’è‡ªåŠ¨ç»­çº¦ä¸€æ¬¡ï¼Œä¿è¯ä¸šåŠ¡æœªå®Œæˆæ—¶é”ä¸ä¼šæå‰é‡Šæ”¾ã€‚</li>
<li><strong>å®‰å…¨æ€§ä¿éšœ</strong>ï¼šçº¿ç¨‹å®•æœºåç»­çº¦ç»ˆæ­¢ï¼Œé”è‡ªåŠ¨è¿‡æœŸï¼›æ˜¾å¼é‡Šæ”¾é”æ—¶ç»ˆæ­¢ç»­çº¦ï¼Œé¿å…èµ„æºæ³„éœ²</li>
</ol>
<h5 id="å››ã€çœ‹é—¨ç‹—æœºåˆ¶ç¤ºä¾‹ï¼ˆè‡ªåŠ¨ç»­æœŸï¼Œé˜²æ­¢é”æå‰é‡Šæ”¾ï¼‰"><a href="#å››ã€çœ‹é—¨ç‹—æœºåˆ¶ç¤ºä¾‹ï¼ˆè‡ªåŠ¨ç»­æœŸï¼Œé˜²æ­¢é”æå‰é‡Šæ”¾ï¼‰" class="headerlink" title="å››ã€çœ‹é—¨ç‹—æœºåˆ¶ç¤ºä¾‹ï¼ˆè‡ªåŠ¨ç»­æœŸï¼Œé˜²æ­¢é”æå‰é‡Šæ”¾ï¼‰"></a>å››ã€çœ‹é—¨ç‹—æœºåˆ¶ç¤ºä¾‹ï¼ˆè‡ªåŠ¨ç»­æœŸï¼Œé˜²æ­¢é”æå‰é‡Šæ”¾ï¼‰</h5><p><strong>åœºæ™¯</strong>ï¼šä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼ˆè¶…è¿‡åˆå§‹é”è¶…æ—¶æ—¶é—´ï¼‰ï¼Œé”ä¼šè‡ªåŠ¨ç»­æœŸï¼Œä¿è¯ä¸šåŠ¡å®Œæˆå‰ä¸é‡Šæ”¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WatchDogDemo</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">longTimeBusiness</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;watchdog:lock&quot;</span>);</span><br><span class="line">        <span class="comment">// æ— å‚lock()ï¼šé»˜è®¤å¯ç”¨çœ‹é—¨ç‹—ï¼Œåˆå§‹è¶…æ—¶30ç§’ï¼Œæ¯10ç§’è‡ªåŠ¨ç»­æœŸ</span></span><br><span class="line">        lock.lock(); </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è·å–é”æˆåŠŸï¼Œå¼€å§‹æ‰§è¡Œé•¿æ—¶é—´ä¸šåŠ¡...&quot;</span>);</span><br><span class="line">            <span class="comment">// æ¨¡æ‹Ÿä¸šåŠ¡æ‰§è¡Œ40ç§’ï¼ˆè¶…è¿‡åˆå§‹30ç§’è¶…æ—¶ï¼‰</span></span><br><span class="line">            Thread.sleep(<span class="number">40000</span>); </span><br><span class="line">            System.out.println(<span class="string">&quot;ä¸šåŠ¡æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock(); <span class="comment">// ä¸šåŠ¡å®Œæˆåæ‰‹åŠ¨é‡Šæ”¾é”</span></span><br><span class="line">            System.out.println(<span class="string">&quot;é‡Šæ”¾é”&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ¸å¿ƒç‚¹</strong>ï¼š</p>
<ul>
<li>è‹¥ä¸šåŠ¡æœªæ‰§è¡Œå®Œï¼ŒRedisson ä¼šæ¯éš” 10 ç§’è‡ªåŠ¨å°†é”è¶…æ—¶æ—¶é—´é‡ç½®ä¸º 30 ç§’ï¼ˆæ— éœ€æ‰‹åŠ¨ç»­æœŸï¼‰ï¼›</li>
<li>è‹¥çº¿ç¨‹å®•æœºï¼Œçœ‹é—¨ç‹—çº¿ç¨‹ä¹Ÿä¼šç»ˆæ­¢ï¼Œé”æœ€ç»ˆä¼šè¶…æ—¶é‡Šæ”¾ï¼ˆé¿å…æ­»é”ï¼‰ã€‚</li>
</ul>
<h4 id="ä¸‰ã€MultiLockï¼ˆçº¢é”ï¼‰åŸç†"><a href="#ä¸‰ã€MultiLockï¼ˆçº¢é”ï¼‰åŸç†" class="headerlink" title="ä¸‰ã€MultiLockï¼ˆçº¢é”ï¼‰åŸç†"></a>ä¸‰ã€MultiLockï¼ˆçº¢é”ï¼‰åŸç†</h4><p>ä¸ºè§£å†³ Redis<strong>ä¸»ä»åŒæ­¥å»¶è¿Ÿ</strong>å¯¼è‡´çš„é”ä¸¢å¤±é—®é¢˜ï¼ˆå¦‚ä¸»æœºå®•æœºåï¼Œä»æœºå‡ä¸»ä½†æœªåŒæ­¥é”æ•°æ®ï¼‰ï¼ŒRedisson æä¾›å¤šèŠ‚ç‚¹åŠ é”çš„<code>MultiLock</code>ï¼š</p>
<ul>
<li><strong>æ ¸å¿ƒé€»è¾‘</strong>ï¼šè¦æ±‚åœ¨<strong>å¤šä¸ªç‹¬ç«‹çš„ Redis èŠ‚ç‚¹</strong>ï¼ˆéä¸»ä»æ¶æ„ï¼‰ä¸ŠåŒæ—¶åŠ é”ï¼Œåªæœ‰<strong>è¶…è¿‡åŠæ•°èŠ‚ç‚¹åŠ é”æˆåŠŸ</strong>ï¼Œæ‰ç®—æ•´ä½“åŠ é”æˆåŠŸï¼›é‡Šæ”¾æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹çš„é”éƒ½ä¼šè¢«é‡Šæ”¾ã€‚</li>
<li><strong>å¯é æ€§ä¿è¯</strong>ï¼šå³ä½¿éƒ¨åˆ† Redis èŠ‚ç‚¹æ•…éšœï¼Œåªè¦å¤šæ•°èŠ‚ç‚¹æ­£å¸¸ï¼Œå°±èƒ½ä¿è¯é”çš„å®‰å…¨æ€§ï¼ˆç±»ä¼¼ â€œåˆ†å¸ƒå¼å…±è¯†â€ï¼‰ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¯¹é”å¯é æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼ˆå¦‚é‡‘èäº¤æ˜“ï¼‰ï¼Œé€šè¿‡å¤šèŠ‚ç‚¹å†—ä½™æå‡é”çš„å®¹é”™æ€§ã€‚</li>
</ul>
<h5 id="MultiLock-ç¤ºä¾‹ï¼ˆè§£å†³ä¸»ä»ä¸€è‡´æ€§é—®é¢˜ï¼‰"><a href="#MultiLock-ç¤ºä¾‹ï¼ˆè§£å†³ä¸»ä»ä¸€è‡´æ€§é—®é¢˜ï¼‰" class="headerlink" title="MultiLock ç¤ºä¾‹ï¼ˆè§£å†³ä¸»ä»ä¸€è‡´æ€§é—®é¢˜ï¼‰"></a>MultiLock ç¤ºä¾‹ï¼ˆè§£å†³ä¸»ä»ä¸€è‡´æ€§é—®é¢˜ï¼‰</h5><p><strong>åœºæ™¯</strong>ï¼šé€šè¿‡å¤šèŠ‚ç‚¹åŠ é”ï¼Œç¡®ä¿ Redis ä¸»ä»åˆ‡æ¢æ—¶é”ä¸ä¸¢å¤±ï¼ˆéœ€éƒ¨ç½²å¤šä¸ªç‹¬ç«‹ Redis èŠ‚ç‚¹ï¼‰ã€‚</p>
<p><strong>1. é…ç½®å¤šèŠ‚ç‚¹ Redisson å®¢æˆ·ç«¯</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RedissonClient <span class="title function_">redissonMultiNodeClient</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">    <span class="comment">// é…ç½®3ä¸ªç‹¬ç«‹çš„RedisèŠ‚ç‚¹ï¼ˆéä¸»ä»å…³ç³»ï¼‰</span></span><br><span class="line">    config.useClusterServers()</span><br><span class="line">          .addNodeAddress(</span><br><span class="line">              <span class="string">&quot;redis://127.0.0.1:6379&quot;</span>,</span><br><span class="line">              <span class="string">&quot;redis://127.0.0.1:6380&quot;</span>,</span><br><span class="line">              <span class="string">&quot;redis://127.0.0.1:6381&quot;</span></span><br><span class="line">          );</span><br><span class="line">    <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2. ä½¿ç”¨ MultiLock</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiLockDemo</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonMultiNodeClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">multiLockBusiness</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–3ä¸ªèŠ‚ç‚¹çš„é”ï¼ˆé”åç§°éœ€ä¸€è‡´ï¼‰</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> redissonMultiNodeClient.getLock(<span class="string">&quot;multi:lock&quot;</span>);</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock2</span> <span class="operator">=</span> redissonMultiNodeClient.getLock(<span class="string">&quot;multi:lock&quot;</span>);</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock3</span> <span class="operator">=</span> redissonMultiNodeClient.getLock(<span class="string">&quot;multi:lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºMultiLockï¼ˆç»„åˆ3ä¸ªèŠ‚ç‚¹çš„é”ï¼‰</span></span><br><span class="line">        <span class="type">RedissonMultiLock</span> <span class="variable">multiLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedissonMultiLock</span>(lock1, lock2, lock3);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ é”ï¼šéœ€æ‰€æœ‰èŠ‚ç‚¹åŠ é”æˆåŠŸæ‰ç®—æˆåŠŸï¼ˆé»˜è®¤è¶…æ—¶30ç§’ï¼Œå¯ç”¨çœ‹é—¨ç‹—ï¼‰</span></span><br><span class="line">        multiLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;MultiLockåŠ é”æˆåŠŸï¼Œæ‰§è¡Œæ ¸å¿ƒä¸šåŠ¡...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            multiLock.unlock(); <span class="comment">// é‡Šæ”¾æ‰€æœ‰èŠ‚ç‚¹çš„é”</span></span><br><span class="line">            System.out.println(<span class="string">&quot;MultiLocké‡Šæ”¾é”&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ¸å¿ƒç‚¹</strong>ï¼š</p>
<ul>
<li>MultiLock è¦æ±‚<strong>æ‰€æœ‰èŠ‚ç‚¹åŠ é”æˆåŠŸ</strong>æ‰ç®—æ•´ä½“åŠ é”æˆåŠŸï¼›</li>
<li>å³ä½¿æŸä¸€èŠ‚ç‚¹å®•æœºï¼Œå…¶ä»–èŠ‚ç‚¹ä»æŒæœ‰é”ï¼Œé¿å…é”ä¸¢å¤±ï¼ˆé€‚åˆé«˜å¯é æ€§åœºæ™¯ï¼‰ã€‚</li>
</ul>
<h3 id="å¸¸ç”¨-API-è¯´æ˜"><a href="#å¸¸ç”¨-API-è¯´æ˜" class="headerlink" title="å¸¸ç”¨ API è¯´æ˜"></a>å¸¸ç”¨ API è¯´æ˜</h3><table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ä½œç”¨</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td><code>lock()</code></td>
<td>åŠ é”ï¼ˆé»˜è®¤ 30 ç§’è¶…æ—¶ï¼Œè‡ªåŠ¨ç»­æœŸï¼‰</td>
<td><code>lock.lock();</code></td>
</tr>
<tr>
<td><code>lock(long leaseTime, TimeUnit unit)</code></td>
<td>åŠ é”ï¼ˆæŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œä¸è‡ªåŠ¨ç»­æœŸï¼‰</td>
<td><code>lock.lock(10, TimeUnit.SECONDS);</code></td>
</tr>
<tr>
<td><code>tryLock(long waitTime, long leaseTime, TimeUnit unit)</code></td>
<td>å°è¯•åŠ é”ï¼ˆæœ€å¤šç­‰å¾… waitTimeï¼Œè¶…æ—¶é‡Šæ”¾ï¼‰</td>
<td><code>boolean success = lock.tryLock(5, 10, TimeUnit.SECONDS);</code></td>
</tr>
<tr>
<td><code>unlock()</code></td>
<td>é‡Šæ”¾é”</td>
<td><code>lock.unlock();</code></td>
</tr>
</tbody></table>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>Redisson é€šè¿‡<strong>å¯é‡å…¥ç»“æ„ã€çœ‹é—¨ç‹—ç»­æœŸã€MultiLock å¤šèŠ‚ç‚¹å…±è¯†</strong>ï¼Œè§£å†³äº†æ‰‹åŠ¨ Redis é”çš„ â€œä¸å¯é‡å…¥ã€è¶…æ—¶å¤±æ§ã€ä¸»ä»ä¸€è‡´æ€§â€ ç­‰ç¼ºé™·ï¼Œæ˜¯ä¼ä¸šçº§åˆ†å¸ƒå¼é”çš„æˆç†Ÿè§£å†³æ–¹æ¡ˆã€‚</p>
</div>

    
    <section class="post-copyright">
      
      <p class="copyright-item">
        <span>ä½œè€…:</span>
        <span>è€æ±Ÿæ¹–</span>
      </p>
        
      <p class="copyright-item">
        <span>è®¸å¯è¯:</span>
        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
      </p>
       
      <p class="copyright-item">
        <span>å£å·:</span>
        <span><strong>ä»£ç æ˜¯å¼€æºçš„,æˆ‘ä»¬åªæ˜¯å®ƒçš„æ¬è¿å·¥ã€‚</strong></span>
      </p>
       
        <p class="copyright-item">
        <span>å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œè¯·éšæ„è½¬è½½ï¼Œæ„Ÿè°¢æ”¯æŒï¼</span>
      </p>
      
             
        <p class="copyright-item">
        <span>å¦‚æœ‰ä¾µæƒè¯·å‘ŠçŸ¥åˆ é™¤ğŸ™</span>
      </p>
             
        <p class="copyright-item">
        <span>å¦‚æœä½ æœ‰å¾ˆå¥½çš„æƒ³æ³•ğŸ’¡ï¼Œè¯·åŠ¡å¿…è”ç³»æˆ‘ã€‚ </span>
        <br>
         <span>2292360909@qq.com</span>
      </p>
    </section>
    
    <section class="post-tags">
      <div>
        <span>æ ‡ç­¾:</span>
        <span class="tag">
          
        </span>
      </div>
      <div>
        <a href="javascript:window.history.back();">è¿”å›</a>
        <span>Â· </span>
        <a href="/">é¦–é¡µ</a>
      </div>
    </section>
    <section class="post-nav">
      
      <a class="prev" rel="prev" href="/2025/10/12/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/05-%E4%BC%98%E6%83%A0%E5%8D%B7%E7%A7%92%E6%9D%80/"
        >05-ä¼˜æƒ å·ç§’æ€</a
      >
       
      <a class="next" rel="next" href="/2025/10/12/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/09-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"
        >09-Redisæ¶ˆæ¯é˜Ÿåˆ—</a
      >
      
    </section>

    <!-- Giscus è¯„è®ºåŒºæŒ‚è½½ç‚¹ -->
<div id="giscus-container" style="margin-top: 2.5rem;"></div>

<!-- Giscus åŠ¨æ€åŠ è½½è„šæœ¬ï¼šåˆå§‹åŠ è½½ + æ˜æš—ä¸»é¢˜åˆ‡æ¢ -->
<script>
  function createGiscus(theme) {
    const giscusContainer = document.getElementById('giscus-container');
    if (!giscusContainer) return;

    // æ¸…é™¤æ—§çš„è¯„è®º iframe
    giscusContainer.innerHTML = '';

    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';

    // æ›¿æ¢ä¸ºä½ çš„ GitHub ä»“åº“ä¿¡æ¯ï¼ˆæ ¼å¼ï¼šusername/repoï¼‰
    script.setAttribute('data-repo', 'meisijiya/meisijiya.github.io');

   // æ›¿æ¢ä¸ºä½ çš„ repo-id å’Œ category-idï¼ˆåœ¨ giscus.app é…ç½®é¡µé¢ç”Ÿæˆï¼‰
    script.setAttribute('data-repo-id', 'R_kgDOPwTrpQ');
    script.setAttribute('data-category', 'Announcements');
    script.setAttribute('data-category-id', 'DIC_kwDOPwTrpc4CviGR');

    // å…¶ä»–å¸¸è§„æ¨èè®¾ç½®
    script.setAttribute('data-mapping', 'pathname');           // ç”¨é¡µé¢è·¯å¾„åŒ¹é…è¯„è®ºå¸–
    script.setAttribute('data-strict', '0');                   // è‹¥æ— åŒ¹é…å¸–åˆ™åˆ›å»ºæ–°å¸–
    script.setAttribute('data-reactions-enabled', '1');        // å¯ç”¨è¡¨æƒ…ååº”
    script.setAttribute('data-emit-metadata', '0');            // ä¸è¾“å‡ºå…ƒæ•°æ®
    script.setAttribute('data-input-position', 'top');         // è¾“å…¥æ¡†åœ¨è¯„è®ºä¸Šæ–¹
    script.setAttribute('data-theme', theme);                
    script.setAttribute('data-lang', 'zh-CN');                 // ä¸­æ–‡ç•Œé¢
    script.setAttribute('crossorigin', 'anonymous');           // è·¨åŸŸèµ„æºå®‰å…¨
    script.async = true;                                       
     
    giscusContainer.appendChild(script);
  }

  function getCurrentTheme() {
    return document.body.classList.contains('dark-theme') ? 'dark' : 'light';
  }

  document.addEventListener('DOMContentLoaded', () => {
    // é¡µé¢é¦–æ¬¡åŠ è½½ï¼Œæ ¹æ®å½“å‰ä¸»é¢˜æŒ‚è½½è¯„è®º
    createGiscus(getCurrentTheme());

    // ç›‘å¬æŒ‰é’®ç‚¹å‡»åˆ‡æ¢ä¸»é¢˜ â†’ é‡è½½è¯„è®ºåŒº
    const buttons = [
      document.querySelector('.toggleBtn'),
      document.getElementById('mobile-toggle-theme')
    ];
    buttons.forEach(btn => {
      if (!btn) return;
      btn.addEventListener('click', () => {
        setTimeout(() => {
          createGiscus(getCurrentTheme());
        }, 400); // ç¨ä½œå»¶è¿Ÿï¼Œç¡®ä¿ class åˆ‡æ¢å®Œæ¯•
      });
    });

    // ç›‘å¬ body class æ”¹å˜ï¼ˆä¿é™©æ–¹æ¡ˆï¼‰
    const observer = new MutationObserver(() => {
      createGiscus(getCurrentTheme());
    });
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  });
</script>

  </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Â© è€æ±Ÿæ¹– | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>
<script src="/js/code-copy.js"></script>


    </div>
</body>
<!-- umami -->
<script defer src="https://cloud.umami.is/script.js" data-website-id="91b923f2-ff2d-43d0-ba5f-bc348d82426a"></script>
</html>