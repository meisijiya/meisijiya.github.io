<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="è€æ±Ÿæ¹–">


    <meta name="subtitle" content="è®°å½•è¿›å…¥æˆ¿é—´é—¨åçš„ç¾å¥½">


    <meta name="description" content="ä¸€å¹´å‰ï¼Œå­¤è‹¦ä¼¶ä»ƒçš„è€æ±Ÿæ¹–ï¼Œå¶ç„¶é—´å‘ç°ä¸€å¤„æˆ¿é—´é—¨ï¼Œæ¨é—¨è€Œå…¥ï¼Œä»æ­¤è¿›å…¥äº†å……æ»¡å¹¸ç¦çš„ä¸–ç•Œã€‚">


    <meta name="keywords" content="è€æ±Ÿæ¹–,åšå®¢,æˆ¿é—´é—¨">


<title>05-ä¼˜æƒ å·ç§’æ€ | æ¬¢è¿æ¥åˆ°è€æ±Ÿæ¹–çš„åšå®¢</title>



    <link rel="icon" href="/images/%E9%87%91%E6%AF%9B.png?_t=1758006391547">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    
    <link rel="stylesheet" href="/css/search.css">
    

<!-- highlight.js æ ·å¼ï¼ˆé»˜è®¤äº®è‰²ï¼‰ -->
<link id="hljs-theme" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.css">
<!-- highlight.js è‡ªåŠ¨ä¸Šè‰²åŠŸèƒ½ -->
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

<link rel="stylesheet" href="/css/custom.css">



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const pagebody = document.getElementsByTagName('body')[0]

            function setTheme(status) {

                if (status === 'dark') {
                    window.sessionStorage.theme = 'dark'
                    pagebody.classList.add('dark-theme');

                } else if (status === 'light') {
                    window.sessionStorage.theme = 'light'
                    pagebody.classList.remove('dark-theme');
                }
            };

            setTheme(window.sessionStorage.theme)
        })();
    </script>

    <div class="wrapper">
        <header>
  <nav class="navbar">
    <div class="container">
      <div class="navbar-header header-logo">
        <a href="/">è€æ±Ÿæ¹–çš„åšå®¢</a>
      </div>
      <div class="menu navbar-right">
        <!-- åœ¨ç”µè„‘ç«¯çš„å¯¼èˆªé“¾æ¥åŒºåŸŸæ·»åŠ æœç´¢åŠŸèƒ½ -->
        <div class="search-container">
          <a href="javascript:;" onclick="toggleSearchInput()">ğŸ”</a>
          <input
            type="text"
            id="nav-search-input-desktop"
            class="nav-search-input"
            placeholder="æƒ³çŸ¥é“æˆ‘ä»€ä¹ˆç§˜å¯†å‘¢ï¼Œæœæœçœ‹å§"
            oninput="navSearch(this)"
          />
          <div id="nav-search-result-desktop" class="nav-search-result"></div>
        </div>

        
        <a class="menu-item" href="/archives">å½’æ¡£</a>
        
        <a class="menu-item" href="/category">åˆ†ç±»</a>
        
        <a class="menu-item" href="/tag">æ ‡ç­¾</a>
        
        <a class="menu-item" href="/Timer">ä»»åŠ¡è®¡æ—¶å™¨</a>
        
        <a class="menu-item" href="/timeLine">æ—¶é—´çº¿</a>
        
        <a class="menu-item" href="/tongji">ç½‘ç«™ç»Ÿè®¡</a>
        
        <a class="menu-item" href="/about">å…³äº</a>
        

        <input id="switch_default" type="checkbox" class="switch_default" />
        <label for="switch_default" class="toggleBtn"></label>
      </div>
    </div>
  </nav>

  
  <nav class="navbar-mobile" id="nav-mobile">
    <div class="container">
      <div class="navbar-header">
        <div>
          <a href="/">è€æ±Ÿæ¹–çš„åšå®¢</a
          ><a id="mobile-toggle-theme">Â·&nbsp;Light</a>
        </div>

        <div class="menu-toggle" onclick="mobileBtn()">
          <svg
            class="menu-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path
              fill="currentColor"
              d="M4.5 17.27q-.213 0-.356-.145T4 16.768t.144-.356t.356-.143h15q.213 0 .356.144q.144.144.144.357t-.144.356t-.356.143zm0-4.77q-.213 0-.356-.144T4 11.999t.144-.356t.356-.143h15q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-4.77q-.213 0-.356-.143Q4 7.443 4 7.23t.144-.356t.356-.143h15q.213 0 .356.144T20 7.23t-.144.356t-.356.144z"
            />
          </svg>
          <svg
            class="close-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <!-- Icon from Material Symbols Light by Google - https://github.com/google/material-design-icons/blob/master/LICENSE -->
            <path
              fill="currentColor"
              d="m12 12.708l-5.246 5.246q-.14.14-.344.15t-.364-.15t-.16-.354t.16-.354L11.292 12L6.046 6.754q-.14-.14-.15-.344t.15-.364t.354-.16t.354.16L12 11.292l5.246-5.246q.14-.14.345-.15q.203-.01.363.15t.16.354t-.16.354L12.708 12l5.246 5.246q.14.14.15.345q.01.203-.15.363t-.354.16t-.354-.16z"
            />
          </svg>
        </div>
      </div>

      <div class="menu" id="mobile-menu">
        
        <a class="menu-item" href="/archives">å½’æ¡£</a>
        
        <a class="menu-item" href="/category">åˆ†ç±»</a>
        
        <a class="menu-item" href="/tag">æ ‡ç­¾</a>
        
        <a class="menu-item" href="/Timer">ä»»åŠ¡è®¡æ—¶å™¨</a>
        
        <a class="menu-item" href="/timeLine">æ—¶é—´çº¿</a>
        
        <a class="menu-item" href="/tongji">ç½‘ç«™ç»Ÿè®¡</a>
        
        <a class="menu-item" href="/about">å…³äº</a>
        
        <!-- æ‰‹æœºæ¨¡å¼æœç´¢æ¡† -->
        <div class="search-container mobile-container">
          <a class="menu-item" href="javascript:;" onclick="toggleSearchInput()"
            >ğŸ”</a
          >
          <input
            type="text"
            id="nav-search-input-mobile"
            class="nav-search-input"
            placeholder="æƒ³çŸ¥é“æˆ‘ä»€ä¹ˆç§˜å¯†å‘¢ï¼Œæœæœçœ‹å§"
            oninput="navSearch(this)"
          />
          <div id="nav-search-result-mobile" class="nav-search-result"></div>
        </div>
      </div>
    </div>
  </nav>
</header>
<script>
  var mobileBtn = function f() {
    var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
    var mobileMenu = document.getElementById("mobile-menu");
    if (toggleMenu.classList.contains("active")) {
      toggleMenu.classList.remove("active");
      mobileMenu.classList.remove("active");
    } else {
      toggleMenu.classList.add("active");
      mobileMenu.classList.add("active");
    }
  };

  function toggleSearchInput() {
    const inputs = document.querySelectorAll(".nav-search-input");
    const results = document.querySelectorAll(".nav-search-result");
    inputs.forEach((input) => {
      input.classList.toggle("active");
      if (input.classList.contains("active")) input.focus();
    });
    results.forEach((r) => (r.style.display = "none"));
  }

  // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸéšè—æœç´¢æ¡†å’Œç»“æœå®¹å™¨çš„å‡½æ•°
  function handleClickOutsideSearch(event) {
    const searchContainers = document.querySelectorAll(".search-container");
    searchContainers.forEach((container) => {
      const searchInput = container.querySelector(".nav-search-input");
      const searchIcon = container.querySelector("a");

      // å¦‚æœç‚¹å‡»çš„å…ƒç´ ä¸æ˜¯æœç´¢è¾“å…¥æ¡†æˆ–æœç´¢å›¾æ ‡ï¼Œåˆ™éšè—æœç´¢æ¡†å’Œç»“æœå®¹å™¨
      if (
        !searchInput.contains(event.target) &&
        !searchIcon.contains(event.target)
      ) {
        searchInput.classList.remove("active");
        searchInput.value = ""
        // æ ¹æ®è¾“å…¥æ¡†IDç¡®å®šå¯¹åº”çš„ç»“æœå®¹å™¨
        let resultContainer;
        if (searchInput.id === "nav-search-input-mobile") {
          // ç§»åŠ¨ç«¯ç»“æœå®¹å™¨
          resultContainer = document.querySelector(
            ".navbar-mobile .nav-search-result"
          );
        } else {
          // æ¡Œé¢ç«¯ç»“æœå®¹å™¨
          resultContainer = document.getElementById(
            "nav-search-result-desktop"
          );
        }

        if (resultContainer) {
          resultContainer.style.display = "none";
          resultContainer.innerHTML = ""; // æ¸…ç©ºç»“æœå®¹å™¨å†…å®¹
        }
      }
    });
  }

  // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
  document.addEventListener("click", function (event) {
    handleClickOutsideSearch(event);
  });

  // æ–°å¢ï¼šæœç´¢åŠŸèƒ½å®ç°
  let searchData = []; // å…¨å±€å˜é‡å­˜å‚¨æœç´¢æ•°æ®

  // é¡µé¢åŠ è½½å®Œæˆåè·å–æœç´¢æ•°æ®
  document.addEventListener("DOMContentLoaded", function () {
    fetch("/search.xml")
      .then((res) => res.text())
      .then((xmlText) => {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "text/xml");
        const entries = xml.getElementsByTagName("entry");
        for (let entry of entries) {
          searchData.push({
            title: entry.getElementsByTagName("title")[0]?.textContent || "",
            content:
              entry.getElementsByTagName("content")[0]?.textContent || "",
            url: entry.getElementsByTagName("url")[0]?.textContent || "",
          });
        }
      })
      .catch((err) => {
        console.error("Failed to load search data:", err);
      });
  });

  // æ–°å¢ï¼šå¯¼èˆªæœç´¢æ–¹æ³•
  function navSearch(inputElement) {
    const keyword = inputElement.value.trim().toLowerCase();
    // æŸ¥æ‰¾å¯¹åº”çš„æœç´¢ç»“æœå®¹å™¨
    let resultContainer;

    if (inputElement.id === "nav-search-input-desktop") {
      // æ¡Œé¢ç«¯
      resultContainer = document.getElementById("nav-search-result-desktop");
    } else if (inputElement.id === "nav-search-input-mobile") {
      // ç§»åŠ¨ç«¯
      resultContainer =
        inputElement.parentNode.querySelector(".nav-search-result");
    }

    if (!resultContainer) return;

    resultContainer.innerHTML = "";

    if (!keyword) {
      resultContainer.style.display = "none";
      return;
    }

    // æ˜¾ç¤ºç»“æœå®¹å™¨
    resultContainer.style.display = "block";

    // è¿‡æ»¤æœç´¢æ•°æ®
    const results = searchData.filter(
      (data) =>
        (data.title && data.title.toLowerCase().includes(keyword)) ||
        (data.content && data.content.toLowerCase().includes(keyword))
    );

    if (results.length === 0) {
      resultContainer.innerHTML =
        '<p class="no-result">æ²¡æœ‰ç»“æœå“Ÿï¼Œæ¢ä¸ªå…³é”®è¯è¯•è¯•å§</p>';
      return;
    }

    // é™åˆ¶æ˜¾ç¤ºç»“æœæ•°é‡
    const maxResults = 10;
    const limitedResults = results.slice(0, maxResults);

    // æ„å»ºç»“æœHTML
    const html = limitedResults
      .map((item) => {
        // æå–åŒ…å«å…³é”®å­—çš„å†…å®¹ç‰‡æ®µ
        let contentSnippet = "";
        if (item.content) {
          // æ‰¾åˆ°åŒ…å«å…³é”®å­—çš„å†…å®¹ç‰‡æ®µ
          const contentLower = item.content.toLowerCase();
          const keywordIndex = contentLower.indexOf(keyword);

          // æå–å…³é”®å­—å‰åçš„å†…å®¹
          const start = Math.max(0, keywordIndex - 3 * keyword.length);
          const end = Math.min(
            item.content.length,
            keywordIndex + 3 * keyword.length
          );
          contentSnippet = item.content.substring(start, end);
        // é«˜äº®å…³é”®å­—
      const keywordRegex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      contentSnippet = contentSnippet.replace(
        keywordRegex,
        "<mark>$1</mark>"
      );
        }

        return `<div class="search-result-item">
  <a href="${item.url}">
    <div>æ ‡é¢˜ï¼š${item.title}</div>
    <div>å†…å®¹ï¼š${contentSnippet}</div>
  </a>
</div>`;
      })
      .join("");
    resultContainer.innerHTML = html;
  }
</script>
<style>
  /* æ‰‹æœºç«¯ä½¿ç”¨flexboxå¸ƒå±€æœç´¢å®¹å™¨ */
  .mobile-container {
    display: flex;
    align-items: center;
    flex-direction: row;
    margin-bottom: 10px;
    margin-left: 10px;
    flex-grow: 1;
    max-width: calc(100% - 40px);
  }


  .search-result-item {
  border: 1px solid #ddd; /* è¾¹æ¡† */
  margin: 4px 0; /* å¤–å±‚é—´è· */
  padding: 0; /* æ— å†…è¾¹è· */
  background: #fff; /* èƒŒæ™¯è‰² */
}

.search-result-item a {
  display: block;
  text-decoration: none;
  color: inherit;
}

.search-result-item div {
  padding: 3px 8px; /* ç´§å‡‘çš„å†…è¾¹è· */
  margin: 0; /* æ— å¤–è¾¹è· */
  line-height: 1.3; /* ç´§å‡‘çš„è¡Œé«˜ */
  word-wrap: break-word; /* å…è®¸é•¿å•è¯æ¢è¡Œ */
  white-space: normal; /* å…è®¸æ­£å¸¸æ¢è¡Œ */
}

.search-result-item div:first-child {
  border-bottom: 1px solid #eee; /* æ ‡é¢˜å’Œå†…å®¹ä¹‹é—´çš„åˆ†éš”çº¿ */
}


</style>

            <div class="main">
                <div class="container">
    <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">å±•å¼€æ‰€æœ‰</a>
        <a onclick="go_top()">è¿”å›é¡¶éƒ¨</a>
        <a onclick="go_bottom()">è¿”å›åº•éƒ¨</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // ä¸º 6 æ—¶å±•å¼€æ‰€æœ‰
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // è¿™ä¸ªå€¼æ˜¯ç”± tocbot æºç é‡Œå®šä¹‰çš„ scrollSmoothDuration å¾—æ¥çš„
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'å±•å¼€æ‰€æœ‰' : 'æŠ˜å æ‰€æœ‰';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>  
  <article class="post-wrap">
    <header class="post-header">
      <h1 class="post-title">05-ä¼˜æƒ å·ç§’æ€</h1>
      
      <div class="post-meta">
         ä½œè€…:
        <a itemprop="author" rel="author" href="/">è€æ±Ÿæ¹–</a>
         
        <span class="post-time">
          <br />æ—¥æœŸ:
          <a href="#"
            >åæœˆ 12, 2025&nbsp;&nbsp;0:00:00</a
          >
        </span>
         
        <span class="post-category"
          ><br />
          åˆ†ç±»: 
          <a href="/categories/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/">é»‘é©¬ç‚¹è¯„</a>
          
        </span>
        
      </div>
      
    </header>

    <div class="post-content"><h1 id="åŸºäºRedisçš„å…¨å±€å”¯ä¸€IDç”Ÿæˆå™¨"><a href="#åŸºäºRedisçš„å…¨å±€å”¯ä¸€IDç”Ÿæˆå™¨" class="headerlink" title="åŸºäºRedisçš„å…¨å±€å”¯ä¸€IDç”Ÿæˆå™¨"></a>åŸºäºRedisçš„å…¨å±€å”¯ä¸€IDç”Ÿæˆå™¨</h1><h3 id="ä¸€ã€ä¸šåŠ¡èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦å…¨å±€å”¯ä¸€-IDï¼Ÿ"><a href="#ä¸€ã€ä¸šåŠ¡èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦å…¨å±€å”¯ä¸€-IDï¼Ÿ" class="headerlink" title="ä¸€ã€ä¸šåŠ¡èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦å…¨å±€å”¯ä¸€ IDï¼Ÿ"></a>ä¸€ã€ä¸šåŠ¡èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦å…¨å±€å”¯ä¸€ IDï¼Ÿ</h3><p>åœ¨é»‘é©¬ç‚¹è¯„çš„<strong>ä¼˜æƒ åˆ¸è®¢å•ä¸šåŠ¡</strong>ä¸­ï¼Œè®¢å•è¡¨è‹¥ä½¿ç”¨ MySQL è‡ªå¢ IDï¼Œä¼šé¢ä¸´ä¸¤å¤§é—®é¢˜ï¼š</p>
<ol>
<li><strong>å®‰å…¨æ€§ä¸è¶³</strong>ï¼šè‡ªå¢ ID è§„å¾‹æ€§å¼ºï¼Œæ˜“è¢«çŒœæµ‹å‡ºä¸šåŠ¡ä¿¡æ¯ï¼ˆå¦‚å•æ—¥è®¢å•é‡ï¼‰ã€‚</li>
<li><strong>æ‰©å±•æ€§ä¸è¶³</strong>ï¼šMySQL å•è¡¨å®¹é‡å»ºè®®ä¸è¶…è¿‡ 500 ä¸‡ï¼Œåˆ†åº“åˆ†è¡¨åï¼Œè‡ªå¢ ID æ— æ³•ä¿è¯<strong>å…¨å±€å”¯ä¸€æ€§</strong>ã€‚</li>
</ol>
<h3 id="äºŒã€å…¨å±€å”¯ä¸€-ID-ç”Ÿæˆå™¨çš„æ ¸å¿ƒç‰¹æ€§"><a href="#äºŒã€å…¨å±€å”¯ä¸€-ID-ç”Ÿæˆå™¨çš„æ ¸å¿ƒç‰¹æ€§" class="headerlink" title="äºŒã€å…¨å±€å”¯ä¸€ ID ç”Ÿæˆå™¨çš„æ ¸å¿ƒç‰¹æ€§"></a>äºŒã€å…¨å±€å”¯ä¸€ ID ç”Ÿæˆå™¨çš„æ ¸å¿ƒç‰¹æ€§</h3><p>ä¸€ä¸ªå¯é çš„å…¨å±€ ID ç”Ÿæˆå™¨éœ€æ»¡è¶³ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li><strong>å”¯ä¸€æ€§</strong>ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ ID ç»å¯¹ä¸é‡å¤ã€‚</li>
<li><strong>é«˜å¯ç”¨</strong>ï¼šç”Ÿæˆ ID çš„æœåŠ¡ &#x2F; ç»„ä»¶ç¨³å®šï¼Œä¸å½±å“ä¸šåŠ¡æµç¨‹ã€‚</li>
<li><strong>é«˜æ€§èƒ½</strong>ï¼šæ”¯æ’‘é«˜å¹¶å‘åœºæ™¯ï¼Œç”Ÿæˆ ID çš„é€Ÿåº¦è¶³å¤Ÿå¿«ã€‚</li>
<li><strong>é€’å¢æ€§</strong>ï¼šID å°½é‡é€’å¢ï¼ˆåˆ©äºæ•°æ®åº“ç´¢å¼•ï¼Œå¦‚ MySQL B + æ ‘çš„å†™å…¥æ€§èƒ½ï¼‰ã€‚</li>
<li><strong>å®‰å…¨æ€§</strong>ï¼šID æ— æ˜æ˜¾è§„å¾‹ï¼Œé¿å…æ³„éœ²ä¸šåŠ¡ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="ä¸‰ã€åŸºäº-Redis-çš„å…¨å±€-ID-ç»“æ„è®¾è®¡"><a href="#ä¸‰ã€åŸºäº-Redis-çš„å…¨å±€-ID-ç»“æ„è®¾è®¡" class="headerlink" title="ä¸‰ã€åŸºäº Redis çš„å…¨å±€ ID ç»“æ„è®¾è®¡"></a>ä¸‰ã€åŸºäº Redis çš„å…¨å±€ ID ç»“æ„è®¾è®¡</h3><p>ä¸ºå…¼é¡¾ â€œé€’å¢æ€§â€ å’Œ â€œå®‰å…¨æ€§â€ï¼Œé‡‡ç”¨ <strong>â€œæ—¶é—´æˆ³ + åºåˆ—å·â€</strong> çš„ç»„åˆç»“æ„ï¼š</p>
<ul>
<li><strong>ç¬¦å·ä½ï¼ˆ1bitï¼‰</strong>ï¼šå›ºå®šä¸º 0ï¼Œä¿è¯ ID ä¸ºæ­£æ•°ã€‚</li>
<li><strong>æ—¶é—´æˆ³ï¼ˆ31bitï¼‰</strong>ï¼šä»¥<strong>ç§’</strong>ä¸ºå•ä½çš„ç›¸å¯¹æ—¶é—´ï¼ˆå‡å»èµ·å§‹æ—¶é—´æˆ³<code>1640995200L</code>ï¼Œå³ 2022-01-01 00:00:00ï¼‰ï¼Œå¯ä½¿ç”¨çº¦ 69 å¹´ã€‚</li>
<li><strong>åºåˆ—å·ï¼ˆ32bitï¼‰</strong>ï¼šç§’å†…çš„è®¡æ•°å™¨ï¼Œç”± Redis åŸå­è‡ªå¢ç”Ÿæˆï¼Œæ¯ç§’å¯ç”Ÿæˆ (2^{32})ï¼ˆçº¦ 42 äº¿ï¼‰ä¸ª IDï¼Œæ”¯æ’‘è¶…é«˜å¹¶å‘ã€‚</li>
</ul>
<h3 id="å››ã€Redis-å®ç°å…¨å±€å”¯ä¸€-ID-çš„ä»£ç å‰–æ"><a href="#å››ã€Redis-å®ç°å…¨å±€å”¯ä¸€-ID-çš„ä»£ç å‰–æ" class="headerlink" title="å››ã€Redis å®ç°å…¨å±€å”¯ä¸€ ID çš„ä»£ç å‰–æ"></a>å››ã€Redis å®ç°å…¨å±€å”¯ä¸€ ID çš„ä»£ç å‰–æ</h3><p>æ ¸å¿ƒç±» <code>RedisIdWorker</code> åˆ©ç”¨ Redis çš„<strong>åŸå­è‡ªå¢</strong>ä¿è¯åºåˆ—å·å”¯ä¸€æ€§ï¼Œç»“åˆæ—¶é—´æˆ³å®ç°é€’å¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="comment">// èµ·å§‹æ—¶é—´æˆ³ï¼ˆ2022-01-01 00:00:00çš„ç§’æ•°ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BEGIN_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1640995200L</span>;</span><br><span class="line">    <span class="comment">// åºåˆ—å·çš„ä½æ•°ï¼ˆ32ä½ï¼Œå†³å®šæ¯ç§’æœ€å¤§ç”Ÿæˆé‡ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdWorker</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆç›¸å¯¹èµ·å§‹æ—¶é—´çš„ç§’æ•°ï¼Œç¼©çŸ­ä½æ•°ï¼‰</span></span><br><span class="line">        <span class="comment">//LocalDateTime.now() è¿”å›å½“å‰æ—¥æœŸå’Œæ—¶é—´ï¼ˆç²¾ç¡®åˆ°çº³ç§’ï¼‰</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="comment">//toEpochSecond(ZoneOffset.UTC) å°†å½“å‰æ—¶é—´è½¬æ¢ä¸º UTC æ—¶åŒºçš„ç§’çº§æ—¶é—´æˆ³ï¼ˆå³ä» 1970 å¹´ 1 æœˆ 1 æ—¥è‡³å½“å‰æ—¶é—´çš„æ€»ç§’æ•°ï¼‰ã€‚</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">nowSecond</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> nowSecond - BEGIN_TIMESTAMP;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. ç”Ÿæˆåºåˆ—å·ï¼ˆæŒ‰â€œå¹´:æœˆ:æ—¥â€åˆ†é”®ï¼Œä¿è¯æ¯å¤©çš„åºåˆ—å·ç‹¬ç«‹è‡ªå¢ï¼‰</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="comment">// Redis incrementæ˜¯åŸå­æ“ä½œï¼Œä¿è¯åŒä¸€ç§’å†…åºåˆ—å·å”¯ä¸€</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="string">&quot;icr:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + date);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. æ‹¼æ¥æ—¶é—´æˆ³å’Œåºåˆ—å·ï¼ˆä½è¿ç®—ï¼šæ—¶é—´æˆ³å·¦ç§»32ä½ï¼Œä¸åºåˆ—å·æŒ‰ä½æˆ–ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; COUNT_BITS | count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä»£ç å…³é”®é€»è¾‘è§£æï¼š"><a href="#ä»£ç å…³é”®é€»è¾‘è§£æï¼š" class="headerlink" title="ä»£ç å…³é”®é€»è¾‘è§£æï¼š"></a>ä»£ç å…³é”®é€»è¾‘è§£æï¼š</h4><ul>
<li><strong>æ—¶é—´æˆ³å¤„ç†</strong>ï¼šé€šè¿‡ â€œå½“å‰ç§’æ•° - èµ·å§‹ç§’æ•°â€ï¼Œå°†æ—¶é—´æˆ³èŒƒå›´ç¼©çŸ­ï¼Œå‡å°‘ä½æ•°å ç”¨ï¼ŒåŒæ—¶ä¿è¯é€’å¢æ€§ã€‚</li>
<li><strong>åºåˆ—å·ç”Ÿæˆ</strong>ï¼šåˆ©ç”¨ Redis <code>INCR</code> åŸå­æ€§ï¼ŒæŒ‰ â€œæ—¥æœŸâ€ åˆ†é”®ï¼Œç¡®ä¿<strong>åŒä¸€ç§’å†…</strong>åºåˆ—å·å”¯ä¸€ä¸”é€’å¢ï¼›è·¨å¤©è‡ªåŠ¨é‡ç½®ï¼Œé¿å…åºåˆ—å·æº¢å‡ºã€‚</li>
<li><strong>ä½è¿ç®—æ‹¼æ¥</strong>ï¼š<code>timestamp &lt;&lt; COUNT_BITS</code> å°†æ—¶é—´æˆ³å·¦ç§» 32 ä½ï¼Œç©ºå‡ºä½ 32 ä½ç»™åºåˆ—å·ï¼›å†é€šè¿‡<code>|</code>ï¼ˆæŒ‰ä½æˆ–ï¼‰å°†ä¸¤è€…åˆå¹¶ä¸ºä¸€ä¸ª<code>long</code>å‹ IDï¼Œä¿è¯ç»“æ„ç´§å‡‘ã€‚</li>
</ul>
<h3 id="äº”ã€é«˜å¹¶å‘æµ‹è¯•ä¸CountDownLatchçš„ä½œç”¨"><a href="#äº”ã€é«˜å¹¶å‘æµ‹è¯•ä¸CountDownLatchçš„ä½œç”¨" class="headerlink" title="äº”ã€é«˜å¹¶å‘æµ‹è¯•ä¸CountDownLatchçš„ä½œç”¨"></a>äº”ã€é«˜å¹¶å‘æµ‹è¯•ä¸<code>CountDownLatch</code>çš„ä½œç”¨</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_844085127/article/details/149069677">å¤šçº¿ç¨‹ä¹‹CountDownLatchè¯¦è§£_å¤šçº¿ç¨‹ countdownlatch-CSDNåšå®¢</a></p>
<p>æµ‹è¯•ä»£ç ç”¨äºéªŒè¯<strong>é«˜å¹¶å‘ä¸‹ ID ç”Ÿæˆçš„æ€§èƒ½ä¸å”¯ä¸€æ€§</strong>ï¼Œå…¶ä¸­<code>CountDownLatch</code>æ˜¯å…³é”®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testIdWorker</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–è®¡æ•°å™¨ä¸º300ï¼ˆè¡¨ç¤ºéœ€è¦300ä¸ªçº¿ç¨‹å®Œæˆåï¼Œæ‰è§£é™¤é˜»å¡ï¼‰</span></span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">300</span>);</span><br><span class="line">    <span class="comment">// æ¯ä¸ªçº¿ç¨‹ç”Ÿæˆ100ä¸ªID</span></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;id = &quot;</span> + id);</span><br><span class="line">        &#125;</span><br><span class="line">        latch.countDown(); <span class="comment">// çº¿ç¨‹å®Œæˆï¼Œè®¡æ•°å™¨å‡1</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// å¯åŠ¨300ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">300</span>; i++) &#123;</span><br><span class="line">        es.submit(task);</span><br><span class="line">    &#125;</span><br><span class="line">    latch.await(); <span class="comment">// ä¸»çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°è®¡æ•°å™¨ä¸º0</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;æ€»è€—æ—¶ = &quot;</span> + (end - begin));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CountDownLatchçš„ä½œç”¨ï¼š"><a href="#CountDownLatchçš„ä½œç”¨ï¼š" class="headerlink" title="CountDownLatchçš„ä½œç”¨ï¼š"></a><code>CountDownLatch</code>çš„ä½œç”¨ï¼š</h4><ul>
<li>åŒæ­¥å¤šçº¿ç¨‹æ‰§è¡Œï¼šè®©<strong>æ‰€æœ‰å­çº¿ç¨‹ï¼ˆ300 ä¸ªï¼‰éƒ½ç”Ÿæˆå®Œ ID å</strong>ï¼Œä¸»çº¿ç¨‹å†ç»Ÿè®¡æ€»è€—æ—¶ï¼Œä»è€Œå‡†ç¡®è¯„ä¼°é«˜å¹¶å‘æ€§èƒ½ã€‚</li>
<li>æ ¸å¿ƒæ–¹æ³•ï¼š<ul>
<li><code>countDown()</code>ï¼šå­çº¿ç¨‹å®Œæˆä»»åŠ¡åè°ƒç”¨ï¼Œè®¡æ•°å™¨å‡ 1ã€‚</li>
<li><code>await()</code>ï¼šä¸»çº¿ç¨‹è°ƒç”¨ï¼Œé˜»å¡ç›´åˆ°è®¡æ•°å™¨ä¸º 0ï¼Œå†ç»§ç»­æ‰§è¡Œã€‚</li>
</ul>
</li>
</ul>
<h3 id="å…­ã€çŸ¥è¯†ç‚¹æ‹“å±•ä¸å¯¹æ¯”"><a href="#å…­ã€çŸ¥è¯†ç‚¹æ‹“å±•ä¸å¯¹æ¯”" class="headerlink" title="å…­ã€çŸ¥è¯†ç‚¹æ‹“å±•ä¸å¯¹æ¯”"></a>å…­ã€çŸ¥è¯†ç‚¹æ‹“å±•ä¸å¯¹æ¯”</h3><h4 id="1-Redis-æ–¹æ¡ˆçš„ä¼˜åŠ¿"><a href="#1-Redis-æ–¹æ¡ˆçš„ä¼˜åŠ¿" class="headerlink" title="1. Redis æ–¹æ¡ˆçš„ä¼˜åŠ¿"></a>1. Redis æ–¹æ¡ˆçš„ä¼˜åŠ¿</h4><ul>
<li><strong>é«˜æ€§èƒ½</strong>ï¼šRedis å•å®ä¾‹ QPS å¯è¾¾ 10 ä¸‡çº§ï¼Œ<code>INCR</code>åŸå­æ“ä½œè¶³å¤Ÿå¿«ã€‚</li>
<li><strong>é«˜å¯ç”¨</strong>ï¼šå¯é€šè¿‡ Redis é›†ç¾¤ï¼ˆå¦‚ä¸»ä»ã€å“¨å…µã€Clusterï¼‰ä¿è¯æœåŠ¡ä¸å®•æœºã€‚</li>
<li><strong>é˜²é‡å¤ &#x2F; æ—¶é’Ÿé—®é¢˜</strong>ï¼šä¾èµ– Redis åŸå­è‡ªå¢ï¼Œæ—  â€œé›ªèŠ±ç®—æ³•â€ çš„æ—¶é’Ÿå›æ‹¨é£é™©ã€‚</li>
</ul>
<h4 id="2-å…¶ä»–å…¨å±€-ID-æ–¹æ¡ˆå¯¹æ¯”"><a href="#2-å…¶ä»–å…¨å±€-ID-æ–¹æ¡ˆå¯¹æ¯”" class="headerlink" title="2. å…¶ä»–å…¨å±€ ID æ–¹æ¡ˆå¯¹æ¯”"></a>2. å…¶ä»–å…¨å±€ ID æ–¹æ¡ˆå¯¹æ¯”</h4><table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td>MySQL è‡ªå¢</td>
<td>ç®€å•æ˜“å®ç°</td>
<td>è§„å¾‹æ€§å¼ºã€åˆ†åº“åˆ†è¡¨åä¸å”¯ä¸€</td>
</tr>
<tr>
<td>UUID</td>
<td>å…¨å±€å”¯ä¸€</td>
<td>æ— é€’å¢æ€§ã€å­˜å‚¨å ç©ºé—´ã€ç´¢å¼•å·®</td>
</tr>
<tr>
<td>é›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰</td>
<td>é€’å¢ã€æ€§èƒ½é«˜</td>
<td>ä¾èµ–æœºå™¨æ—¶é’Ÿï¼Œæ—¶é’Ÿå›æ‹¨ä¼šé‡å¤</td>
</tr>
<tr>
<td>åˆ†å¸ƒå¼ä¸­é—´ä»¶ï¼ˆå¦‚ Leafï¼‰</td>
<td>åŠŸèƒ½å®Œå–„ã€æ€§èƒ½ç¨³å®š</td>
<td>æ¶æ„å¤æ‚ï¼Œéœ€é¢å¤–ç»´æŠ¤ä¸­é—´ä»¶</td>
</tr>
</tbody></table>
<p>ç»¼ä¸Šï¼Œé»‘é©¬ç‚¹è¯„é€‰æ‹©<strong>Redis å®ç°å…¨å±€å”¯ä¸€ ID</strong>ï¼Œæ˜¯å…¼é¡¾ â€œè½»é‡ã€é«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€å”¯ä¸€æ€§â€ çš„æŠ˜ä¸­æ–¹æ¡ˆï¼Œç‰¹åˆ«é€‚åˆä¼˜æƒ åˆ¸ã€è®¢å•ç­‰é«˜å¹¶å‘åœºæ™¯ã€‚</p>
<h1 id="ä¼˜æƒ å·ç±»å‹ã€ç§’æ€ä¸‹å•ä¸šåŠ¡åŠå…¶è¶…å–é—®é¢˜"><a href="#ä¼˜æƒ å·ç±»å‹ã€ç§’æ€ä¸‹å•ä¸šåŠ¡åŠå…¶è¶…å–é—®é¢˜" class="headerlink" title="ä¼˜æƒ å·ç±»å‹ã€ç§’æ€ä¸‹å•ä¸šåŠ¡åŠå…¶è¶…å–é—®é¢˜"></a>ä¼˜æƒ å·ç±»å‹ã€ç§’æ€ä¸‹å•ä¸šåŠ¡åŠå…¶è¶…å–é—®é¢˜</h1><h3 id="ä¸€ã€ä¼˜æƒ åˆ¸çš„ç±»å‹ä¸æ–°å¢é€»è¾‘"><a href="#ä¸€ã€ä¼˜æƒ åˆ¸çš„ç±»å‹ä¸æ–°å¢é€»è¾‘" class="headerlink" title="ä¸€ã€ä¼˜æƒ åˆ¸çš„ç±»å‹ä¸æ–°å¢é€»è¾‘"></a>ä¸€ã€ä¼˜æƒ åˆ¸çš„ç±»å‹ä¸æ–°å¢é€»è¾‘</h3><p>é»‘é©¬ç‚¹è¯„çš„ä¼˜æƒ åˆ¸åˆ†ä¸º<strong>æ™®é€šåˆ¸</strong>å’Œ<strong>ç§’æ€åˆ¸</strong>ï¼Œå¯¹åº”ä¸åŒè¡¨ç»“æ„ä¸æ–°å¢é€»è¾‘ï¼š</p>
<table>
<thead>
<tr>
<th>ä¼˜æƒ åˆ¸ç±»å‹</th>
<th>è¡¨ç»“æ„</th>
<th>æ–°å¢é€»è¾‘</th>
</tr>
</thead>
<tbody><tr>
<td>æ™®é€šåˆ¸</td>
<td><code>tb_voucher</code>ï¼ˆå­˜åŸºç¡€ä¼˜æƒ ä¿¡æ¯ï¼‰</td>
<td>ç›´æ¥è°ƒç”¨<code>save</code>æ–¹æ³•ï¼ŒæŒä¹…åŒ–åˆ°æ•°æ®åº“å³å¯ã€‚</td>
</tr>
<tr>
<td>ç§’æ€åˆ¸</td>
<td><code>tb_voucher</code> + <code>tb_seckill_voucher</code>ï¼ˆé¢å¤–å­˜åº“å­˜ã€ç§’æ€æ—¶é—´ï¼‰</td>
<td>éœ€<strong>äº‹åŠ¡æ€§</strong>å®Œæˆ 3 æ­¥ï¼š1. ä¿å­˜åŸºç¡€ä¼˜æƒ ä¿¡æ¯åˆ°<code>tb_voucher</code>ï¼›2. ä¿å­˜ç§’æ€ä¸“å±ä¿¡æ¯ï¼ˆåº“å­˜ã€æ—¶é—´ç­‰ï¼‰åˆ°<code>tb_seckill_voucher</code>ï¼›3. <strong>åº“å­˜é¢„çƒ­åˆ° Redis</strong>ï¼ˆå°†åº“å­˜å€¼å†™å…¥ Redisï¼Œä¸ºåç»­ç§’æ€åšå‡†å¤‡ï¼‰ã€‚</td>
</tr>
</tbody></table>
<p>**æ–°å¢æ™®é€šå·ä»£ç ï¼š  **VoucherController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addVoucher</span><span class="params">(<span class="meta">@RequestBody</span> Voucher voucher)</span> &#123;</span><br><span class="line">    voucherService.save(voucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ–°å¢ç§’æ€å·ä»£ç ï¼š</strong></p>
<p><strong>VoucherController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;seckill&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addSeckillVoucher</span><span class="params">(<span class="meta">@RequestBody</span> Voucher voucher)</span> &#123;</span><br><span class="line">    voucherService.addSeckillVoucher(voucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>VoucherServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="äºŒã€ç§’æ€ä¸‹å•çš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹"><a href="#äºŒã€ç§’æ€ä¸‹å•çš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹" class="headerlink" title="äºŒã€ç§’æ€ä¸‹å•çš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹"></a>äºŒã€ç§’æ€ä¸‹å•çš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹</h3><p>ç”¨æˆ·ç‚¹å‡» â€œç§’æ€æŠ¢è´­â€ æ—¶ï¼Œåç«¯æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li><strong>æ ¡éªŒç§’æ€æ—¶é—´</strong>ï¼šåˆ¤æ–­å½“å‰æ—¶é—´æ˜¯å¦åœ¨ç§’æ€çš„<code>beginTime</code>å’Œ<code>endTime</code>ä¹‹é—´ï¼Œå¦åˆ™è¿”å› â€œç§’æ€æœªå¼€å§‹ &#x2F; å·²ç»“æŸâ€ã€‚</li>
<li><strong>æ ¡éªŒåº“å­˜</strong>ï¼šæŸ¥è¯¢<code>tb_seckill_voucher</code>ä¸­çš„åº“å­˜ï¼Œè‹¥åº“å­˜ä¸è¶³åˆ™è¿”å› â€œåº“å­˜ä¸è¶³â€ã€‚</li>
<li><strong>æ‰£å‡åº“å­˜</strong>ï¼šé€šè¿‡æ•°æ®åº“æ›´æ–°æ“ä½œæ‰£å‡åº“å­˜ï¼ˆæ­¤ç¯èŠ‚æ˜¯ â€œåº“å­˜è¶…å–é—®é¢˜â€ çš„æ ¸å¿ƒåœºæ™¯ï¼‰ã€‚</li>
<li><strong>åˆ›å»ºè®¢å•</strong>ï¼šç”¨ Redis å…¨å±€ ID ç”Ÿæˆå™¨ç”Ÿæˆå”¯ä¸€è®¢å• IDï¼Œå°†è®¢å•ä¿¡æ¯ï¼ˆç”¨æˆ· IDã€ä¼˜æƒ åˆ¸ ID ç­‰ï¼‰æŒä¹…åŒ–åˆ°<code>tb_voucher_order</code>ã€‚</li>
</ol>
<p>VoucherOrderServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 6.1.è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 6.2.ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 6.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä¸‰ã€åº“å­˜è¶…å–é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#ä¸‰ã€åº“å­˜è¶…å–é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä¸‰ã€åº“å­˜è¶…å–é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>ä¸‰ã€åº“å­˜è¶…å–é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h3><h4 id="1-é—®é¢˜åˆ†æ"><a href="#1-é—®é¢˜åˆ†æ" class="headerlink" title="1. é—®é¢˜åˆ†æ"></a>1. é—®é¢˜åˆ†æ</h4><p>é«˜å¹¶å‘ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ â€œ<strong>æŸ¥è¯¢åº“å­˜ â†’ æ‰£å‡åº“å­˜</strong>â€ æµç¨‹ï¼Œä¼šå¯¼è‡´ â€œåº“å­˜è¢«é‡å¤æ‰£å‡â€ï¼Œæœ€ç»ˆåº“å­˜ä¸ºè´Ÿï¼ˆè¶…å–ï¼‰ã€‚</p>
<p>ç¤ºä¾‹ï¼šçº¿ç¨‹ 1 æŸ¥è¯¢åº“å­˜ä¸º 1ï¼ˆæœªæ‰£å‡ï¼‰ï¼Œçº¿ç¨‹ 2 ä¹ŸæŸ¥è¯¢åˆ°åº“å­˜ä¸º 1ï¼Œéšåä¸¤çº¿ç¨‹éƒ½æ‰§è¡Œæ‰£å‡ï¼Œæœ€ç»ˆåº“å­˜å˜æˆ - 1ï¼Œè¿åä¸šåŠ¡è§„åˆ™ã€‚</p>
<h4 id="2-è§£å†³æ–¹æ¡ˆï¼šæ‚²è§‚é”-vs-ä¹è§‚é”"><a href="#2-è§£å†³æ–¹æ¡ˆï¼šæ‚²è§‚é”-vs-ä¹è§‚é”" class="headerlink" title="2. è§£å†³æ–¹æ¡ˆï¼šæ‚²è§‚é” vs ä¹è§‚é”"></a>2. è§£å†³æ–¹æ¡ˆï¼šæ‚²è§‚é” vs ä¹è§‚é”</h4><table>
<thead>
<tr>
<th>é”ç±»å‹</th>
<th>æ€è·¯</th>
<th>ä¼˜ç¼ºç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td>æ‚²è§‚é”</td>
<td>è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸€å®šä¼šå‘ç”Ÿï¼Œæ“ä½œå‰å…ˆåŠ é”ï¼ˆå¦‚<code>synchronized</code>ã€<code>Lock</code>ï¼‰ï¼Œå¼ºåˆ¶çº¿ç¨‹<strong>ä¸²è¡Œæ‰§è¡Œ</strong>ã€‚</td>
<td>ä¼˜ç‚¹ï¼šé€»è¾‘ç®€å•ï¼Œç»å¯¹ä¿è¯æ•°æ®å®‰å…¨ï¼›ç¼ºç‚¹ï¼šä¸²è¡Œæ‰§è¡Œå¯¼è‡´<strong>æ€§èƒ½å¤§å¹…ä¸‹é™</strong>ï¼Œé«˜å¹¶å‘ä¸‹ååé‡æä½ã€‚</td>
</tr>
<tr>
<td>ä¹è§‚é”</td>
<td>è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸ä¸€å®šå‘ç”Ÿï¼Œ<strong>ä¸åŠ é”</strong>ï¼Œè€Œæ˜¯é€šè¿‡ â€œç‰ˆæœ¬æ§åˆ¶â€ æˆ– â€œæ¡ä»¶æ ¡éªŒâ€ï¼Œåœ¨<strong>æ›´æ–°æ—¶éªŒè¯æ•°æ®æ˜¯å¦è¢«ç¯¡æ”¹</strong>ã€‚</td>
<td>ä¼˜ç‚¹ï¼šéé˜»å¡ï¼Œé«˜å¹¶å‘æ€§èƒ½å¥½ï¼›ç¼ºç‚¹ï¼šéœ€å¤„ç†æ›´æ–°å¤±è´¥çš„é‡è¯•æˆ–é™çº§é€»è¾‘ã€‚</td>
</tr>
</tbody></table>
<h4 id="3-ä¹è§‚é”çš„å…·ä½“å®ç°ï¼ˆè¯¾ç¨‹æ¡ˆä¾‹ï¼‰"><a href="#3-ä¹è§‚é”çš„å…·ä½“å®ç°ï¼ˆè¯¾ç¨‹æ¡ˆä¾‹ï¼‰" class="headerlink" title="3. ä¹è§‚é”çš„å…·ä½“å®ç°ï¼ˆè¯¾ç¨‹æ¡ˆä¾‹ï¼‰"></a>3. ä¹è§‚é”çš„å…·ä½“å®ç°ï¼ˆè¯¾ç¨‹æ¡ˆä¾‹ï¼‰</h4><p>ä¹è§‚é”çš„æ ¸å¿ƒæ˜¯ â€œ<strong>æ›´æ–°æ—¶å¸¦æ¡ä»¶ï¼ŒéªŒè¯æ•°æ®æœªè¢«ç¯¡æ”¹</strong>â€ã€‚è¯¾ç¨‹ä¸­ç»™å‡ºä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li><p><strong>æ–¹å¼ 1ï¼šåŸºäº â€œåº“å­˜ç›¸ç­‰â€ çš„æ¡ä»¶æ›´æ–°</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">seckillVoucherService.update()</span><br><span class="line">    .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">    .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">    .eq(<span class="string">&quot;stock&quot;</span>, voucher.getStock()) <span class="comment">// é¢„æœŸåº“å­˜ä¸æŸ¥è¯¢æ—¶ä¸€è‡´</span></span><br><span class="line">    .update();</span><br></pre></td></tr></table></figure>

<ul>
<li>é—®é¢˜ï¼šé«˜å¹¶å‘ä¸‹ï¼Œåªæœ‰ 1 ä¸ªçº¿ç¨‹èƒ½å‘½ä¸­ â€œåº“å­˜ç›¸ç­‰â€ çš„æ¡ä»¶ï¼Œå…¶ä½™çº¿ç¨‹å…¨éƒ¨å¤±è´¥ï¼Œ<strong>æˆåŠŸç‡æä½</strong>ã€‚<ul>
<li>å¤±è´¥çš„åŸå› åœ¨äºï¼šåœ¨ä½¿ç”¨ä¹è§‚é”è¿‡ç¨‹ä¸­å‡è®¾100ä¸ªçº¿ç¨‹åŒæ—¶éƒ½æ‹¿åˆ°äº†100çš„åº“å­˜ï¼Œç„¶åå¤§å®¶ä¸€èµ·å»è¿›è¡Œæ‰£å‡ï¼Œä½†æ˜¯100ä¸ªäººä¸­åªæœ‰1ä¸ªäººèƒ½æ‰£å‡æˆåŠŸï¼Œå…¶ä»–çš„äººåœ¨å¤„ç†æ—¶ï¼Œä»–ä»¬åœ¨æ‰£å‡æ—¶ï¼Œåº“å­˜å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œæ‰€ä»¥æ­¤æ—¶å…¶ä»–çº¿ç¨‹éƒ½ä¼šå¤±è´¥</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>æ–¹å¼ 2ï¼šåŸºäº â€œåº“å­˜å¤§äº 0â€ çš„æ¡ä»¶æ›´æ–°</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">seckillVoucherService.update()</span><br><span class="line">    .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">    .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">    .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// åªè¦åº“å­˜&gt;0ï¼Œå°±å°è¯•æ‰£å‡</span></span><br><span class="line">    .update();</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¼˜åŒ–ï¼šåªè¦åº“å­˜æœ‰å‰©ä½™ï¼Œå°±å…è®¸æ‰£å‡ï¼Œ<strong>æˆåŠŸç‡æ›´é«˜</strong>ï¼Œä¸”èƒ½é¿å…è¶…å–ï¼ˆ<code>gt(&quot;stock&quot;, 0)</code>ä¿è¯æ‰£å‡æ—¶åº“å­˜è‡³å°‘ä¸º 1ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h4 id="4-æ‰©å±•ï¼šLongAdder-ä¼˜åŒ–-CAS-è‡ªæ—‹å‹åŠ›"><a href="#4-æ‰©å±•ï¼šLongAdder-ä¼˜åŒ–-CAS-è‡ªæ—‹å‹åŠ›" class="headerlink" title="4. æ‰©å±•ï¼šLongAdder ä¼˜åŒ– CAS è‡ªæ—‹å‹åŠ›"></a>4. æ‰©å±•ï¼šLongAdder ä¼˜åŒ– CAS è‡ªæ—‹å‹åŠ›</h4><p>Java 8 æä¾›çš„<code>LongAdder</code>æ˜¯<code>AtomicLong</code>çš„ä¼˜åŒ–ç‰ˆï¼Œç”¨äº<strong>é«˜å¹¶å‘è®¡æ•°åœºæ™¯</strong>ï¼š</p>
<p><img src="https://oss.itbaima.cn/hub/928/image-202509258j8hrcfsz.png" alt="image-202509258j8hrcfsz"></p>
<ul>
<li>åŸç†ï¼šå¤šçº¿ç¨‹ç«äº‰æ¿€çƒˆæ—¶ï¼Œ<code>LongAdder</code>ä¼š<strong>æ‹†åˆ†å¤šä¸ª â€œcellï¼ˆåˆ†æ®µè®¡æ•°å™¨ï¼‰â€</strong>ï¼Œè®©çº¿ç¨‹åˆ†æ•£åˆ°ä¸åŒ cell æ›´æ–°ï¼Œå‡å°‘ CAS è‡ªæ—‹å†²çªï¼›æœ€ç»ˆç»“æœç”±<code>base</code>ï¼ˆåŸºç¡€è®¡æ•°å™¨ï¼‰å’Œæ‰€æœ‰<code>cell</code>ç´¯åŠ å¾—åˆ°ã€‚</li>
<li>ä¼˜åŠ¿ï¼šç›¸æ¯”<code>AtomicLong</code>çš„<strong>å…¨å±€ CAS è‡ªæ—‹</strong>ï¼Œ<code>LongAdder</code>é€šè¿‡ â€œ**<u>åˆ†æ®µ CAS</u>**â€ é™ä½ç«äº‰ï¼Œå¤§å¹…æå‡é«˜å¹¶å‘ä¸‹çš„è®¡æ•°æ€§èƒ½ã€‚</li>
</ul>
<h3 id="å››ã€æ ¸å¿ƒæ€»ç»“"><a href="#å››ã€æ ¸å¿ƒæ€»ç»“" class="headerlink" title="å››ã€æ ¸å¿ƒæ€»ç»“"></a>å››ã€æ ¸å¿ƒæ€»ç»“</h3><p>ç§’æ€åœºæ™¯çš„å…³é”®æŒ‘æˆ˜æ˜¯ **â€œé«˜å¹¶å‘ä¸‹çš„åº“å­˜å®‰å…¨â€ ä¸ â€œæ€§èƒ½â€ çš„å¹³è¡¡ **ã€‚é»‘é©¬ç‚¹è¯„é€šè¿‡ï¼š</p>
<ul>
<li>ä¹è§‚é”ï¼ˆâ€œåº“å­˜&gt; 0 æ¡ä»¶æ›´æ–°â€ï¼‰è§£å†³è¶…å–é—®é¢˜ï¼Œå…¼é¡¾æ•°æ®å®‰å…¨ä¸é«˜å¹¶å‘æ€§èƒ½ï¼›</li>
<li>Redis é¢„çƒ­åº“å­˜ã€å…¨å±€å”¯ä¸€ ID ç”Ÿæˆç­‰æŠ€æœ¯ï¼Œä¸ºç§’æ€çš„ â€œé«˜å¯ç”¨ã€é«˜æ€§èƒ½â€ æä¾›æ”¯æ’‘ã€‚</li>
</ul>
<h1 id="ä¸€äººä¸€å•"><a href="#ä¸€äººä¸€å•" class="headerlink" title="ä¸€äººä¸€å•"></a>ä¸€äººä¸€å•</h1><h2 id="å•æœºç¯å¢ƒ"><a href="#å•æœºç¯å¢ƒ" class="headerlink" title="å•æœºç¯å¢ƒ"></a>å•æœºç¯å¢ƒ</h2><h3 id="ä¸€ã€ä¸šåŠ¡éœ€æ±‚ï¼šä¼˜æƒ åˆ¸-â€œä¸€äººä¸€å•â€"><a href="#ä¸€ã€ä¸šåŠ¡éœ€æ±‚ï¼šä¼˜æƒ åˆ¸-â€œä¸€äººä¸€å•â€" class="headerlink" title="ä¸€ã€ä¸šåŠ¡éœ€æ±‚ï¼šä¼˜æƒ åˆ¸ â€œä¸€äººä¸€å•â€"></a>ä¸€ã€ä¸šåŠ¡éœ€æ±‚ï¼šä¼˜æƒ åˆ¸ â€œä¸€äººä¸€å•â€</h3><p>ä¸ºé¿å…ç”¨æˆ·é‡å¤æŠ¢è´­åŒä¸€å¼ ä¼˜æƒ åˆ¸ï¼Œéœ€é™åˆ¶<strong>åŒä¸€ç”¨æˆ·å¯¹åŒä¸€ä¼˜æƒ åˆ¸ä»…èƒ½åˆ›å»ºä¸€æ¬¡è®¢å•</strong>ã€‚</p>
<h3 id="äºŒã€æ ¸å¿ƒé—®é¢˜ä¸æ¼”è¿›"><a href="#äºŒã€æ ¸å¿ƒé—®é¢˜ä¸æ¼”è¿›" class="headerlink" title="äºŒã€æ ¸å¿ƒé—®é¢˜ä¸æ¼”è¿›"></a>äºŒã€æ ¸å¿ƒé—®é¢˜ä¸æ¼”è¿›</h3><h4 id="1-åˆå§‹é—®é¢˜ï¼šå¹¶å‘ä¸‹é‡å¤ä¸‹å•"><a href="#1-åˆå§‹é—®é¢˜ï¼šå¹¶å‘ä¸‹é‡å¤ä¸‹å•" class="headerlink" title="1. åˆå§‹é—®é¢˜ï¼šå¹¶å‘ä¸‹é‡å¤ä¸‹å•"></a>1. åˆå§‹é—®é¢˜ï¼šå¹¶å‘ä¸‹é‡å¤ä¸‹å•</h4><p>VoucherOrderServiceImpl  </p>
<p><strong>åˆæ­¥ä»£ç ï¼šå¢åŠ ä¸€äººä¸€å•é€»è¾‘</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">    <span class="comment">// 5.1.ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">    <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line"></span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç›´æ¥åœ¨ç§’æ€é€»è¾‘ä¸­æ·»åŠ  â€œæŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å·²ä¸‹å•â€ çš„æ ¡éªŒï¼Œä½†é«˜å¹¶å‘æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶æŸ¥è¯¢åˆ° â€œæ— è®¢å•â€ï¼Œä¼šåŒæ—¶æ‰§è¡Œä¸‹å•ï¼Œå¯¼è‡´é‡å¤ã€‚</li>
</ul>
<h4 id="2-å°è¯•æ–¹æ¡ˆï¼šåŠ æ‚²è§‚é”ï¼ˆä½†ç²’åº¦å¤ªç²—ï¼‰"><a href="#2-å°è¯•æ–¹æ¡ˆï¼šåŠ æ‚²è§‚é”ï¼ˆä½†ç²’åº¦å¤ªç²—ï¼‰" class="headerlink" title="2. å°è¯•æ–¹æ¡ˆï¼šåŠ æ‚²è§‚é”ï¼ˆä½†ç²’åº¦å¤ªç²—ï¼‰"></a>2. å°è¯•æ–¹æ¡ˆï¼šåŠ æ‚²è§‚é”ï¼ˆä½†ç²’åº¦å¤ªç²—ï¼‰</h4><p>ç»™åˆå§‹æ–¹æ¡ˆå°è£…äº†ä¸€ä¸ªcreateVoucherOrderæ–¹æ³•ï¼ŒåŒæ—¶ä¸ºäº†ç¡®ä¿ä»–çº¿ç¨‹å®‰å…¨ï¼Œåœ¨æ–¹æ³•ä¸Šæ·»åŠ äº†ä¸€æŠŠsynchronized é”</p>
<p>ç»™ <code>createVoucherOrder</code> æ–¹æ³•åŠ  <code>synchronized</code>ï¼Œä½†æ‰€æœ‰ç”¨æˆ·å…±äº«<strong>åŒä¸€æŠŠé”</strong>ï¼Œè¯·æ±‚ä¸²è¡Œæ‰§è¡Œï¼Œæ€§èƒ½æå·®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">         <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 7.2.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-ä¼˜åŒ–é”ç²’åº¦ï¼šç”¨æˆ·ç»´åº¦çš„é”"><a href="#3-ä¼˜åŒ–é”ç²’åº¦ï¼šç”¨æˆ·ç»´åº¦çš„é”" class="headerlink" title="3. ä¼˜åŒ–é”ç²’åº¦ï¼šç”¨æˆ·ç»´åº¦çš„é”"></a>3. ä¼˜åŒ–é”ç²’åº¦ï¼šç”¨æˆ·ç»´åº¦çš„é”</h4><p>ä½¿ç”¨ <code>userId.toString().intern()</code> ä½œä¸ºé”å¯¹è±¡ï¼š</p>
<ul>
<li><code>userId.toString()</code> ç”Ÿæˆçš„æ˜¯<u>æ–°å­—ç¬¦ä¸²å¯¹è±¡</u>ï¼Œä¸åŒçº¿ç¨‹çš„åŒä¸€ç”¨æˆ· ID ä¼šå›  â€œæ–°å¯¹è±¡â€ å¯¼è‡´é”æ— æ•ˆï¼›</li>
<li>è°ƒç”¨ <code>intern()</code> åï¼Œå­—ç¬¦ä¸²ä»<strong>å¸¸é‡æ± </strong>è·å–å”¯ä¸€å®ä¾‹ï¼Œä¿è¯ â€œåŒä¸€ç”¨æˆ·ç«äº‰åŒä¸€æŠŠé”ï¼Œä¸åŒç”¨æˆ·ä¸äº’æ–¥â€ï¼Œå¤§å¹…æå‡å¹¶å‘åº¦ã€‚</li>
</ul>
<h4 id="4-äº‹åŠ¡ä¸é”çš„å†²çªï¼šä»£ç†ä¸äº‹åŠ¡èŒƒå›´"><a href="#4-äº‹åŠ¡ä¸é”çš„å†²çªï¼šä»£ç†ä¸äº‹åŠ¡èŒƒå›´" class="headerlink" title="4. äº‹åŠ¡ä¸é”çš„å†²çªï¼šä»£ç†ä¸äº‹åŠ¡èŒƒå›´"></a>4. äº‹åŠ¡ä¸é”çš„å†²çªï¼šä»£ç†ä¸äº‹åŠ¡èŒƒå›´</h4><h5 id="ä¸€ã€Spring-äº‹åŠ¡çš„-â€œä»£ç†ç”Ÿæ•ˆâ€-åŸç†"><a href="#ä¸€ã€Spring-äº‹åŠ¡çš„-â€œä»£ç†ç”Ÿæ•ˆâ€-åŸç†" class="headerlink" title="ä¸€ã€Spring äº‹åŠ¡çš„ â€œä»£ç†ç”Ÿæ•ˆâ€ åŸç†"></a>ä¸€ã€Spring äº‹åŠ¡çš„ â€œä»£ç†ç”Ÿæ•ˆâ€ åŸç†</h5><p><code>@Transactional</code> æ˜¯é€šè¿‡ <strong>ä»£ç†æ¨¡å¼</strong> å®ç°çš„ï¼ˆJDK åŠ¨æ€ä»£ç†æˆ– CGLIB å­ç±»ä»£ç†ï¼‰ï¼š</p>
<ul>
<li>å½“è°ƒç”¨è¢« <code>@Transactional</code> ä¿®é¥°çš„æ–¹æ³•æ—¶ï¼Œ<strong>ä»£ç†å¯¹è±¡</strong> ä¼šå…ˆå¯åŠ¨äº‹åŠ¡ï¼Œå†æ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼Œæœ€åæ ¹æ®æ‰§è¡Œç»“æœæäº¤ &#x2F; å›æ»šäº‹åŠ¡ã€‚</li>
<li>å¦‚æœç›´æ¥é€šè¿‡ <code>this</code>ï¼ˆç›®æ ‡å¯¹è±¡è‡ªèº«ï¼‰è°ƒç”¨äº‹åŠ¡æ–¹æ³•ï¼Œ<strong>ä¸ä¼šç»è¿‡ä»£ç†</strong>ï¼Œäº‹åŠ¡é€»è¾‘ä¸ä¼šç”Ÿæ•ˆï¼ˆç›¸å½“äºæ™®é€šæ–¹æ³•è°ƒç”¨ï¼‰ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>â€œä»£ç†å¤±æ•ˆâ€œåœºæ™¯</th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody><tr>
<td>å†…éƒ¨æ–¹æ³•è°ƒç”¨</td>
<td>æ³¨å…¥è‡ªèº«ä»£ç†å¯¹è±¡ï¼ˆ<code>AopContext.currentProxy()</code>ï¼‰</td>
</tr>
<tr>
<td>é public æ–¹æ³•</td>
<td>æ”¹ä¸º public æ–¹æ³•</td>
</tr>
<tr>
<td>final&#x2F;static æ–¹æ³•</td>
<td>é‡æ„ä¸ºå®ä¾‹æ–¹æ³•</td>
</tr>
<tr>
<td>é Spring Bean</td>
<td>æ·»åŠ  <code>@Component</code> ç­‰æ³¨è§£</td>
</tr>
<tr>
<td>å¤šçº¿ç¨‹è°ƒç”¨</td>
<td>ä½¿ç”¨ <code>@Async</code> + äº‹åŠ¡ä¼ æ’­</td>
</tr>
<tr>
<td>å¼‚å¸¸ç±»å‹ä¸åŒ¹é…</td>
<td>æ˜¾å¼æŒ‡å®š <code>rollbackFor</code></td>
</tr>
</tbody></table>
<h5 id="äºŒã€â€œé”åœ¨æ–¹æ³•å†…â€-çš„å†²çªé—®é¢˜"><a href="#äºŒã€â€œé”åœ¨æ–¹æ³•å†…â€-çš„å†²çªé—®é¢˜" class="headerlink" title="äºŒã€â€œé”åœ¨æ–¹æ³•å†…â€ çš„å†²çªé—®é¢˜"></a>äºŒã€â€œé”åœ¨æ–¹æ³•å†…â€ çš„å†²çªé—®é¢˜</h5><p>è‹¥é”çš„èŒƒå›´ä»…åŒ…è£¹ â€œç›®æ ‡æ–¹æ³•å†…éƒ¨ä»£ç â€ï¼Œè€Œäº‹åŠ¡ç”±ä»£ç†æ§åˆ¶ï¼Œä¼šå‡ºç°ä»¥ä¸‹æ—¶åºé—®é¢˜ï¼š</p>
<ol>
<li>çº¿ç¨‹ A è·å–é”ï¼Œè°ƒç”¨ä»£ç†æ–¹æ³• â†’ ä»£ç†å¯åŠ¨äº‹åŠ¡ï¼Œæ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼ˆæ‰£å‡åº“å­˜ã€åˆ›å»ºè®¢å•ï¼‰ã€‚</li>
<li>çº¿ç¨‹ A æ‰§è¡Œå®Œç›®æ ‡æ–¹æ³•ï¼Œ<strong>é‡Šæ”¾é”</strong> â†’ ä½†ä»£ç†çš„ â€œäº‹åŠ¡æäº¤â€ è¿˜æœªæ‰§è¡Œï¼ˆäº‹åŠ¡æäº¤åœ¨ä»£ç†æ–¹æ³•çš„æœ€åä¸€æ­¥ï¼‰ã€‚</li>
<li>çº¿ç¨‹ B è·å–é”ï¼Œè°ƒç”¨ä»£ç†æ–¹æ³• â†’ æ­¤æ—¶çº¿ç¨‹ A çš„äº‹åŠ¡æœªæäº¤ï¼Œçº¿ç¨‹ B æŸ¥ä¸åˆ°çº¿ç¨‹ A æœªæäº¤çš„è®¢å•ï¼Œä¼šé‡å¤ä¸‹å•ã€‚</li>
</ol>
<h5 id="ä¸‰ã€è§£å†³æ–¹æ¡ˆï¼šç”¨ä»£ç†å¯¹è±¡ä¿è¯-â€œé”åŒ…è£¹äº‹åŠ¡â€"><a href="#ä¸‰ã€è§£å†³æ–¹æ¡ˆï¼šç”¨ä»£ç†å¯¹è±¡ä¿è¯-â€œé”åŒ…è£¹äº‹åŠ¡â€" class="headerlink" title="ä¸‰ã€è§£å†³æ–¹æ¡ˆï¼šç”¨ä»£ç†å¯¹è±¡ä¿è¯ â€œé”åŒ…è£¹äº‹åŠ¡â€"></a>ä¸‰ã€è§£å†³æ–¹æ¡ˆï¼šç”¨ä»£ç†å¯¹è±¡ä¿è¯ â€œé”åŒ…è£¹äº‹åŠ¡â€</h5><p>é€šè¿‡ <code>AopContext.currentProxy()</code> è·å–<strong>å½“å‰å¯¹è±¡çš„ä»£ç†å®ä¾‹</strong>ï¼Œå†é€šè¿‡ä»£ç†è°ƒç”¨äº‹åŠ¡æ–¹æ³•ï¼Œç¡®ä¿ï¼š</p>
<ul>
<li>é”çš„èŒƒå›´ <strong>åŒ…å«æ•´ä¸ªäº‹åŠ¡è¿‡ç¨‹</strong>ï¼ˆä» â€œäº‹åŠ¡å¯åŠ¨â€ åˆ° â€œäº‹åŠ¡æäº¤ &#x2F; å›æ»šâ€ï¼‰ã€‚</li>
<li>äº‹åŠ¡é€šè¿‡ä»£ç†ç”Ÿæ•ˆï¼Œä¸”åœ¨é”çš„ä¿æŠ¤ä¸‹æ‰§è¡Œï¼Œé¿å… â€œé”é‡Šæ”¾åäº‹åŠ¡æ‰æäº¤â€ å¯¼è‡´çš„è„è¯»ã€‚</li>
</ul>
<p>ä»£ç ç¤ºä¾‹çš„æ ¸å¿ƒé€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (userId.toString().intern()) &#123; <span class="comment">// 1. åŠ ç”¨æˆ·ç»´åº¦çš„é”</span></span><br><span class="line">    <span class="comment">// 2. è·å–å½“å‰Serviceçš„ä»£ç†å¯¹è±¡ï¼ˆå«äº‹åŠ¡å¢å¼ºé€»è¾‘ï¼‰</span></span><br><span class="line">    <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="comment">// 3. é€šè¿‡ä»£ç†è°ƒç”¨æ–¹æ³• â†’ äº‹åŠ¡åœ¨ä»£ç†ä¸­å¯åŠ¨ï¼Œä¸”è¢«é”åŒ…è£¹</span></span><br><span class="line">    <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="å››ã€å…³é”®ç»“è®º"><a href="#å››ã€å…³é”®ç»“è®º" class="headerlink" title="å››ã€å…³é”®ç»“è®º"></a>å››ã€å…³é”®ç»“è®º</h5><ul>
<li>Spring äº‹åŠ¡çš„ç”Ÿæ•ˆä¾èµ–<strong>ä»£ç†è°ƒç”¨</strong>ï¼Œç›´æ¥ <code>this.æ–¹æ³•()</code> ä¼šç»•è¿‡ä»£ç†ï¼Œå¯¼è‡´äº‹åŠ¡å¤±æ•ˆã€‚</li>
<li>è¦è®© â€œé”ä¿æŠ¤äº‹åŠ¡çš„åŸå­æ€§â€ï¼Œéœ€é€šè¿‡ <code>AopContext</code> è·å–ä»£ç†å¯¹è±¡ï¼Œä¿è¯<strong>é”çš„èŒƒå›´åŒ…å«æ•´ä¸ªäº‹åŠ¡è¿‡ç¨‹</strong>ï¼Œè§£å†³ â€œé”é‡Šæ”¾åäº‹åŠ¡æ‰æäº¤â€ çš„å¹¶å‘é—®é¢˜ã€‚</li>
</ul>
<h3 id="ä¸‰ã€æœ€ç»ˆè§£å†³æ–¹æ¡ˆä¸ä»£ç å‰–æ"><a href="#ä¸‰ã€æœ€ç»ˆè§£å†³æ–¹æ¡ˆä¸ä»£ç å‰–æ" class="headerlink" title="ä¸‰ã€æœ€ç»ˆè§£å†³æ–¹æ¡ˆä¸ä»£ç å‰–æ"></a>ä¸‰ã€æœ€ç»ˆè§£å†³æ–¹æ¡ˆä¸ä»£ç å‰–æ</h3><h4 id="1-æ ¸å¿ƒé€»è¾‘ï¼šé”-äº‹åŠ¡-ä»£ç†ååŒ"><a href="#1-æ ¸å¿ƒé€»è¾‘ï¼šé”-äº‹åŠ¡-ä»£ç†ååŒ" class="headerlink" title="1. æ ¸å¿ƒé€»è¾‘ï¼šé” + äº‹åŠ¡ + ä»£ç†ååŒ"></a>1. æ ¸å¿ƒé€»è¾‘ï¼šé” + äº‹åŠ¡ + ä»£ç†ååŒ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// çœç•¥â€œç§’æ€æ—¶é—´æ ¡éªŒã€åº“å­˜æ ¡éªŒâ€ç­‰é€»è¾‘...</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// ç”¨ç”¨æˆ·IDçš„internå­—ç¬¦ä¸²åšé”ï¼Œä¿è¯åŒä¸€ç”¨æˆ·ç«äº‰åŒä¸€æŠŠé”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰Serviceçš„ä»£ç†å¯¹è±¡ï¼ˆå«äº‹åŠ¡å¢å¼ºï¼‰</span></span><br><span class="line">        <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="comment">// é€šè¿‡ä»£ç†è°ƒç”¨ï¼Œä¿è¯äº‹åŠ¡åœ¨é”å†…æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 1. æ ¡éªŒï¼šæŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å·²ä¸‹å•</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ä¸‹å•ï¼Œæ— æ³•é‡å¤è´­ä¹°&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æ‰£å‡åº“å­˜ï¼ˆä¹è§‚é”ï¼Œé˜²æ­¢è¶…å–ï¼‰</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">            .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// åº“å­˜&gt;0æ‰æ‰£å‡</span></span><br><span class="line">            .update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    order.setId(redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>));</span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    order.setVoucherId(voucherId);</span><br><span class="line">    save(order);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(order.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-å…³é”®æŠ€æœ¯ç‚¹å‰–æ"><a href="#2-å…³é”®æŠ€æœ¯ç‚¹å‰–æ" class="headerlink" title="2. å…³é”®æŠ€æœ¯ç‚¹å‰–æ"></a>2. å…³é”®æŠ€æœ¯ç‚¹å‰–æ</h4><ul>
<li><strong><code>intern()</code> ä¿è¯é”çš„å”¯ä¸€æ€§</strong>ï¼š<code>String.intern()</code> ä»å¸¸é‡æ± è¿”å›å”¯ä¸€å®ä¾‹ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ· ID çš„é”å¯¹è±¡å”¯ä¸€ï¼Œå®ç° â€œç”¨æˆ·ç»´åº¦æ’ä»–é”â€ï¼Œæ—¢ä¿è¯å®‰å…¨åˆå‡å°‘é”ç«äº‰ã€‚</li>
<li><strong><code>AopContext.currentProxy()</code> ååŒäº‹åŠ¡ä¸é”</strong>ï¼šé€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ <code>createVoucherOrder</code>ï¼Œè®©<strong>äº‹åŠ¡çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ˆåŒ…æ‹¬æäº¤ï¼‰è¢«åŒ…å«åœ¨é”å†…</strong>ï¼Œé¿å… â€œé”é‡Šæ”¾åäº‹åŠ¡æ‰æäº¤â€ å¯¼è‡´çš„è„è¯»ã€‚</li>
<li><strong>äº‹åŠ¡ + ä¹è§‚é”çš„åŒé‡ä¿éšœ</strong>ï¼š<code>@Transactional</code> ä¿è¯ â€œæŸ¥è¯¢ - æ‰£å‡åº“å­˜ - åˆ›å»ºè®¢å•â€ çš„åŸå­æ€§ï¼›æ‰£å‡åº“å­˜æ—¶ç”¨ä¹è§‚é”ï¼ˆ<code>gt(&quot;stock&quot;, 0)</code>ï¼‰ï¼Œè¿›ä¸€æ­¥é˜²æ­¢åº“å­˜è¶…å–ã€‚</li>
</ul>
<h3 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h3><p>â€œä¸€äººä¸€å•â€ éœ€æ±‚çš„æ ¸å¿ƒæ˜¯ **â€œå¹¶å‘å®‰å…¨ã€æ€§èƒ½ã€äº‹åŠ¡ä¸€è‡´æ€§â€ çš„å¹³è¡¡ **ï¼š</p>
<ul>
<li>ç”¨<strong>ç”¨æˆ·ç»´åº¦çš„æ‚²è§‚é”</strong>ï¼ˆ<code>synchronized + intern</code>ï¼‰è§£å†³é‡å¤ä¸‹å•çš„å¹¶å‘é—®é¢˜ï¼ŒåŒæ—¶æ§åˆ¶é”ç²’åº¦æå‡æ€§èƒ½ï¼›</li>
<li>ç”¨<strong>Spring ä»£ç†ä¸äº‹åŠ¡çš„ååŒ</strong>ï¼ˆ<code>AopContext</code>ï¼‰ä¿è¯ â€œé”å†…äº‹åŠ¡å®Œæ•´â€ï¼Œé¿å…è„è¯»ï¼›</li>
<li>ç»“åˆ<strong>ä¹è§‚é”æ‰£å‡åº“å­˜</strong>ï¼ŒåŒé‡ä¿éšœæ•°æ®ä¸€è‡´æ€§ã€‚</li>
</ul>
<p>å•æœºæ¨¡å¼ä¸‹ï¼Œé€šè¿‡ï¼š</p>
<ol>
<li><code>userId.toString().intern()</code> å®ç°ç”¨æˆ·çº§åˆ«çš„é”ç²’åº¦æ§åˆ¶ï¼›</li>
<li><code>@EnableAspectJAutoProxy(exposeProxy = true)</code> æš´éœ²ä»£ç†å¯¹è±¡ï¼Œç¡®ä¿äº‹åŠ¡åœ¨é”å†…ç”Ÿæ•ˆï¼›</li>
<li>ç»“åˆ <code>synchronized</code> ä¸ä¹è§‚é”ï¼Œå¯è§£å†³ â€œä¸€äººä¸€å•â€ çš„å¹¶å‘å®‰å…¨é—®é¢˜ã€‚</li>
</ol>
<p>ä½†é›†ç¾¤ç¯å¢ƒéœ€è¿›ä¸€æ­¥å¼•å…¥åˆ†å¸ƒå¼é”ï¼Œçªç ´å•æœºé”çš„èŒƒå›´é™åˆ¶ã€‚</p>
<h3 id="å•æœºç¯å¢ƒä¸‹-â€œä¸€äººä¸€å•â€-çš„å®Œæ•´é…ç½®"><a href="#å•æœºç¯å¢ƒä¸‹-â€œä¸€äººä¸€å•â€-çš„å®Œæ•´é…ç½®" class="headerlink" title="å•æœºç¯å¢ƒä¸‹ â€œä¸€äººä¸€å•â€ çš„å®Œæ•´é…ç½®"></a>å•æœºç¯å¢ƒä¸‹ â€œä¸€äººä¸€å•â€ çš„å®Œæ•´é…ç½®</h3><p>è¦è®© <code>synchronized(userId.toString().intern())</code> ç»“åˆäº‹åŠ¡æ­£å¸¸ç”Ÿæ•ˆï¼Œéœ€å®Œæˆä»¥ä¸‹é…ç½®ï¼Œæ ¸å¿ƒæ˜¯<strong>æš´éœ²ä»£ç†å¯¹è±¡</strong>ä»¥ä¾¿åœ¨é”å†…è°ƒç”¨äº‹åŠ¡æ–¹æ³•ï¼š</p>
<h4 id="1-æ·»åŠ -AspectJ-ä¾èµ–ï¼ˆæ”¯æŒ-AOP-ä»£ç†æš´éœ²ï¼‰"><a href="#1-æ·»åŠ -AspectJ-ä¾èµ–ï¼ˆæ”¯æŒ-AOP-ä»£ç†æš´éœ²ï¼‰" class="headerlink" title="1. æ·»åŠ  AspectJ ä¾èµ–ï¼ˆæ”¯æŒ AOP ä»£ç†æš´éœ²ï¼‰"></a>1. æ·»åŠ  AspectJ ä¾èµ–ï¼ˆæ”¯æŒ AOP ä»£ç†æš´éœ²ï¼‰</h4><p>AspectJ æ˜¯ Spring AOP çš„åº•å±‚ä¾èµ–ä¹‹ä¸€ï¼Œç”¨äºæ”¯æŒä»£ç†å¯¹è±¡çš„æš´éœ²ã€‚åœ¨ <code>pom.xml</code> ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span> <span class="comment">&lt;!-- ç‰ˆæœ¬å¯æ ¹æ®Spring Bootç‰ˆæœ¬é€‚é… --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-å¯åŠ¨ç±»å¼€å¯ä»£ç†æš´éœ²"><a href="#2-å¯åŠ¨ç±»å¼€å¯ä»£ç†æš´éœ²" class="headerlink" title="2. å¯åŠ¨ç±»å¼€å¯ä»£ç†æš´éœ²"></a>2. å¯åŠ¨ç±»å¼€å¯ä»£ç†æš´éœ²</h4><p>åœ¨ Spring Boot å¯åŠ¨ç±»ä¸Šæ·»åŠ  <code>@EnableAspectJAutoProxy(exposeProxy = true)</code>ï¼Œä½œç”¨æ˜¯ï¼š</p>
<ul>
<li>å…è®¸ Spring å°†ä»£ç†å¯¹è±¡æš´éœ²åˆ° <code>ThreadLocal</code> ä¸­ï¼Œä½¿å¾—åœ¨ç›®æ ‡æ–¹æ³•å†…éƒ¨å¯é€šè¿‡ <code>AopContext.currentProxy()</code> è·å–ä»£ç†å®ä¾‹ã€‚</li>
<li>ç¡®ä¿ <code>@Transactional</code> æ³¨è§£çš„äº‹åŠ¡é€»è¾‘èƒ½é€šè¿‡ä»£ç†æ­£å¸¸ç”Ÿæ•ˆï¼ˆé¿å… <code>this.æ–¹æ³•()</code> è°ƒç”¨å¯¼è‡´çš„äº‹åŠ¡å¤±æ•ˆï¼‰ã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(exposeProxy = true)</span> <span class="comment">// æš´éœ²ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DianPingApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DianPingApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜"><a href="#é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜" class="headerlink" title="é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜"></a>é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</h2><h3 id="ä¸€ã€å•æœºç¯å¢ƒï¼šsynchronized-ä¸ºä»€ä¹ˆèƒ½å·¥ä½œï¼Ÿ"><a href="#ä¸€ã€å•æœºç¯å¢ƒï¼šsynchronized-ä¸ºä»€ä¹ˆèƒ½å·¥ä½œï¼Ÿ" class="headerlink" title="ä¸€ã€å•æœºç¯å¢ƒï¼šsynchronized ä¸ºä»€ä¹ˆèƒ½å·¥ä½œï¼Ÿ"></a>ä¸€ã€å•æœºç¯å¢ƒï¼š<code>synchronized</code> ä¸ºä»€ä¹ˆèƒ½å·¥ä½œï¼Ÿ</h3><p><code>synchronized</code> æ˜¯ JVM æä¾›çš„<strong>å†…ç½®äº’æ–¥é”</strong>ï¼Œå…¶ä½œç”¨èŒƒå›´æ˜¯<strong>å•ä¸ª JVM è¿›ç¨‹å†…éƒ¨</strong>ã€‚</p>
<ul>
<li>åŒä¸€ JVM å†…çš„å¤šä¸ªçº¿ç¨‹ï¼Œä¼šç«äº‰<strong>åŒä¸€ä¸ªé”å¯¹è±¡</strong>ï¼ˆæ¯”å¦‚æ–¹æ³•é”çš„ â€œç±»å¯¹è±¡â€ã€å¯¹è±¡é”çš„ â€œå®ä¾‹å¯¹è±¡â€ï¼‰ã€‚</li>
<li>åªæœ‰æ‹¿åˆ°é”çš„çº¿ç¨‹èƒ½è¿›å…¥ â€œä¸´ç•ŒåŒºâ€ï¼ˆå¦‚ â€œæŸ¥è¯¢è®¢å•â†’åˆ¤æ–­æ˜¯å¦å­˜åœ¨â†’æ’å…¥æ–°è®¢å•â€ çš„é€»è¾‘ï¼‰ï¼Œå…¶ä»–çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œä»è€Œä¿è¯<strong>å•æœºå†…çš„å¹¶å‘å®‰å…¨</strong>ï¼ˆæ¯”å¦‚ â€œä¸€äººä¸€å•â€ åœ¨å•æœºä¸‹ä¸ä¼šé‡å¤ä¸‹å•ï¼‰ã€‚</li>
</ul>
<h3 id="äºŒã€é›†ç¾¤ç¯å¢ƒï¼šsynchronized-ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ"><a href="#äºŒã€é›†ç¾¤ç¯å¢ƒï¼šsynchronized-ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ" class="headerlink" title="äºŒã€é›†ç¾¤ç¯å¢ƒï¼šsynchronized ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ"></a>äºŒã€é›†ç¾¤ç¯å¢ƒï¼š<code>synchronized</code> ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ</h3><p>é›†ç¾¤æ˜¯<strong>å¤šå°æœåŠ¡å™¨ &#x2F; å¤šä¸ª JVM è¿›ç¨‹</strong>åŒæ—¶æä¾›æœåŠ¡ï¼ˆæ¯”å¦‚éƒ¨ç½² 2 ä¸ª Tomcat å®ä¾‹ï¼Œå„è‡ªå¯¹åº”ç‹¬ç«‹çš„ JVMï¼‰ã€‚æ­¤æ—¶ <code>synchronized</code> çš„ â€œè¿›ç¨‹å†…é”â€ ç‰¹æ€§ï¼Œä¼šå¯¼è‡´é”æ— æ³•è·¨ JVM ç”Ÿæ•ˆï¼š</p>
<ul>
<li>æœåŠ¡å™¨ A çš„ Tomcatï¼ˆJVM 1ï¼‰é‡Œï¼Œçº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 ä¼šç«äº‰<strong>JVM 1 å†…çš„é”</strong>ï¼Œèƒ½ä¿è¯äº’æ–¥ã€‚</li>
<li>æœåŠ¡å™¨ B çš„ Tomcatï¼ˆJVM 2ï¼‰é‡Œï¼Œçº¿ç¨‹ 3 å’Œçº¿ç¨‹ 4 ä¼šç«äº‰<strong>JVM 2 å†…çš„é”</strong>ï¼Œä¹Ÿèƒ½ä¿è¯äº’æ–¥ã€‚</li>
<li>ä½† <strong>JVM 1 çš„é”å’Œ JVM 2 çš„é”æ˜¯ â€œå„è‡ªç‹¬ç«‹â€ çš„</strong>ï¼çº¿ç¨‹ 1ï¼ˆJVM 1ï¼‰å’Œçº¿ç¨‹ 3ï¼ˆJVM 2ï¼‰å¯ä»¥åŒæ—¶æ‹¿åˆ° â€œå„è‡ª JVM å†…çš„é”â€ï¼Œè¿›è€ŒåŒæ—¶è¿›å…¥ â€œæŸ¥è¯¢è®¢å•â†’æ’å…¥â€ çš„é€»è¾‘ â€”â€” è¿™å°±ä¼šç»•è¿‡ â€œä¸€äººä¸€å•â€ çš„é™åˆ¶ï¼Œå¯¼è‡´<strong>é‡å¤ä¸‹å•</strong>ã€‚</li>
</ul>
<h3 id="ä¸‰ã€å¦‚ä½•è§£å†³ï¼Ÿç”¨ã€Œåˆ†å¸ƒå¼é”ã€å®ç°è·¨-JVM-çš„å…¨å±€äº’æ–¥"><a href="#ä¸‰ã€å¦‚ä½•è§£å†³ï¼Ÿç”¨ã€Œåˆ†å¸ƒå¼é”ã€å®ç°è·¨-JVM-çš„å…¨å±€äº’æ–¥" class="headerlink" title="ä¸‰ã€å¦‚ä½•è§£å†³ï¼Ÿç”¨ã€Œåˆ†å¸ƒå¼é”ã€å®ç°è·¨ JVM çš„å…¨å±€äº’æ–¥"></a>ä¸‰ã€å¦‚ä½•è§£å†³ï¼Ÿç”¨ã€Œåˆ†å¸ƒå¼é”ã€å®ç°<strong>è·¨ JVM çš„å…¨å±€äº’æ–¥</strong></h3><p>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šè®©<strong>æ‰€æœ‰ JVM &#x2F; æœåŠ¡å®ä¾‹</strong>å…±äº«ä¸€ä¸ª â€œå…¨å±€é”èµ„æºâ€ï¼Œä»è€Œå®ç°è·¨è¿›ç¨‹çš„äº’æ–¥ã€‚</p>
<p>å¸¸ç”¨çš„åˆ†å¸ƒå¼é”å®ç°æ–¹æ¡ˆï¼ˆä»¥ Redis ä¸ºä¾‹ï¼‰ï¼š</p>
<ol>
<li><p><strong>åˆ©ç”¨ Redis åŸå­æ€§å‘½ä»¤ï¼ˆå¦‚ <code>SETNX</code>ï¼‰</strong>ï¼š</p>
<ul>
<li>å½“éœ€è¦åŠ é”æ—¶ï¼Œå‘ Redis å‘é€ <code>SETNX lock:user:123 &quot;éšæœºå€¼&quot;</code>ï¼ˆ<code>lock:user:123</code> æ˜¯é”çš„ keyï¼Œâ€œéšæœºå€¼â€ ç”¨äºåç»­é‡Šæ”¾é”æ—¶çš„å”¯ä¸€æ€§éªŒè¯ï¼‰ï¼Œå¹¶è®¾ç½®<strong>è¿‡æœŸæ—¶é—´</strong>ï¼ˆé¿å…æ­»é”ï¼‰ã€‚</li>
<li><code>SETNX</code> æ˜¯ â€œSet if Not Existsâ€ çš„ç¼©å†™ï¼šå¦‚æœ key ä¸å­˜åœ¨ï¼Œå°±è®¾ç½®æˆåŠŸï¼ˆè¿”å› 1ï¼‰ï¼Œè¡¨ç¤º â€œæ‹¿åˆ°é”â€ï¼›å¦‚æœ key å·²å­˜åœ¨ï¼Œè®¾ç½®å¤±è´¥ï¼ˆè¿”å› 0ï¼‰ï¼Œè¡¨ç¤º â€œé”è¢«å ç”¨â€ã€‚</li>
</ul>
</li>
<li><p><strong>æ‰§è¡Œä¸´ç•ŒåŒºé€»è¾‘</strong>ï¼š</p>
<p>åªæœ‰æ‹¿åˆ°é”çš„çº¿ç¨‹ï¼ˆæˆ–æœåŠ¡å®ä¾‹ï¼‰ï¼Œæ‰èƒ½æ‰§è¡Œ â€œæŸ¥è¯¢è®¢å•â†’åˆ¤æ–­â†’æ’å…¥â€ çš„é€»è¾‘ã€‚</p>
</li>
<li><p><strong>é‡Šæ”¾é”</strong>ï¼š</p>
<p>æ‰§è¡Œå®Œé€»è¾‘åï¼Œéœ€è¦<strong>åŸå­æ€§åœ°åˆ é™¤é”</strong>ï¼ˆé¿å…å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¯¯åˆ å…¶ä»–çº¿ç¨‹çš„é”ï¼‰ã€‚é€šå¸¸ç”¨ Lua è„šæœ¬å®ç°ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.call(<span class="string">&quot;get&quot;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">&quot;del&quot;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆéªŒè¯ â€œé”çš„å€¼æ˜¯å¦ä¸ºè‡ªå·±çš„éšæœºå€¼â€ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢ â€œé”è¿‡æœŸåè¢«å…¶ä»–çº¿ç¨‹è¯¯åˆ â€ çš„æƒ…å†µã€‚ï¼‰</p>
</li>
</ol>
<h3 id="å››ã€æ€»ç»“-1"><a href="#å››ã€æ€»ç»“-1" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h3><ul>
<li>å•æœºä¸‹ï¼Œ<code>synchronized</code> é  â€œJVM å†…å…±äº«é”å¯¹è±¡â€ ä¿è¯äº’æ–¥ã€‚</li>
<li>é›†ç¾¤ä¸‹ï¼Œå¤š JVM å„è‡ªçš„é”ä¸å…±äº«ï¼Œå¯¼è‡´ <code>synchronized</code> å¤±æ•ˆã€‚</li>
<li>åˆ†å¸ƒå¼é”é€šè¿‡ <strong>Redis ç­‰ä¸­é—´ä»¶æä¾› â€œå…¨å±€å…±äº«çš„é”èµ„æºâ€</strong>ï¼Œè®©æ‰€æœ‰æœåŠ¡å®ä¾‹ç«äº‰åŒä¸€æŠŠé”ï¼Œä»è€Œå®ç°è·¨è¿›ç¨‹çš„å¹¶å‘å®‰å…¨ï¼ˆå¦‚ â€œä¸€äººä¸€å•â€ çš„å…¨å±€æ§åˆ¶ï¼‰ã€‚</li>
</ul>
</div>

    
    <section class="post-copyright">
      
      <p class="copyright-item">
        <span>ä½œè€…:</span>
        <span>è€æ±Ÿæ¹–</span>
      </p>
        
      <p class="copyright-item">
        <span>è®¸å¯è¯:</span>
        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
      </p>
       
      <p class="copyright-item">
        <span>å£å·:</span>
        <span><strong>ä»£ç æ˜¯å¼€æºçš„,æˆ‘ä»¬åªæ˜¯å®ƒçš„æ¬è¿å·¥ã€‚</strong></span>
      </p>
       
        <p class="copyright-item">
        <span>å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œè¯·éšæ„è½¬è½½ï¼Œæ„Ÿè°¢æ”¯æŒï¼</span>
      </p>
      
             
        <p class="copyright-item">
        <span>å¦‚æœ‰ä¾µæƒè¯·å‘ŠçŸ¥åˆ é™¤ğŸ™</span>
      </p>
             
        <p class="copyright-item">
        <span>å¦‚æœä½ æœ‰å¾ˆå¥½çš„æƒ³æ³•ğŸ’¡ï¼Œè¯·åŠ¡å¿…è”ç³»æˆ‘ã€‚ </span>
        <br>
         <span>2292360909@qq.com</span>
      </p>
    </section>
    
    <section class="post-tags">
      <div>
        <span>æ ‡ç­¾:</span>
        <span class="tag">
          
        </span>
      </div>
      <div>
        <a href="javascript:window.history.back();">è¿”å›</a>
        <span>Â· </span>
        <a href="/">é¦–é¡µ</a>
      </div>
    </section>
    <section class="post-nav">
      
      <a class="prev" rel="prev" href="/2025/10/12/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/06-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"
        >06-åˆ†å¸ƒå¼é”</a
      >
       
      <a class="next" rel="next" href="/2025/10/12/%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84/07-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission/"
        >07-åˆ†å¸ƒå¼é”-redission</a
      >
      
    </section>

    <!-- Giscus è¯„è®ºåŒºæŒ‚è½½ç‚¹ -->
<div id="giscus-container" style="margin-top: 2.5rem;"></div>

<!-- Giscus åŠ¨æ€åŠ è½½è„šæœ¬ï¼šåˆå§‹åŠ è½½ + æ˜æš—ä¸»é¢˜åˆ‡æ¢ -->
<script>
  function createGiscus(theme) {
    const giscusContainer = document.getElementById('giscus-container');
    if (!giscusContainer) return;

    // æ¸…é™¤æ—§çš„è¯„è®º iframe
    giscusContainer.innerHTML = '';

    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';

    // æ›¿æ¢ä¸ºä½ çš„ GitHub ä»“åº“ä¿¡æ¯ï¼ˆæ ¼å¼ï¼šusername/repoï¼‰
    script.setAttribute('data-repo', 'meisijiya/meisijiya.github.io');

   // æ›¿æ¢ä¸ºä½ çš„ repo-id å’Œ category-idï¼ˆåœ¨ giscus.app é…ç½®é¡µé¢ç”Ÿæˆï¼‰
    script.setAttribute('data-repo-id', 'R_kgDOPwTrpQ');
    script.setAttribute('data-category', 'Announcements');
    script.setAttribute('data-category-id', 'DIC_kwDOPwTrpc4CviGR');

    // å…¶ä»–å¸¸è§„æ¨èè®¾ç½®
    script.setAttribute('data-mapping', 'pathname');           // ç”¨é¡µé¢è·¯å¾„åŒ¹é…è¯„è®ºå¸–
    script.setAttribute('data-strict', '0');                   // è‹¥æ— åŒ¹é…å¸–åˆ™åˆ›å»ºæ–°å¸–
    script.setAttribute('data-reactions-enabled', '1');        // å¯ç”¨è¡¨æƒ…ååº”
    script.setAttribute('data-emit-metadata', '0');            // ä¸è¾“å‡ºå…ƒæ•°æ®
    script.setAttribute('data-input-position', 'top');         // è¾“å…¥æ¡†åœ¨è¯„è®ºä¸Šæ–¹
    script.setAttribute('data-theme', theme);                
    script.setAttribute('data-lang', 'zh-CN');                 // ä¸­æ–‡ç•Œé¢
    script.setAttribute('crossorigin', 'anonymous');           // è·¨åŸŸèµ„æºå®‰å…¨
    script.async = true;                                       
     
    giscusContainer.appendChild(script);
  }

  function getCurrentTheme() {
    return document.body.classList.contains('dark-theme') ? 'dark' : 'light';
  }

  document.addEventListener('DOMContentLoaded', () => {
    // é¡µé¢é¦–æ¬¡åŠ è½½ï¼Œæ ¹æ®å½“å‰ä¸»é¢˜æŒ‚è½½è¯„è®º
    createGiscus(getCurrentTheme());

    // ç›‘å¬æŒ‰é’®ç‚¹å‡»åˆ‡æ¢ä¸»é¢˜ â†’ é‡è½½è¯„è®ºåŒº
    const buttons = [
      document.querySelector('.toggleBtn'),
      document.getElementById('mobile-toggle-theme')
    ];
    buttons.forEach(btn => {
      if (!btn) return;
      btn.addEventListener('click', () => {
        setTimeout(() => {
          createGiscus(getCurrentTheme());
        }, 400); // ç¨ä½œå»¶è¿Ÿï¼Œç¡®ä¿ class åˆ‡æ¢å®Œæ¯•
      });
    });

    // ç›‘å¬ body class æ”¹å˜ï¼ˆä¿é™©æ–¹æ¡ˆï¼‰
    const observer = new MutationObserver(() => {
      createGiscus(getCurrentTheme());
    });
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  });
</script>

  </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Â© è€æ±Ÿæ¹– | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>
<script src="/js/code-copy.js"></script>


    </div>
</body>
<!-- umami -->
<script defer src="https://cloud.umami.is/script.js" data-website-id="91b923f2-ff2d-43d0-ba5f-bc348d82426a"></script>
</html>